<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enquadramento de Carteira - HIGHPAR</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React and Babel for component-based UI -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PapaParse for CSV handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>

    <!-- SheetJS/XLSX for Excel file handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Firebase v9 Compatibility Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }

        /* Hides the print-only content from the screen */
        .printable-content {
            display: none;
        }

        /* Updated Print Styles */
        @media print {
            body, html {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                height: auto !important;
                overflow: visible !important;
                font-size: 10px; /* Base font size for print */
                margin: 0 !important;
                padding: 0 !important;
            }
            /* Hide screen-only elements */
            .no-print {
                display: none !important;
            }
            /* Hide the root div used for screen rendering */
            body > #root {
                display: none !important;
            }
            /* Show print-only content */
            .printable-content {
                display: block !important;
            }
            .presentation-slide {
                width: 100% !important;
                /* height: 100vh !important; Use page height instead */
                min-height: 98vh; /* Ensure it tries to fill the page, adjust if needed */
                page-break-after: always !important; /* Ensure each slide is on a new page */
                page-break-inside: avoid !important; /* Try to avoid breaking content within a slide */
                display: flex !important;
                flex-direction: column !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: relative !important; /* Changed from absolute */
                transform: none !important;
                border: 1px solid #e2e8f0 !important; /* slate-200 */
                background: #fff !important;
                color: #0f172a !important; /* slate-900 */
                overflow: hidden !important; /* Important: hide overflow for print */
                padding: 1.5rem !important; /* Reduced padding for more content space */
            }

            /* Ensure all text within slides is dark for print */
            .presentation-slide h1, .presentation-slide h2, .presentation-slide h3, .presentation-slide p,
            .presentation-slide span, .presentation-slide th, .presentation-slide td, .presentation-slide div,
            .presentation-slide li, .presentation-slide button, .presentation-slide label, .presentation-slide input,
            .presentation-slide select, .presentation-slide textarea {
                color: #0f172a !important;
                background-color: transparent !important; /* Ensure backgrounds are transparent */
            }
             /* Style specific background colors to light grey or white */
            .presentation-slide .bg-slate-800, .presentation-slide .bg-slate-700,
            .presentation-slide .bg-slate-900, .presentation-slide .bg-slate-700\/50,
            .presentation-slide .bg-slate-600, .presentation-slide .bg-slate-600\/50 {
                background-color: #f8fafc !important; /* slate-50 for backgrounds */
                border-color: #cbd5e1 !important; /* slate-300 */
            }
            /* Adjust border colors */
            .presentation-slide .border-slate-700, .presentation-slide .border-slate-600, .presentation-slide .border-slate-500 {
                border-color: #cbd5e1 !important; /* slate-300 */
            }
             /* Ensure text colors are readable */
            .presentation-slide .text-white, .presentation-slide .text-slate-200,
            .presentation-slide .text-slate-300, .presentation-slide .text-slate-400 {
                color: #1e293b !important; /* slate-800 */
            }
             /* Keep specific color hints, but ensure they are printable */
            .presentation-slide .text-sky-400, .presentation-slide .text-sky-500 { color: #0ea5e9 !important; }
            .presentation-slide .text-green-400 { color: #22c55e !important; }
            .presentation-slide .text-red-400 { color: #ef4444 !important; }
            .presentation-slide .text-yellow-400 { color: #f59e0b !important; }
            .presentation-slide .bg-sky-500 { background-color: #bae6fd !important; color: #0c4a6e !important; } /* Light blue bg, dark blue text */

            /* Prevent tables from breaking across pages */
            .presentation-slide table, .presentation-slide .css-bar-chart-container, .presentation-slide .svg-pie-chart-container {
                 page-break-inside: avoid !important;
            }

            /* Ensure charts render correctly */
            .presentation-slide svg circle {
                stroke-width: 30 !important; /* Adjust stroke for better visibility */
            }
            .presentation-slide .css-bar-chart-bar {
                 height: 1rem !important; /* Adjust bar height */
            }

            /* Adjust header/footer for print */
            .slide-header-print {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                border-bottom: 1px solid #cbd5e1 !important;
                padding-bottom: 0.5rem !important; /* Reduced padding */
                margin-bottom: 1rem !important;
                flex-shrink: 0 !important;
            }
             .slide-header-print h2 { font-size: 1.25rem !important; } /* Slightly smaller heading */

            .slide-footer-print {
                text-align: center !important;
                border-top: 1px solid #cbd5e1 !important;
                padding-top: 0.5rem !important; /* Reduced padding */
                margin-top: 1rem !important;
                font-size: 8px !important; /* Smaller font size */
                color: #475569 !important;
                flex-shrink: 0 !important;
            }

            /* Ensure content area uses available space */
            .slide-content-print {
                flex-grow: 1 !important;
                display: flex !important;
                flex-direction: column !important;
                /* justify-content: center; /* Remove centering to allow natural flow */
                overflow: hidden !important; /* Hide overflow within the content */
            }

             /* Adjust font sizes within content for print */
            .presentation-slide h1 { font-size: 2rem !important; }
            .presentation-slide h2 { font-size: 1.5rem !important; }
            .presentation-slide h3 { font-size: 1.1rem !important; }
            .presentation-slide p, .presentation-slide li, .presentation-slide span { font-size: 10px !important; }
            .presentation-slide th, .presentation-slide td { font-size: 9px !important; padding: 0.25rem 0.5rem !important; } /* Smaller table text and padding */
            .presentation-slide .text-xs { font-size: 8px !important; }
            .presentation-slide .text-sm { font-size: 9px !important; }
            .presentation-slide .text-base { font-size: 10px !important; }
            .presentation-slide .text-lg { font-size: 11px !important; }
            .presentation-slide .text-xl { font-size: 12px !important; }
        }

    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        // Your web app's Firebase configuration (Keep existing config)
        const firebaseConfig = {
          apiKey: "AIzaSyDeAjUfGfnj1aLrym1NaJ_wMp1nzhmdgPw",
          authDomain: "enquadramento-de-carteira.firebaseapp.com",
          projectId: "enquadramento-de-carteira",
          storageBucket: "enquadramento-de-carteira.firebasestorage.app",
          messagingSenderId: "547291070273",
          appId: "1:547291070273:web:d800bf84374a5d8aefabc0",
          measurementId: "G-Q5205EXRBD"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;

        const { useState, useEffect, useMemo, useCallback, Fragment, useRef } = React;

        // --- SVG ICON COMPONENTS --- (Keep existing icons)
        const Icon = ({ path, className = "h-6 w-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path fillRule="evenodd" clipRule="evenodd" d={path} />
            </svg>
        );
        const ICONS = {
            DASHBOARD: "M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z",
            SETTINGS: "M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61-.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61.25 1.17.59 1.69.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z",
            LOGOUT: "M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z",
            CHEVRON_DOWN: "M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z",
            CHEVRON_UP: "M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z",
            CHEVRON_LEFT: "M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z",
            CHEVRON_RIGHT: "M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z",
            PLUS: "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",
            CLOSE: "M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",
            UPLOAD: "M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z",
            DOWNLOAD: "M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z",
            EDIT: "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",
            TRASH: "M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z",
            CHART: "M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z",
            PDF: "M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm-2.5-2H15V8.5h-2.5v1.5zm-5-1.5H9v1.5h-.5V8.5z",
            CALENDAR: "M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 1.99 2H19c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z",
        };

        const Loader = ({className}) => <svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value) => {
            const num = parseFloat(value);
            if (isNaN(num)) return "R$ 0,00";
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
        };
        const formatPercent = (value) => {
             const num = parseFloat(value);
            if (isNaN(num)) return "0,00%";
            // Check for potential floating point inaccuracies before formatting
            if (Math.abs(num * 100 - Math.round(num * 100 * 100) / 100) < 0.0001) {
                 return `${(Math.round(num * 100 * 100) / 100).toFixed(2).replace('.',',')}%`;
            }
            return `${(num * 100).toFixed(2).replace('.',',')}%`;
        }

        // Improved date parsing logic
        const parseDate = (dateValue) => {
             if (!dateValue) return null;

             // Handle Firestore Timestamp
            if (dateValue && typeof dateValue.seconds === 'number') {
                return new Date(dateValue.seconds * 1000);
            }
            // Handle ISO-like string (YYYY-MM-DD or YYYY/MM/DD)
             if (typeof dateValue === 'string' && /^\d{4}[-/]\d{2}[-/]\d{2}/.test(dateValue)) {
                try {
                    // Attempt direct parsing, handling potential timezone issues by preferring UTC
                    const date = new Date(dateValue.replace(/-/g, '/') + 'T00:00:00Z');
                    if (!isNaN(date.getTime())) return date;
                } catch (e) { /* Ignore parsing errors, try next method */ }
            }
            // Handle DD/MM/YYYY string
            if (typeof dateValue === 'string' && /^\d{1,2}[-/]\d{1,2}[-/]\d{2,4}/.test(dateValue)) {
                 const parts = dateValue.split(/[-/]/);
                 if (parts.length === 3) {
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                    let year = parseInt(parts[2], 10);
                    if (year < 100) year += 2000; // Assume 21st century for 2-digit years
                    if (day > 0 && day <= 31 && month >= 0 && month < 12 && year > 1900) {
                         const date = new Date(Date.UTC(year, month, day));
                         if (!isNaN(date.getTime())) return date;
                    }
                 }
             }
             // Handle Excel Serial Number (numeric or string)
             if (typeof dateValue === 'number' || (typeof dateValue === 'string' && /^\d+$/.test(dateValue))) {
                 try {
                      const excelSerial = Number(dateValue);
                      // Excel date calculation (adjusting for the 1900 leap year bug)
                      const baseDate = new Date(Date.UTC(1899, 11, 30)); // Base date for Excel is Dec 30, 1899
                      const date = new Date(baseDate.getTime() + (excelSerial - (excelSerial > 59 ? 1 : 0)) * 24 * 60 * 60 * 1000);
                      if (!isNaN(date.getTime())) return date;
                 } catch (e) { /* Ignore conversion errors */ }
             }
            // Try generic JS date parsing as a last resort
             if (typeof dateValue === 'string') {
                 try {
                    const date = new Date(dateValue);
                    if (!isNaN(date.getTime())) return date;
                 } catch (e) { /* Ignore final parsing errors */ }
             }

             return null; // Return null if no valid format is found
        };

        const formatDisplayDate = (dateValue) => {
            const date = parseDate(dateValue);
            if (date) {
                // Format date only, without time and timezone for simplicity in the cover slide
                return new Intl.DateTimeFormat('pt-BR', { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'UTC' }).format(date);
            }
            // If parsing failed but we have an original value, show it
            if (dateValue) return dateValue.toString();
            return 'N/A';
        };

         const calculateDateDifferenceInDays = (date1, date2) => {
            if (!date1 || !date2) return Infinity;
            // Use UTC to avoid timezone issues affecting the day difference
            const utcDate1 = Date.UTC(date1.getUTCFullYear(), date1.getUTCMonth(), date1.getUTCDate());
            const utcDate2 = Date.UTC(date2.getUTCFullYear(), date2.getUTCMonth(), date2.getUTCDate());
            return Math.floor((utcDate1 - utcDate2) / (1000 * 60 * 60 * 24));
        };

        // NEW: Function to categorize liquidity based on days difference
        const getLiquidityBucket = (daysDiff) => {
            if (daysDiff === Infinity || daysDiff === null || isNaN(daysDiff)) return 'D+5'; // Default bucket
            if (daysDiff <= 0) return 'D+0';
            if (daysDiff <= 5) return 'D+5';
            if (daysDiff <= 30) return 'D+30';
            if (daysDiff <= 180) return 'D+180';
            if (daysDiff <= 365) return 'D+365';
            return '>D+365';
        };

        // NEW: Function to parse liquidity string (e.g., "D+30", "30", "")
        const parseLiquidityDays = (liquidityString) => {
            if (!liquidityString || typeof liquidityString !== 'string') return 5; // Default D+5

            const cleanedString = liquidityString.toUpperCase().replace(/\s+/g, '');

            if (cleanedString === 'D+0' || cleanedString === 'D0' || cleanedString === '0') return 0;

            const matchDPlus = cleanedString.match(/^D\+(\d+)/);
            if (matchDPlus && matchDPlus[1]) {
                 const days = parseInt(matchDPlus[1], 10);
                return isNaN(days) ? 5 : days;
            }

            const matchNumber = cleanedString.match(/^(\d+)/);
            if (matchNumber && matchNumber[1]) {
                 const days = parseInt(matchNumber[1], 10);
                 return isNaN(days) ? 5 : days;
            }

            // Add more specific cases if needed, e.g., 'IMEDIATA' -> 0
            if (cleanedString.includes('IMEDIAT')) return 0;


            return 5; // Default D+5 if no pattern matches
        };


        const normalizeString = (str) => {
            if (!str) return '';
            return str
                .toString()
                .trim()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        };

        const INSTITUICOES = ['XP', 'BTG', 'XP INTERNACIONAL', 'BTG INTERNACIONAL', 'AVENUE', 'BANCO DO BRASIL', 'SICOOB', 'BRADESCO', 'SANTANDER', 'SAFRA', 'NUBANK', 'INTER'];

        // --- MAIN APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState('dashboard');
            const [selectedClientId, setSelectedClientId] = useState(null);

             useEffect(() => {
                 let unsubscribeUserDoc = () => {};
                 const unsubscribeAuth = auth.onAuthStateChanged((currentUser) => {
                     unsubscribeUserDoc(); // Ensure previous listener is detached

                     if (currentUser) {
                         const userDocRef = db.collection("users").doc(currentUser.uid);
                         unsubscribeUserDoc = userDocRef.onSnapshot(async (doc) => {
                             if (doc.exists) {
                                 setUser(currentUser);
                                 setUserData({ uid: currentUser.uid, ...doc.data() });
                                 setLoading(false);
                             } else {
                                 // Attempt to create user profile if it doesn't exist
                                 try {
                                     // Determine role based on email (simple example)
                                     const role = currentUser.email.toLowerCase().includes('admin') ? 'admin' : 'consultant';
                                     const name = currentUser.displayName || currentUser.email.split('@')[0];
                                     await userDocRef.set({
                                         name: name,
                                         email: currentUser.email,
                                         role: role,
                                     });
                                     // No need to set state here, the onSnapshot will trigger again with the new data
                                 } catch (error) {
                                     console.error("Failed to auto-create user document:", error);
                                     // Set user but indicate profile data is missing/failed
                                     setUser(currentUser);
                                     setUserData(null); // Explicitly set to null on failure
                                     setLoading(false);
                                 }
                             }
                         }, (error) => {
                              console.error("Error fetching user data snapshot:", error);
                              setUser(currentUser); // Keep user authenticated
                              setUserData(null); // Indicate profile data failed to load
                              setLoading(false);
                         });
                     } else {
                         // User is signed out
                         setUser(null);
                         setUserData(null);
                         setLoading(false);
                     }
                 });

                 // Cleanup function
                 return () => {
                     unsubscribeAuth();
                     unsubscribeUserDoc(); // Detach Firestore listener on component unmount
                 };
             }, []); // Empty dependency array ensures this runs only once on mount


            const handleSignOut = () => {
                auth.signOut();
                setPage('dashboard');
                setSelectedClientId(null);
            };

            if (loading) {
                return <div className="h-screen w-full flex items-center justify-center"><Loader className="h-12 w-12 text-sky-400" /></div>;
            }

            if (!user) {
                return <LoginPage />;
            }

            // Specific check if user is authenticated but profile data failed or doesn't exist
            if (user && !userData) {
                 return (
                     <div className="h-screen w-full flex flex-col items-center justify-center text-center p-8 bg-slate-900 text-white">
                         <h1 className="text-2xl text-red-400 font-bold mb-4">Erro de Perfil</h1>
                         <p className="text-slate-400 mb-6 max-w-md">Não foi possível carregar ou criar os dados do seu perfil. Verifique as regras de segurança do Firebase ou se o perfil foi criado corretamente e tente novamente.</p>
                         <button
                             onClick={handleSignOut}
                             className="px-6 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors"
                         >
                             Sair
                         </button>
                     </div>
                 );
            }

            return (
                <div className="min-h-screen bg-slate-900 flex">
                    <Sidebar user={userData} setPage={setPage} handleSignOut={handleSignOut} currentPage={page} />
                    <main className="flex-1 p-8 overflow-y-auto">
                        {page === 'dashboard' && <Dashboard user={userData} setPage={setPage} setSelectedClientId={setSelectedClientId} />}
                        {page === 'client' && <ClientDetail clientId={selectedClientId} user={userData} setPage={setPage} />}
                        {page === 'settings' && userData?.role === 'admin' && <SettingsPage />}
                    </main>
                </div>
            );
        }

        // --- COMPONENTS ---
        // Sidebar
        function Sidebar({ user, setPage, handleSignOut, currentPage }) {
             const NavItem = ({ iconPath, text, pageName }) => (
                 <button
                     onClick={() => setPage(pageName)}
                     className={`flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors duration-200 group ${
                         currentPage === pageName ? 'bg-sky-500 text-white' : 'text-slate-300 hover:bg-slate-700 hover:text-white'
                     }`}
                 >
                     <Icon path={iconPath} className={`h-5 w-5 ${currentPage === pageName ? 'text-white' : 'text-slate-400 group-hover:text-white'}`} />
                     <span className="ml-3">{text}</span>
                 </button>
             );

             return (
                 <aside className="w-64 bg-slate-800 p-4 flex flex-col justify-between border-r border-slate-700 no-print">
                     <div>
                         <div className="flex items-center mb-8 px-2">
                             <Icon path={ICONS.CHART} className="h-8 w-8 text-sky-400" />
                             <h1 className="ml-2 text-xl font-bold text-white">HIGHPAR</h1>
                         </div>
                         <nav className="space-y-2">
                             <NavItem iconPath={ICONS.DASHBOARD} text="Dashboard" pageName="dashboard" />
                             {user?.role === 'admin' && <NavItem iconPath={ICONS.SETTINGS} text="Configurações" pageName="settings" />}
                         </nav>
                     </div>
                     <div className="border-t border-slate-700 pt-4">
                         <div className="px-4 py-3">
                             <p className="text-sm font-medium text-white truncate">{user?.name}</p>
                             <p className="text-xs text-slate-400 truncate">{user?.email}</p>
                         </div>
                          <button
                             onClick={handleSignOut}
                             className="flex items-center w-full px-4 py-3 text-sm font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors duration-200 group"
                         >
                             <Icon path={ICONS.LOGOUT} className="h-5 w-5 text-slate-400 group-hover:text-white" />
                             <span className="ml-3">Sair</span>
                         </button>
                     </div>
                 </aside>
             );
         }

        // LoginPage
        function LoginPage() {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (isLogin) {
                        await auth.signInWithEmailAndPassword(email, password);
                        // Login successful, App component will handle redirect via onAuthStateChanged
                    } else {
                        // Registration
                        if (!name.trim()) {
                           setError("Por favor, informe seu nome.");
                           setLoading(false);
                           return;
                        }
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        // Determine role (simple example)
                        const role = email.toLowerCase().includes('admin') ? 'admin' : 'consultant';
                        // Create user document in Firestore
                        await db.collection("users").doc(userCredential.user.uid).set({
                            name: name,
                            email: email,
                            role: role,
                        });
                        // Registration successful, App component will handle redirect
                    }
                } catch (err) {
                    console.error("Authentication error:", err);
                    if (err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                        setError("Credenciais inválidas. Verifique seu e-mail e senha.");
                    } else if (err.code === 'auth/email-already-in-use') {
                        setError("Este e-mail já está em uso. Tente fazer login.");
                    } else if (err.code === 'auth/weak-password') {
                         setError("A senha deve ter pelo menos 6 caracteres.");
                    } else {
                        setError("Ocorreu um erro. Tente novamente.");
                    }
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="flex justify-center items-center mb-6">
                            <Icon path={ICONS.CHART} className="h-10 w-10 text-sky-400" />
                            <h1 className="ml-3 text-3xl font-bold text-white">HIGHPAR</h1>
                        </div>
                        <div className="bg-slate-800 p-8 rounded-xl shadow-2xl">
                            <h2 className="text-2xl font-semibold text-center text-white mb-2">{isLogin ? 'Bem-vindo de volta!' : 'Crie sua conta'}</h2>
                            <p className="text-sm text-slate-400 text-center mb-6">{isLogin ? 'Faça login para continuar' : 'Preencha para se registrar'}</p>
                            <form onSubmit={handleAuth} className="space-y-4">
                                {!isLogin && (
                                    <input type="text" placeholder="Nome Completo" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                                )}
                                <input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                                <input type="password" placeholder="Senha" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required />

                                {error && <p className="text-red-400 text-xs text-center">{error}</p>}

                                <button type="submit" disabled={loading} className="w-full py-3 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors duration-200 disabled:bg-sky-800 disabled:cursor-not-allowed flex items-center justify-center">
                                    {loading && <Loader className="h-5 w-5 mr-2" />}
                                    {isLogin ? 'Entrar' : 'Registrar'}
                                </button>
                            </form>
                            <p className="text-center text-sm text-slate-400 mt-6">
                                {isLogin ? 'Não tem uma conta?' : 'Já tem uma conta?'}
                                <button onClick={() => { setIsLogin(!isLogin); setError(''); }} className="font-semibold text-sky-400 hover:text-sky-300 ml-1">
                                    {isLogin ? 'Registre-se' : 'Faça login'}
                                </button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // calculateFrameworkStatus
        const calculateFrameworkStatus = (portfolio, profile) => {
            if (!portfolio || portfolio.length === 0 || !profile || !profile.allocations) {
                return { status: 'Aguardando Ativos', deviation: 100 };
            }

            const totalValue = portfolio.reduce((sum, asset) => sum + asset.Valor, 0);
            if (totalValue === 0) return { status: 'Aguardando Ativos', deviation: 100 };

            // Calculate current allocation by normalized Class + Subclass
            const currentAllocationByClass = portfolio.reduce((acc, asset) => {
                const key = asset.Classe + (asset.Subclasse ? ` - ${asset.Subclasse}` : '');
                const normalizedKey = normalizeString(key);
                if (!acc[normalizedKey]) acc[normalizedKey] = 0;
                acc[normalizedKey] += asset.Valor;
                return acc;
            }, {});

             // Create recommended allocation map using normalized Class + Subclass
            const recommendedAllocationMap = profile.allocations.reduce((acc, alloc) => {
                if ((alloc.subcategories || []).length > 0) {
                    alloc.subcategories.forEach(sub => {
                        const key = alloc.Classe + (sub.name ? ` - ${sub.name}` : '');
                        const normalizedKey = normalizeString(key);
                        acc[normalizedKey] = sub.percentage / 100;
                    });
                } else {
                    const key = alloc.Classe;
                    const normalizedKey = normalizeString(key);
                    if(normalizedKey) acc[normalizedKey] = alloc.percentage / 100;
                }
                return acc;
            }, {});

             // Normalize current allocation percentages
            const currentAllocationMap = Object.entries(currentAllocationByClass).reduce((acc, [key, value]) => {
                acc[key] = value / totalValue; // Key is already normalized
                return acc;
            }, {});

            // Compare allocations
            const allKeys = [...new Set([...Object.keys(currentAllocationMap), ...Object.keys(recommendedAllocationMap)])];

            let totalDeviation = 0;
            allKeys.forEach(key => {
                const current = currentAllocationMap[key] || 0;
                const recommended = recommendedAllocationMap[key] || 0;
                totalDeviation += Math.abs(current - recommended);
            });

            // The total absolute deviation sums to 2 * (percentage points misallocated)
            const deviationPercentage = (totalDeviation / 2) * 100;

            if (deviationPercentage <= 5) return { status: 'Enquadrado', deviation: deviationPercentage };
            if (deviationPercentage <= 20) return { status: 'Atenção', deviation: deviationPercentage };
            return { status: 'Desenquadrado', deviation: deviationPercentage };
        };

        // StatusBadge
        const StatusBadge = ({ status, deviation }) => {
            const styleMap = {
                'Enquadrado': 'bg-green-500/20 text-green-400',
                'Atenção': 'bg-yellow-500/20 text-yellow-400',
                'Desenquadrado': 'bg-red-500/20 text-red-400',
                'Aguardando Ativos': 'bg-slate-600/50 text-slate-400'
            };
            return (
                <div className="flex flex-col items-start">
                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${styleMap[status] || styleMap['Aguardando Ativos']}`}>
                        {status}
                    </span>
                    {status !== 'Aguardando Ativos' && !isNaN(deviation) && ( // Check if deviation is a number
                        <span className="text-xs text-slate-400 mt-1">{deviation.toFixed(2)}% desalinhado</span>
                    )}
                </div>
            );
        };

        // Dashboard
        function Dashboard({ user, setPage, setSelectedClientId }) {
            const [clients, setClients] = useState([]);
            const [loading, setLoading] = useState(true);
            const [modalState, setModalState] = useState({ open: false, client: null });
            const [deletingClient, setDeletingClient] = useState(null);
             const [profilesData, setProfilesData] = useState([]); // Store profiles


             // Fetch profiles once
            useEffect(() => {
                 const fetchProfiles = async () => {
                     try {
                          const profilesSnapshot = await db.collection('profiles').get();
                          const profiles = profilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                          setProfilesData(profiles);
                     } catch (error) {
                          console.error("Error fetching profiles:", error);
                     }
                 };
                 fetchProfiles();
             }, []);

            useEffect(() => {
                if (!user || profilesData.length === 0) { // Wait for profiles too
                    // Still loading if user exists but profiles aren't ready
                    setLoading(!!user);
                    return () => {}; // Return an empty cleanup function
                }

                setLoading(true); // Set loading true when starting the query
                let clientQuery = db.collection('clients');
                if (user.role !== 'admin') {
                    clientQuery = clientQuery.where('consultantId', '==', user.uid);
                }

                 // Use onSnapshot for real-time updates
                const unsubscribeClients = clientQuery.onSnapshot(querySnapshot => {
                    const clientsData = querySnapshot.docs.map(doc => {
                         const client = { id: doc.id, ...doc.data() };
                         const clientProfile = profilesData.find(p => p.id === client.profileId);
                         // Make sure portfolioData exists and is an array
                         const portfolio = Array.isArray(client.portfolioData) ? client.portfolioData : [];
                         const { status, deviation } = calculateFrameworkStatus(portfolio, clientProfile);
                         return { ...client, portfolioData: portfolio, status, deviation }; // Ensure portfolioData is always an array
                    });
                    setClients(clientsData);
                    setLoading(false); // Stop loading after data is processed
                }, (error) => {
                    console.error("Error fetching clients snapshot:", error);
                    setLoading(false); // Stop loading on error
                });

                 // Cleanup function for onSnapshot
                return () => unsubscribeClients();

            }, [user, profilesData]); // Re-run effect if user or profilesData changes

            const viewClient = (clientId) => {
                setSelectedClientId(clientId);
                setPage('client');
            };

            const handleDelete = async () => {
                if(deletingClient) {
                    try {
                        await db.collection('clients').doc(deletingClient.id).delete();
                    } catch (error) {
                         console.error("Error deleting client:", error);
                         // Optionally show an error message to the user
                    } finally {
                        setDeletingClient(null); // Close modal regardless of success/failure
                    }
                }
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-white">Dashboard de Clientes</h1>
                        <button onClick={() => setModalState({ open: true, client: null })} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors">
                            <Icon path={ICONS.PLUS} className="h-5 w-5 mr-2" />
                            Novo Cliente
                        </button>
                    </div>
                    {loading ? <div className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></div> : (
                        <div className="bg-slate-800 rounded-xl shadow-lg">
                            <table className="w-full text-left">
                                <thead className="border-b border-slate-700">
                                    <tr>
                                        <th className="p-4 text-sm font-semibold text-slate-300">Nome do Cliente</th>
                                        <th className="p-4 text-sm font-semibold text-slate-300">Perfil de Investidor</th>
                                        {user?.role === 'admin' && <th className="p-4 text-sm font-semibold text-slate-300">Consultor</th>}
                                        <th className="p-4 text-sm font-semibold text-slate-300">Status</th>
                                        <th className="p-4 text-sm font-semibold text-slate-300 text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {clients.length > 0 ? clients.map(client => (
                                        <tr key={client.id} className="border-b border-slate-700 last:border-b-0 hover:bg-slate-700/50 transition-colors">
                                            <td className="p-4 font-medium text-white">{client.name}</td>
                                            <td className="p-4 text-slate-300">{client.profileName || 'Não definido'}</td>
                                            {user?.role === 'admin' && <td className="p-4 text-slate-300">{client.consultantName || 'Não atribuído'}</td>}
                                            <td className="p-4">
                                                <StatusBadge status={client.status} deviation={client.deviation} />
                                            </td>
                                            <td className="p-4 flex justify-end items-center space-x-4">
                                                <button onClick={() => viewClient(client.id)} className="text-sky-400 hover:text-sky-300 font-semibold">Visualizar</button>
                                                <button onClick={() => setModalState({ open: true, client: client })} className="text-slate-400 hover:text-white"><Icon path={ICONS.EDIT} className="h-5 w-5"/></button>
                                                <button onClick={() => setDeletingClient(client)} className="text-slate-400 hover:text-red-400"><Icon path={ICONS.TRASH} className="h-5 w-5"/></button>
                                            </td>
                                        </tr>
                                    )) : (
                                        <tr><td colSpan={user?.role === 'admin' ? 5 : 4} className="text-center p-8 text-slate-400">Nenhum cliente encontrado.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                    {modalState.open && user && <ClientModal user={user} clientToEdit={modalState.client} onClose={() => setModalState({ open: false, client: null })} />}
                    {deletingClient && (
                        <ConfirmModal
                            title="Excluir Cliente"
                            message={`Tem certeza que deseja excluir "${deletingClient.name}"? Esta ação não pode ser desfeita.`}
                            onConfirm={handleDelete}
                            onCancel={() => setDeletingClient(null)}
                        />
                    )}
                </div>
            );
        }

        // ClientModal
        function ClientModal({ user, clientToEdit, onClose }) {
            const [clientName, setClientName] = useState('');
            const [profileId, setProfileId] = useState('');
            const [consultantId, setConsultantId] = useState('');

            const [profiles, setProfiles] = useState([]);
            const [consultants, setConsultants] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(''); // Added error state

            // Set initial state based on edit or new, and user role
             useEffect(() => {
                 if(clientToEdit){
                     setClientName(clientToEdit.name || '');
                     setProfileId(clientToEdit.profileId || '');
                     // Only set consultantId if admin is editing, otherwise it uses the logged-in consultant's ID
                     if (user?.role === 'admin') {
                         setConsultantId(clientToEdit.consultantId || '');
                     } else {
                          setConsultantId(user.uid); // Default to current user if consultant
                     }
                 } else {
                     // For new client, default consultantId if user is a consultant
                     if (user?.role === 'consultant') {
                         setConsultantId(user.uid);
                     } else {
                          setConsultantId(''); // Admin needs to select
                     }
                     setClientName('');
                     setProfileId('');
                 }
             }, [clientToEdit, user]);

             // Fetch profiles and consultants (if admin)
            useEffect(() => {
                if (!user) return;
                const fetchInitialData = async () => {
                    setError(''); // Clear previous errors
                    try {
                        const profilesSnapshot = await db.collection('profiles').get();
                        setProfiles(profilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                        if (user.role === 'admin') {
                            const consultantsSnapshot = await db.collection('users')
                                .where('role', 'in', ['consultant', 'admin']) // Allow selecting admins too? Or just consultants? Assuming consultants for now.
                                .get();
                            setConsultants(consultantsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        } else {
                             // If consultant, set consultants to just themselves for display name lookup later
                             setConsultants([{ id: user.uid, name: user.name }]);
                        }
                    } catch (fetchError) {
                        console.error("Error fetching modal data:", fetchError);
                        setError("Erro ao carregar dados. Tente novamente.");
                    }
                };
                fetchInitialData();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); // Clear previous errors
                if (!clientName.trim()) {
                    setError("O nome do cliente é obrigatório.");
                    return;
                }
                 if (!profileId) {
                    setError("Selecione um perfil para o cliente.");
                    return;
                }
                if (!consultantId) {
                     setError("Selecione um consultor para o cliente.");
                     return;
                 }

                setLoading(true);

                const selectedProfile = profiles.find(p => p.id === profileId);
                let selectedConsultant;
                if(user.role === 'admin'){
                    selectedConsultant = consultants.find(c => c.id === consultantId);
                } else {
                    // Consultant is submitting, consultantId is already set to their own uid
                    selectedConsultant = {id: user.uid, name: user.name};
                }

                 // Ensure we found the consultant, especially if admin was selecting
                 if (!selectedConsultant) {
                    setError("Consultor selecionado inválido.");
                    setLoading(false);
                    return;
                 }


                const clientData = {
                    name: clientName.trim(), // Trim whitespace
                    profileId: profileId,
                    profileName: selectedProfile?.name || '', // Use profile name from fetched data
                    consultantId: selectedConsultant.id,
                    consultantName: selectedConsultant.name, // Use consultant name from fetched data
                };

                try {
                    if(clientToEdit) {
                        // Update existing client
                        await db.collection('clients').doc(clientToEdit.id).update(clientData);
                    } else {
                        // Add new client with createdAt timestamp
                        await db.collection('clients').add({...clientData, createdAt: serverTimestamp()});
                    }
                    onClose(); // Close modal on success
                } catch (saveError) {
                    console.error("Error saving client:", saveError);
                    setError("Erro ao salvar cliente. Tente novamente.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl shadow-2xl p-8 w-full max-w-lg">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">{clientToEdit ? 'Editar Cliente' : 'Adicionar Novo Cliente'}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon path={ICONS.CLOSE} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                               <input type="text" placeholder="Nome do Cliente" value={clientName} onChange={e => setClientName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                            <select value={profileId} onChange={e => setProfileId(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                <option value="">Selecione um Perfil</option>
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            {/* Consultant selection only for admin */}
                            {user?.role === 'admin' && (
                                <select value={consultantId} onChange={e => setConsultantId(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                    <option value="">Atribuir a um Consultor</option>
                                    {consultants.map(c => <option key={c.id} value={c.id}>{c.name} ({c.email})</option>)}
                                </select>
                            )}
                            {/* Display consultant name if user is consultant (non-editable) */}
                             {user?.role === 'consultant' && (
                                 <div className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-slate-400">
                                      Consultor: {user.name}
                                 </div>
                            )}

                             {error && <p className="text-red-400 text-xs text-center">{error}</p>} {/* Display errors */}

                            <div className="flex justify-end pt-4 space-x-3">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">Cancelar</button>
                                <button type="submit" disabled={loading} className="px-4 py-2 bg-sky-600 rounded-lg hover:bg-sky-700 disabled:bg-sky-800 flex items-center">
                                    {loading && <Loader className="h-5 w-5 mr-2" />}
                                    Salvar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        // --- ClientDetail Component ---
        function ClientDetail({ clientId, user, setPage }) {
            const [client, setClient] = useState(null);
            const [profile, setProfile] = useState(null);
            const [recommendedAssets, setRecommendedAssets] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('consolidada');
            const [portfolio, setPortfolio] = useState([]); // Ensure it's always an array
            const [presentationMode, setPresentationMode] = useState(false);
            const [observations, setObservations] = useState('');

            const [redemptions, setRedemptions] = useState({});
            const [applications, setApplications] = useState({});
            const [quotations, setQuotations] = useState({}); // Keep quotations state

            useEffect(() => {
                if(!clientId) {
                     setLoading(false); // Stop loading if no clientId
                     return;
                 }

                 setLoading(true); // Start loading

                 // Fetch recommended assets (runs once or when clientId changes, though not dependent)
                const fetchRecommendedAssets = async () => {
                    try {
                         const snapshot = await db.collection("recommendedAssets").get();
                         const assetsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         setRecommendedAssets(assetsData);
                    } catch (error) {
                         console.error("Error fetching recommended assets:", error);
                    }
                };
                fetchRecommendedAssets();

                 // Subscribe to client document
                const unsubscribe = db.collection("clients").doc(clientId).onSnapshot(async (doc) => {
                    if (doc.exists) {
                        const clientData = { id: doc.id, ...doc.data() };
                        setClient(clientData);
                        // Ensure portfolioData is treated as an array, default to empty if not present or not array
                        setPortfolio(Array.isArray(clientData.portfolioData) ? clientData.portfolioData : []);
                        setObservations(clientData.observations || '');

                         // Fetch associated profile
                        if (clientData.profileId) {
                            try {
                                 const profileDoc = await db.collection("profiles").doc(clientData.profileId).get();
                                if (profileDoc.exists) {
                                    setProfile({id: profileDoc.id, ...profileDoc.data()});
                                } else {
                                     console.warn(`Profile with ID ${clientData.profileId} not found.`);
                                     setProfile(null); // Profile referenced but not found
                                }
                            } catch (error) {
                                 console.error("Error fetching profile:", error);
                                 setProfile(null); // Error fetching profile
                            }
                        } else {
                             setProfile(null); // No profileId associated
                        }
                    } else {
                         console.error(`Client with ID ${clientId} not found.`);
                         setClient(null); // Client not found
                         setPortfolio([]);
                         setProfile(null);
                    }
                    setLoading(false); // Stop loading after processing
                }, (error) => {
                     console.error("Error subscribing to client document:", error);
                     setClient(null);
                     setPortfolio([]);
                     setProfile(null);
                     setLoading(false); // Stop loading on error
                });

                 // Cleanup subscription on component unmount or clientId change
                return () => unsubscribe();
            }, [clientId]);


            const portfolioAnalysis = useMemo(() => {
                if (!portfolio || portfolio.length === 0) return null;

                const totalValue = portfolio.reduce((sum, asset) => sum + (asset.Valor || 0), 0);
                if (totalValue === 0) return null; // Avoid division by zero

                const institutions = [...new Set(portfolio.map(p => {
                    return p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '');
                }))];

                // --- Allocation by Class (Detailed: Class - Subclass) ---
                const currentAllocationByClass = portfolio.reduce((acc, asset) => {
                    const key = asset.Classe + (asset.Subclasse ? ` - ${asset.Subclasse}` : '');
                    if (!acc[key]) {
                        acc[key] = { value: 0, percentage: 0 };
                    }
                    acc[key].value += (asset.Valor || 0);
                    return acc;
                }, {});
                Object.keys(currentAllocationByClass).forEach(key => {
                    currentAllocationByClass[key].percentage = currentAllocationByClass[key].value / totalValue;
                });

                 // --- Allocation by Master Class (Class only) for Charts ---
                 const currentAllocationByMasterClass = portfolio.reduce((acc, asset) => {
                     const key = (asset.Classe || '').split(' - ')[0].trim();
                     if (!key) return acc;
                     if (!acc[key]) acc[key] = { value: 0 };
                     acc[key].value += (asset.Valor || 0);
                     return acc;
                 }, {});
                 const currentChartData = Object.entries(currentAllocationByMasterClass)
                                            .map(([name, data]) => ({ name, value: data.value }))
                                            .filter(d => d.value > 0); // Filter zero values for chart


                // --- Recommended Allocation by Master Class (for Chart) ---
                let recommendedChartData = [];
                if (profile && profile.allocations) {
                    const recommendedByMasterClass = profile.allocations.reduce((acc, alloc) => {
                         const key = (alloc.Classe || '').split(' - ')[0].trim();
                         if (!key) return acc;
                         const value = (alloc.percentage / 100) * totalValue;
                         if(!acc[key]) {
                             acc[key] = { name: key, value: 0};
                         }
                         acc[key].value += value;
                         return acc;
                     }, {});
                     recommendedChartData = Object.values(recommendedByMasterClass).filter(d => d.value > 0);
                }


                // --- Issuer Concentration ---
                const issuerConcentration = portfolio.reduce((acc, asset) => {
                    const key = asset.Emissor || 'Não Especificado';
                    if(!acc[key]) acc[key] = 0;
                    acc[key] += (asset.Valor || 0);
                    return acc;
                }, {});
                const issuerChartData = Object.entries(issuerConcentration)
                                           .map(([name, value]) => ({ name, value }))
                                           .filter(item => item.value >= 0.01) // Filter negligible before sort
                                           .sort((a, b) => b.value - a.value);

                // --- Allocation by Asset Type ---
                const allocationByAssetType = portfolio.reduce((acc, asset) => {
                    const key = asset['Tipo de Ativo'] || 'Não Especificado';
                    if (!acc[key]) acc[key] = { value: 0, assets: [] };
                    acc[key].value += (asset.Valor || 0);
                    acc[key].assets.push(asset);
                    return acc;
                }, {});
                Object.keys(allocationByAssetType).forEach(key => {
                    allocationByAssetType[key].percentage = allocationByAssetType[key].value / totalValue;
                });

                // --- Allocation by Institution ---
                const institutionalData = portfolio.reduce((acc, asset) => {
                    const account = asset.Instituição + (asset["Número da Conta"] ? ` - ${asset["Número da Conta"]}` : '');
                    if (!acc[account]) acc[account] = 0;
                    acc[account] += (asset.Valor || 0);
                    return acc;
                }, {});
                const institutionalChartData = Object.entries(institutionalData)
                                                .map(([name, value]) => ({ name, value }))
                                                .filter(d => d.value > 0);


                 // --- Liquidity Calculation ---
                 const today = new Date();
                 const liquidityBuckets = { 'D+0': 0, 'D+5': 0, 'D+30': 0, 'D+180': 0, 'D+365': 0, '>D+365': 0 };
                 portfolio.forEach(asset => {
                     const vencimentoDate = parseDate(asset.Vencimento);
                     let bucket = 'D+5'; // Default
                     if (vencimentoDate) {
                         const daysDiff = calculateDateDifferenceInDays(vencimentoDate, today);
                         bucket = getLiquidityBucket(daysDiff);
                     }
                     liquidityBuckets[bucket] += (asset.Valor || 0);
                 });
                 const liquidityAnalysis = Object.entries(liquidityBuckets).map(([name, value]) => ({
                     name,
                     value,
                     percentage: totalValue > 0 ? value / totalValue : 0
                 })).filter(b => b.value > 0); // Only show buckets with value


                return {
                    totalValue,
                    institutions,
                    currentAllocationByClass, // Detailed map
                    currentChartData, // Aggregated for chart
                    recommendedChartData, // Aggregated for chart
                    portfolio,
                    issuerConcentration, // Raw map for IssuerView
                    issuerChartData, // Formatted array for chart
                    allocationByAssetType, // For Consolidated View (by type)
                    institutionalChartData, // Formatted array for chart
                    liquidityAnalysis
                };
            }, [portfolio, profile]); // Add profile as dependency


            // --- Moved from RebalanceWorkspace ---
            const totalAppliedPerClass = useMemo(() => {
                return Object.values(applications).flat().reduce((acc, app) => {
                    // Use the Classe property stored during application creation
                    const classKey = app.Classe || 'Desconhecida'; // Handle potential missing Classe
                    if (!acc[classKey]) acc[classKey] = 0;
                    acc[classKey] += app.value;
                    return acc;
                }, {});
            }, [applications]);

            const handleSaveObservations = async () => {
                if (!client) return;
                try {
                    await db.collection("clients").doc(client.id).update({
                        observations: observations
                    });
                    // Simple feedback, can be improved with a toast notification
                    // Using console.log instead of alert
                    console.log("Observações salvas com sucesso!");
                } catch (error) {
                    console.error("Error saving observations:", error);
                    // Using console.error instead of alert
                    console.error("Erro ao salvar as observações.");
                }
            };

            if (loading) return <div className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></div>;
            if (!client) return (
                 <div className="text-center p-8 text-slate-400">
                     Cliente não encontrado ou acesso não permitido.
                     <button onClick={() => setPage('dashboard')} className="block mx-auto mt-4 text-sky-400 hover:text-sky-300 font-semibold">
                         Voltar para Dashboard
                     </button>
                 </div>
            );


            // Separate Presentation component rendering logic
            if (presentationMode) {
                 // Important: Pass portfolioAnalysis which now includes liquidityAnalysis and chart data
                 const presentationComponent = (
                     <PresentationView
                         client={client}
                         profile={profile}
                         user={user}
                         analysis={portfolioAnalysis} // Pass the calculated analysis object
                         redemptions={redemptions}
                         applications={applications}
                         quotations={quotations}
                         observations={observations}
                         onClose={() => setPresentationMode(false)}
                     />
                 );
                 return presentationComponent;
            }

            return (
                <div className="space-y-6">
                     <button onClick={() => setPage('dashboard')} className="flex items-center text-sky-400 hover:text-sky-300 mb-4 text-sm font-semibold no-print">
                         <Icon path={ICONS.CHEVRON_LEFT} className="h-5 w-5"/>
                         Voltar para Dashboard
                     </button>
                    <div className="flex justify-between items-start no-print">
                        <div>
                            <h1 className="text-3xl font-bold text-white">{client.name}</h1>
                            <p className="text-slate-400">Perfil: <span className="font-semibold text-slate-300">{client.profileName || 'Não definido'}</span></p>
                        </div>
                       <PortfolioUploader client={client} />
                    </div>

                    <div className="flex justify-between items-center border-b border-slate-700 no-print">
                        <nav className="flex space-x-1 sm:space-x-6">
                            <TabButton name="Consolidada" id="consolidada" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <TabButton name="Liquidez" id="liquidez" activeTab={activeTab} setActiveTab={setActiveTab} disabled={!portfolioAnalysis}/>
                            <TabButton name="Comparativo" id="comparativo" activeTab={activeTab} setActiveTab={setActiveTab} disabled={!portfolioAnalysis || !profile}/>
                            <TabButton name="Emissores" id="emissores" activeTab={activeTab} setActiveTab={setActiveTab} disabled={!portfolioAnalysis} />
                            <TabButton name="Rebalanceamento" id="rebalanceamento" activeTab={activeTab} setActiveTab={setActiveTab} disabled={!portfolioAnalysis || !profile} />
                            <TabButton name="Cotação" id="cotacao" activeTab={activeTab} setActiveTab={setActiveTab} disabled={Object.keys(redemptions).length === 0} />
                        </nav>
                        <button onClick={() => setPresentationMode(true)} disabled={!portfolioAnalysis} className="flex items-center bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors disabled:bg-teal-800 disabled:cursor-not-allowed">
                           <Icon path={ICONS.CHART} className="h-5 w-5 mr-2" />
                            Apresentação
                        </button>
                    </div>

                    <div>
                        <div style={{ display: activeTab === 'consolidada' ? 'block' : 'none' }}><ConsolidatedView analysis={portfolioAnalysis} /></div>
                        <div style={{ display: activeTab === 'liquidez' ? 'block' : 'none' }}>
                            <LiquidityAnalysis analysis={portfolioAnalysis} />
                        </div>
                        <div style={{ display: activeTab === 'comparativo' ? 'block' : 'none' }}><ComparisonView analysis={portfolioAnalysis} profile={profile} /></div>
                        <div style={{ display: activeTab === 'emissores' ? 'block' : 'none' }}><IssuerView analysis={portfolioAnalysis} /></div>
                        <div style={{ display: activeTab === 'rebalanceamento' ? 'block' : 'none' }}>
                            <RebalanceWorkspace
                                analysis={portfolioAnalysis}
                                profile={profile}
                                redemptions={redemptions}
                                setRedemptions={setRedemptions}
                                applications={applications}
                                setApplications={setApplications}
                                recommendedAssets={recommendedAssets}
                                totalAppliedPerClass={totalAppliedPerClass}
                                observations={observations}
                                setObservations={setObservations}
                                onSaveObservations={handleSaveObservations}
                            />
                        </div>
                         <div style={{ display: activeTab === 'cotacao' ? 'block' : 'none' }}>
                              <QuotationView
                                  redemptions={redemptions}
                                  quotations={quotations}
                                  setQuotations={setQuotations}
                              />
                         </div>
                    </div>
                </div>
            )
        }

        // TabButton
         const TabButton = ({ name, id, activeTab, setActiveTab, disabled = false }) => (
             <button
                 onClick={() => !disabled && setActiveTab(id)}
                 disabled={disabled}
                 className={`py-3 px-1 text-sm font-semibold border-b-2 transition-colors duration-200 ${
                     activeTab === id
                          ? 'border-sky-500 text-sky-400'
                          : 'border-transparent text-slate-400'
                 } ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:text-white'}`}
             >
                 {name}
             </button>
         );

        // PortfolioUploader
         function PortfolioUploader({ client }) {
             const [uploading, setUploading] = useState(false);
             const [error, setError] = useState(null);
             const fileInputRef = React.useRef(null);

             const handleDownloadModelo = () => {
                 // ... (download logic remains the same) ...
                const wb = XLSX.utils.book_new();

                // Define lists for dropdowns
                const classes = ['Renda Fixa Pós', 'Renda Fixa Pré', 'Renda Fixa IPCA', 'Renda Variável', 'Multimercado', 'Fundos Listados', 'Exterior', 'Alternativo', 'Ações BR'];
                const subclasses = {
                    'Renda_Fixa_Pós': ['Soberano', 'Crédito Privado', 'Bancário'],
                    'Renda_Fixa_Pré': ['Bancário'],
                    'Renda_Fixa_IPCA': ['Inflação'],
                    'Renda_Variável': ['Long Only', 'Long Biased'],
                    'Multimercado': ['Macro', 'Long & Short'],
                    'Fundos_Listados': ['FII', 'FI Infra', 'FI Agro'],
                    'Exterior': ['Renda Variável', 'Renda Fixa'],
                    'Alternativo': ['FIDC'],
                    'Ações_BR': ['Long Biased', 'Long Only']
                };
                const assetTypes = ['Fundo de Investimento', 'CDB', 'LCI', 'LCA', 'Ações', 'FII', 'ETF', 'BDR', 'Previdência', 'CRI', 'CRA', 'Debênture', 'COE', 'Tesouro Direto'];

                // --- LISTAS Sheet ---
                let ws_listas_data = [
                    ["Instituição", "Classes", null] // Headers
                ];
                // Add class names and their respective subclasses horizontally
                const maxSubclasses = Math.max(...Object.values(subclasses).map(arr => arr.length));
                const classHeaders = Object.keys(subclasses);
                ws_listas_data[0].push(...classHeaders); // Add Class names as headers for subclasses

                // Populate rows for Institutions and Classes
                const maxRows = Math.max(INSTITUICOES.length, classes.length);
                for (let i = 0; i < maxRows; i++) {
                    let row = [];
                    row[0] = INSTITUICOES[i] || null; // Institution
                    row[1] = classes[i] || null; // Class
                    row[2] = null; // Spacer
                    // Add subclasses horizontally under the correct class header
                    classHeaders.forEach((header, classIndex) => {
                        const subList = subclasses[header];
                        row[3 + classIndex] = subList && subList[i] ? subList[i] : null;
                    });
                    ws_listas_data.push(row);
                }

                // Ensure all rows have the same length as the header row
                const headerLength = ws_listas_data[0].length;
                ws_listas_data = ws_listas_data.map(row => {
                    while(row.length < headerLength) row.push(null);
                    return row;
                });


                const ws_listas = XLSX.utils.aoa_to_sheet(ws_listas_data);
                // Adjust column widths (example widths, adjust as needed)
                ws_listas['!cols'] = [{wch:20}, {wch:20}, {wch:2}].concat(classHeaders.map(() => ({wch: 18})));
                XLSX.utils.book_append_sheet(wb, ws_listas, "LISTAS");


                // --- LISTA_TIPOS Sheet ---
                const ws_tipos_data = [["Tipos de Ativos"], ...assetTypes.sort().map(t => [t])];
                const ws_tipos = XLSX.utils.aoa_to_sheet(ws_tipos_data);
                ws_tipos['!cols'] = [{ wch: 25 }];
                XLSX.utils.book_append_sheet(wb, ws_tipos, "LISTA_TIPOS");

                // Hide helper sheets
                if(!wb.Workbook) wb.Workbook = {};
                if(!wb.Workbook.Sheets) wb.Workbook.Sheets = [];
                wb.Workbook.Sheets.push({ Name: 'LISTAS', Hidden: 1 });
                wb.Workbook.Sheets.push({ Name: 'LISTA_TIPOS', Hidden: 1 });


                // --- DADOS Sheet ---
                const ws_dados = XLSX.utils.aoa_to_sheet([
                    ["COLE AS INFORMAÇÕES ABAIXO", null, null, null, null, null, null, null, null, null, null, null ],
                    [], // Empty row for spacing
                    [null, "Instituição", "Número da Conta", "Nome", "Emissor", "Vencimento", "Taxa", "Liquidez", "Valor", "Classe", "Subclasse", "Tipo de Ativo"]
                ]);

                // Apply Header Style
                const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "0284C7" } }, alignment: { horizontal: "center" } };
                ['B3', 'C3', 'D3', 'E3', 'F3', 'G3', 'H3', 'I3', 'J3', 'K3', 'L3'].forEach(c => {
                    if(ws_dados[c]) ws_dados[c].s = headerStyle;
                });
                ws_dados['A1'].s = { font: { bold: true, sz: 14, color: { rgb: "FF0000" } } }; // Style instruction

                // Define data validation and formatting for data rows (e.g., rows 4 to 103)
                const numRowsToFormat = 100;
                for (let i = 4; i <= 3 + numRowsToFormat; i++) {
                    // Institutions Dropdown
                    ws_dados[`B${i}`] = { t:'s', v:'', dv: { type: "list", /*allowBlank: 1,*/ showErrorMessage: 1, sqref: `B${i}`, formula1: 'LISTAS!$A$2:$A$'+(1+INSTITUICOES.length) } };
                    // Account Number (Text)
                    ws_dados[`C${i}`] = { t:'s', z: '@' };
                    // Name (Text)
                    ws_dados[`D${i}`] = { t:'s' };
                     // Issuer (Text)
                    ws_dados[`E${i}`] = { t:'s' };
                    // Vencimento (Date format)
                    ws_dados[`F${i}`] = { t:'n', z: 'dd/mm/yyyy' };
                    // Taxa (Text)
                    ws_dados[`G${i}`] = { t:'s', z: '@'};
                    // Liquidez (Text, e.g., D+0, D+30)
                    ws_dados[`H${i}`] = { t:'s', z: '@'};
                     // Valor (Number format BRL)
                    ws_dados[`I${i}`] = { t:'n', z: '"R$" #,##0.00' };
                    // Classe Dropdown
                    ws_dados[`J${i}`] = { t:'s', v:'', dv: { type: "list", /*allowBlank: 1,*/ showErrorMessage: 1, sqref: `J${i}`, formula1: 'LISTAS!$B$2:$B$'+(1+classes.length) } };
                    // Subclasse Dropdown (Dependent) - Uses INDIRECT based on Classe
                    ws_dados[`K${i}`] = { t:'s', v:'', dv: { type: "list", /*allowBlank: 1,*/ showErrorMessage: 1, sqref: `K${i}`, formula1: `=INDIRECT(SUBSTITUTE(SUBSTITUTE(J${i}," ","_"),"/","_"))` } }; // Replace space and / for named range
                    // Tipo de Ativo Dropdown
                    ws_dados[`L${i}`] = { t:'s', v:'', dv: { type: "list", /*allowBlank: 1,*/ showErrorMessage: 1, sqref: `L${i}`, formula1: 'LISTA_TIPOS!$A$2:$A$'+(1+assetTypes.length) } };
                }

                 // --- Define Named Ranges for Dependent Dropdowns ---
                if(!wb.Workbook.Names) wb.Workbook.Names = [];
                Object.keys(subclasses).forEach((className, index) => {
                    const rangeName = className.replace(/ /g, '_').replace(/\//g,'_'); // Replace space and /
                    const startColLetter = XLSX.utils.encode_col(3 + index); // Starts from column D (index 3)
                    const endRow = 1 + subclasses[className].length;
                    const formula = `'LISTAS'!$${startColLetter}$2:$${startColLetter}$${endRow}`;
                    wb.Workbook.Names.push({ Name: rangeName, Ref: formula });
                });

                // Adjust column widths for DADOS sheet
                ws_dados['!cols'] = [ {wch: 2}, {wch: 20}, {wch: 15}, {wch: 35}, {wch: 20}, {wch: 12}, {wch: 15}, {wch: 10}, {wch: 18}, {wch: 18}, {wch: 18}, {wch: 25}];
                XLSX.utils.book_append_sheet(wb, ws_dados, "DADOS");

                // Write the file
                XLSX.writeFile(wb, "Planilha_Modelo_Highpar.xlsx");
             };

             const processAndUpload = (jsonData, originalFile) => {
                 // ... (processAndUpload logic remains the same) ...
                 setUploading(true);
                 setError(null);
                  try {
                       const cleanData = jsonData.map(row => {
                           // --- Value Parsing ---
                           const rawValue = row.Valor || row.valor || '0';
                           let numericValue;
                           if (typeof rawValue === 'number') {
                               numericValue = rawValue;
                           } else {
                               // Handle strings like "1.234,56" or "1234.56"
                               numericValue = parseFloat(String(rawValue).replace(/\./g, '').replace(',', '.')) || 0;
                           }

                           // --- Date Parsing (using the improved parseDate) ---
                           const vencimentoDate = parseDate(row.Vencimento);
                           // Store as YYYY-MM-DD string for consistency in Firestore, or null
                           const vencimentoValue = vencimentoDate
                                ? `${vencimentoDate.getUTCFullYear()}-${String(vencimentoDate.getUTCMonth() + 1).padStart(2, '0')}-${String(vencimentoDate.getUTCDate()).padStart(2, '0')}`
                                : null; // Store null if date is invalid/missing

                           // --- Other fields ---
                           const instit = String(row.Instituição || '').trim();
                           const nome = String(row.Nome || '').trim();
                           const classe = String(row.Classe || '').trim();


                           return {
                               "Instituição": instit,
                               "Número da Conta": String(row["Número da Conta"] || '').trim(),
                               "Nome": nome,
                               "Emissor": String(row.Emissor || '').trim(),
                               "Vencimento": vencimentoValue, // Store parsed date string or null
                               "Taxa": String(row.Taxa || '').trim(),
                               "Liquidez": String(row.Liquidez || '').trim(), // Keep original liquidity string
                               "Valor": numericValue,
                               "Classe": classe,
                               "Subclasse": String(row.Subclasse || '').trim(),
                               "Tipo de Ativo": String(row["Tipo de Ativo"] || '').trim(),
                           }
                       // Filter out rows without essential info OR with zero value AFTER parsing
                       }).filter(row => row.Instituição && row.Nome && row.Classe && row.Valor > 0);


                       if (cleanData.length === 0) {
                           setError("Nenhum dado válido encontrado na planilha após limpeza. Verifique Instituição, Nome, Classe e Valor.");
                           setUploading(false);
                           return;
                       }

                       // Proceed with upload...
                       const storageRef = storage.ref(`portfolios/${client.id}/${originalFile.name}`);
                       const uploadTask = storageRef.put(originalFile);

                       uploadTask.on('state_changed',
                           (snapshot) => { /* Optional: Handle progress */ },
                           (error) => {
                                console.error("Erro no upload para o Storage:", error);
                                setError("Falha ao enviar o arquivo para o armazenamento.");
                                setUploading(false);
                           },
                           () => {
                               // Upload successful, get URL and update Firestore
                               uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                   db.collection("clients").doc(client.id).update({
                                       portfolioData: cleanData, // Save the cleaned data
                                       lastPortfolioFileUrl: downloadURL,
                                       lastUpdate: serverTimestamp()
                                   }).then(() => {
                                       setUploading(false);
                                       setError(null); // Clear error on success
                                       console.log("Portfolio updated successfully!");
                                   }).catch((dbError) => {
                                        console.error("Erro ao atualizar o Firestore:", dbError);
                                        setError("Falha ao salvar os dados processados no banco de dados.");
                                        setUploading(false);
                                   });
                               }).catch((urlError) => {
                                    console.error("Erro ao obter a URL de download:", urlError);
                                    setError("Ocorreu um erro ao finalizar o upload (obter URL).");
                                    setUploading(false);
                               });
                           }
                       );

                  } catch (processingError) {
                       console.error("Error processing file data:", processingError);
                       setError("Erro inesperado ao processar os dados do arquivo.");
                       setUploading(false);
                  }
             };


            const handleFileUpload = (event) => {
                // ... (handleFileUpload logic remains the same) ...
                const file = event.target.files[0];
                if (!file) return;
                setUploading(true);
                setError(null);

                if (file.name.endsWith('.csv')) {
                    // Keep existing PapaParse logic
                    window.Papa.parse(file, {
                        header: true,
                        skipEmptyLines: 'greedy',
                        complete: (results) => processAndUpload(results.data, file),
                        error: (error) => {
                            console.error("CSV parsing error:", error);
                            setError("Erro ao processar o arquivo CSV.");
                            setUploading(false);
                        }
                    });
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    // Keep existing SheetJS logic, ensure cellDates: true
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = e.target.result;
                            // Use cellDates: true to help SheetJS parse dates
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const worksheet = workbook.Sheets['DADOS']; // Assume data is in 'DADOS' sheet
                            if (!worksheet) {
                                setError('Aba "DADOS" não encontrada na planilha.');
                                setUploading(false);
                                return;
                            }
                             // Start reading from row 3 (index 2), header is in row 3
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 2, /*defval: ""*/ }); // range: 2 means header is row 3 (0-indexed)
                            processAndUpload(jsonData, file);
                        } catch (error) {
                             console.error("Excel parsing error:", error);
                            setError("Erro ao processar o arquivo Excel.");
                            setUploading(false);
                        }
                    };
                    reader.onerror = () => {
                        setError("Erro ao ler o arquivo.");
                        setUploading(false);
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    setError("Formato de arquivo não suportado. Envie .csv ou .xlsx.");
                    setUploading(false);
                }
                 // Reset file input to allow uploading the same file again
                 event.target.value = null;
            };

            const handleDownloadLast = () => {
                if (client.lastPortfolioFileUrl) {
                    window.open(client.lastPortfolioFileUrl, '_blank');
                }
            };

            return (
                <div className="flex flex-col items-end space-y-2">
                    <div className="flex items-center space-x-3">
                        <button onClick={handleDownloadModelo} title="Baixar planilha modelo Excel com validações" className="flex items-center text-sm bg-slate-700 text-slate-300 font-semibold px-4 py-2 rounded-lg hover:bg-slate-600 transition-colors">
                             <Icon path={ICONS.DOWNLOAD} className="h-4 w-4 mr-2" />
                             Baixar Modelo
                        </button>
                        {client.lastPortfolioFileUrl && (
                             <button onClick={handleDownloadLast} title="Baixar a última planilha enviada para este cliente" className="flex items-center text-sm bg-slate-700 text-slate-300 font-semibold px-4 py-2 rounded-lg hover:bg-slate-600 transition-colors">
                                 <Icon path={ICONS.DOWNLOAD} className="h-4 w-4 mr-2" />
                                 Último Envio
                             </button>
                        )}
                        <input type="file" accept=".csv,.xlsx,.xls" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                        <button onClick={() => fileInputRef.current.click()} disabled={uploading} title="Carregar nova planilha (.csv ou .xlsx da aba DADOS do modelo)" className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors disabled:bg-sky-800 disabled:cursor-not-allowed">
                            {uploading ? <Loader className="h-5 w-5 mr-2" /> : <Icon path={ICONS.UPLOAD} className="h-5 w-5 mr-2" />}
                            {uploading ? 'Enviando...' : 'Carregar Planilha'}
                        </button>
                    </div>
                    {error && <p className="text-xs text-red-400 text-right">{error}</p>}
                </div>
            );
        }

        // --- TAB COMPONENTS for ClientDetail ---
        // ConsolidatedView
        function ConsolidatedView({ analysis }) {
            // ... (ConsolidatedView logic remains the same) ...
            const [selectedInstitution, setSelectedInstitution] = useState('Todas');
            const [viewType, setViewType] = useState('estrategia');

            const groupedData = useMemo(() => {
                if (!analysis) return null;

                let portfolioSource = analysis.portfolio;
                // Filter by institution if not 'Todas'
                if (selectedInstitution !== 'Todas') {
                    portfolioSource = analysis.portfolio.filter(p => (p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '')) === selectedInstitution);
                }
                 if (portfolioSource.length === 0) return []; // Return empty array if no assets for selection

                 // Calculate total value based on the filtered source
                 const currentTotalValue = portfolioSource.reduce((sum, asset) => sum + (asset.Valor || 0), 0);
                 if (currentTotalValue === 0) return []; // Avoid division by zero


                 // Group based on viewType
                const grouped = portfolioSource.reduce((acc, asset) => {
                    const key = viewType === 'estrategia'
                         ? asset.Classe + (asset.Subclasse ? ` - ${asset.Subclasse}` : '')
                         : asset['Tipo de Ativo'] || 'Não Especificado';

                    if (!acc[key]) acc[key] = { value: 0, assets: [] };
                    acc[key].value += (asset.Valor || 0);
                     // Add asset to the group only when grouping by type, otherwise it gets too large
                     if (viewType === 'tipo') {
                         acc[key].assets.push(asset);
                     }
                    return acc;
                }, {});

                // Calculate percentages and add assets for 'estrategia' view if needed later (maybe not needed for summary table)
                return Object.entries(grouped).map(([name, data]) => ({
                    name,
                    value: data.value,
                    percentage: data.value / currentTotalValue, // Use currentTotalValue for percentage
                    // Only include assets if grouping by type, for the detail view
                    assets: viewType === 'tipo' ? data.assets : analysis.portfolio.filter(p => (p.Classe + (p.Subclasse ? ` - ${p.Subclasse}`: '')) === name && (selectedInstitution === 'Todas' || (p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '')) === selectedInstitution))
                 })).sort((a,b) => b.value - a.value); // Sort groups by value

            }, [analysis, selectedInstitution, viewType]);

            if (!analysis) {
                return <div className="text-center p-10 bg-slate-800 rounded-lg"><h3 className="text-lg text-slate-400">Nenhum portfólio carregado. Por favor, carregue a planilha de ativos.</h3></div>
            }

             // Calculate total value based on selection
            const totalValue = selectedInstitution === 'Todas' ? analysis.totalValue : (groupedData || []).reduce((acc, item) => acc + item.value, 0);

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-start">
                         <div>
                             {/* View Type Toggle */}
                             <div className="flex items-center space-x-2 bg-slate-800 p-1 rounded-lg mb-2 w-fit">
                                 <button onClick={() => setViewType('estrategia')} className={`px-3 py-1 text-xs font-semibold rounded-md ${viewType === 'estrategia' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>Por Estratégia</button>
                                 <button onClick={() => setViewType('tipo')} className={`px-3 py-1 text-xs font-semibold rounded-md ${viewType === 'tipo' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>Por Tipo</button>
                             </div>
                             {/* Institution Filter */}
                             <div className="flex items-center flex-wrap gap-2 bg-slate-800 p-1 rounded-lg">
                                    <button onClick={() => setSelectedInstitution('Todas')} className={`px-4 py-2 text-sm font-semibold rounded-md transition-colors ${selectedInstitution === 'Todas' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
                                        Todas as Contas
                                    </button>
                                    {analysis.institutions.map(inst => (
                                        <button key={inst} onClick={() => setSelectedInstitution(inst)} className={`px-4 py-2 text-sm font-semibold rounded-md transition-colors ${selectedInstitution === inst ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-600'}`}>
                                             {inst}
                                         </button>
                                    ))}
                             </div>
                         </div>
                        <div className="bg-slate-800 p-4 rounded-lg text-right">
                            <p className="text-sm text-slate-400">Valor Total ({selectedInstitution === 'Todas' ? 'Geral' : selectedInstitution})</p>
                            <p className="text-2xl font-bold text-white">{formatCurrency(totalValue)}</p>
                        </div>
                    </div>

                    <div className="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                        {/* Pass totalValue based on selection */}
                        <GroupedAssetTable data={groupedData || []} totalValue={analysis.totalValue} title={viewType === 'estrategia' ? 'Classe / Subclasse' : 'Tipo de Ativo'} />
                    </div>

                </div>
            );
        }

        // --- Liquidity Analysis Component ---
        function LiquidityAnalysis({ analysis }) {
            if (!analysis || !analysis.liquidityAnalysis || analysis.liquidityAnalysis.length === 0) {
                 return <div className="text-center p-10 bg-slate-800 rounded-lg"><h3 className="text-lg text-slate-400">Análise de liquidez não disponível. Verifique os vencimentos na planilha.</h3></div>;
            }

            const liquidityOrder = ['D+0', 'D+5', 'D+30', 'D+180', 'D+365', '>D+365'];
            const sortedLiquidity = analysis.liquidityAnalysis.sort((a, b) => {
                 return liquidityOrder.indexOf(a.name) - liquidityOrder.indexOf(b.name);
            });


             return (
                 <div className="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                      <h3 className="text-xl font-semibold text-white p-4 border-b border-slate-700">Análise de Liquidez da Carteira</h3>
                     <table className="w-full text-left">
                          <thead>
                               <tr className="border-b border-slate-700">
                                   <th className="p-4 text-sm font-semibold text-slate-300">Prazo</th>
                                   <th className="p-4 text-sm font-semibold text-slate-300 text-right">Valor Alocado</th>
                                   <th className="p-4 text-sm font-semibold text-slate-300 text-right">% da Carteira</th>
                               </tr>
                          </thead>
                          <tbody>
                               {sortedLiquidity.map(bucket => (
                                   <tr key={bucket.name} className="border-b border-slate-700 last:border-b-0">
                                        <td className="p-4 font-medium text-white">{bucket.name.replace('>', '')}</td>
                                        <td className="p-4 text-slate-300 text-right font-semibold">{formatCurrency(bucket.value)}</td>
                                        <td className="p-4 text-slate-300 text-right font-semibold">{formatPercent(bucket.percentage)}</td>
                                   </tr>
                               ))}
                          </tbody>
                          <tfoot className="bg-slate-700/50">
                               <tr className="font-bold">
                                    <td className="p-4 text-white">TOTAL</td>
                                    <td className="p-4 text-white text-right">{formatCurrency(analysis.totalValue)}</td>
                                    <td className="p-4 text-white text-right">100,00%</td>
                               </tr>
                          </tfoot>
                     </table>
                 </div>
             );
         }


        // FlatAssetTable (Corrected whitespace)
         const FlatAssetTable = ({ portfolio }) => (
             <div className="max-h-96 overflow-y-auto">
                 <table className="w-full text-left text-xs">
                     <thead className="border-b border-slate-700 sticky top-0 bg-slate-800/80 backdrop-blur-sm">
                         <tr>
                             <th className="p-2 font-semibold text-slate-300">Nome do Ativo</th>
                             <th className="p-2 font-semibold text-slate-300">Emissor</th>
                             <th className="p-2 font-semibold text-slate-300">Tipo</th>
                             <th className="p-2 font-semibold text-slate-300">Classe / Subclasse</th>
                             <th className="p-2 font-semibold text-slate-300">Vencimento</th>
                             <th className="p-2 font-semibold text-slate-300">Taxa</th>
                             <th className="p-2 font-semibold text-slate-300 text-right">Valor</th>
                         </tr>
                     </thead>
                     <tbody>{/* No extra whitespace */}
                         {portfolio.length > 0 ? portfolio.sort((a,b) => b.Valor - a.Valor).map((asset, index) => (
                             <tr key={index} className="border-b border-slate-700/50 last:border-b-0 hover:bg-slate-700/30">
                                 <td className="p-2 font-medium text-slate-100" title={asset.Nome}>{asset.Nome}</td>
                                 <td className="p-2 text-slate-300" title={asset.Emissor}>{asset.Emissor || 'N/A'}</td>
                                 <td className="p-2 text-slate-300">{asset['Tipo de Ativo'] || 'N/A'}</td>
                                 <td className="p-2 text-slate-300">{asset.Classe}{asset.Subclasse ? ` - ${asset.Subclasse}` : ''}</td>
                                 <td className="p-2 text-slate-300">{formatDisplayDate(asset.Vencimento)}</td>
                                 <td className="p-2 text-slate-300">{asset.Taxa || 'N/A'}</td>
                                 <td className="p-2 text-slate-200 text-right font-medium">{formatCurrency(asset.Valor)}</td>
                             </tr>
                         )) : (
                             <tr><td colSpan="7" className="p-8 text-center text-slate-400">Nenhum ativo neste grupo.</td></tr>
                         )}
                     </tbody>{/* No extra whitespace */}
                 </table>
             </div>
         );


        // GroupedAssetTable (Corrected whitespace)
        const GroupedAssetTable = ({ data, totalValue, title }) => {
            const [expanded, setExpanded] = useState({});
            const toggle = (className) => setExpanded(prev => ({...prev, [className]: !prev[className]}));

            return (
                <table className="w-full text-left">
                    <thead className="border-b border-slate-700">
                        <tr>
                            <th className="p-4 text-sm font-semibold text-slate-300 w-1/2">{title}</th>
                            <th className="p-4 text-sm font-semibold text-slate-300 text-right">Valor Total</th>
                            <th className="p-4 text-sm font-semibold text-slate-300 text-right">% da Carteira</th>
                        </tr>
                    </thead>
                    <tbody>{/* No extra whitespace */}
                        {data.map(group => (
                            <Fragment key={group.name}>
                                <tr className="border-b border-slate-700 last:border-b-0 hover:bg-slate-700/50 cursor-pointer" onClick={() => toggle(group.name)}>
                                    <td className="p-4 font-medium text-white flex items-center">
                                        <Icon path={expanded[group.name] ? ICONS.CHEVRON_UP : ICONS.CHEVRON_DOWN} className="h-5 w-5 mr-2 flex-shrink-0" />
                                        <span className="truncate" title={group.name}>{group.name}</span>
                                    </td>
                                    <td className="p-4 text-slate-300 text-right font-semibold">{formatCurrency(group.value)}</td>
                                    <td className="p-4 text-slate-300 text-right font-semibold">{formatPercent(group.percentage)}</td>
                                </tr>
                                {expanded[group.name] && (
                                    <tr className="bg-slate-800/50">
                                        <td colSpan="3" className="p-0">
                                            <div className="p-4 border-t border-slate-700">
                                                 <FlatAssetTable portfolio={Array.isArray(group.assets) ? group.assets : []} />
                                            </div>
                                        </td>
                                    </tr>
                                )}
                            </Fragment>
                        ))}
                        {/* Footer Row */}
                        <tr className="bg-slate-700/50 font-bold">
                            <td className="p-4 text-white">TOTAL</td>
                            <td className="p-4 text-white text-right">{formatCurrency(data.reduce((sum, g) => sum + g.value, 0))}</td>
                            <td className="p-4 text-white text-right">{formatPercent(data.reduce((sum, g) => sum + g.percentage, 0))}</td>
                        </tr>
                    </tbody>{/* No extra whitespace */}
                </table>
            );
        };

        // SvgPieChart
        const SvgPieChart = ({ data, title }) => {
            const COLORS = ['#0ea5e9', '#14b8a6', '#8b5cf6', '#f97316', '#ec4899', '#facc15', '#64748b', '#ef4444', '#22c55e', '#a855f7'];
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0 || data.length === 0) return (
                 <div className="bg-slate-800 p-6 rounded-xl flex flex-col h-full items-center justify-center">
                     <h3 className="text-xl font-semibold mb-4 text-white text-center">{title}</h3>
                     <p className="text-slate-400">Sem dados para exibir.</p>
                 </div>
            );


            let cumulativePercent = 0;
            const segments = data.map((item, index) => {
                const percent = item.value / total;
                const segment = {
                    ...item,
                    percent,
                    angle: percent * 360,
                    startAngle: cumulativePercent * 360,
                    color: COLORS[index % COLORS.length]
                };
                cumulativePercent += percent;
                return segment;
            });

            const radius = 80;
            const circumference = 2 * Math.PI * radius;

            return (
                <div className="bg-slate-800 p-6 rounded-xl flex flex-col h-full svg-pie-chart-container">
                    {title && <h3 className="text-xl font-semibold mb-4 text-white text-center">{title}</h3>}
                    <div className="flex-grow flex items-center justify-center my-4"> {/* Added margin */}
                         <svg viewBox="0 0 200 200" className="w-48 h-48 transform -rotate-90">
                             {segments.map((segment, index) => {
                                 const dashArray = `${segment.percent * circumference} ${circumference}`;
                                 const rotation = segment.startAngle;
                                 return (
                                     <circle
                                         key={index}
                                         r={radius}
                                         cx="100"
                                         cy="100"
                                         fill="transparent"
                                         stroke={segment.color}
                                         strokeWidth="40"
                                         strokeDasharray={dashArray}
                                         transform={`rotate(${rotation} 100 100)`}
                                     >
                                         <title>{`${segment.name}: ${formatCurrency(segment.value)} (${formatPercent(segment.percent)})`}</title>
                                     </circle>
                                 );
                             })}
                         </svg>
                    </div>
                    {/* Legend with scroll */}
                    <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 text-sm max-h-32 overflow-y-auto pr-2">
                        {segments.sort((a,b) => b.value - a.value).map((segment, index) => ( // Sort legend by value
                            <div key={index} className="flex items-center">
                                <div className="w-3 h-3 rounded-sm mr-2 flex-shrink-0" style={{ backgroundColor: segment.color }}></div>
                                <span className="text-slate-300 truncate mr-2" title={segment.name}>{segment.name}</span>
                                <span className="ml-auto font-medium text-slate-200 whitespace-nowrap">{formatPercent(segment.percent)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // CssBarChart
         const CssBarChart = ({ data, title }) => {
             const COLORS = ['#0ea5e9', '#14b8a6', '#8b5cf6', '#f97316', '#ec4899', '#facc15', '#64748b', '#ef4444', '#22c55e', '#a855f7'];
             if (!data || data.length === 0) return null;
             // Filter out items with zero or negative value before finding max
             const validData = data.filter(item => item.value > 0);
             if (validData.length === 0) return null; // If all values are zero or less
             const maxValue = Math.max(...validData.map(item => item.value));

             return (
                  <div className="bg-slate-800 p-6 rounded-xl css-bar-chart-container">
                      {title && <h3 className="text-xl font-semibold mb-4 text-white">{title}</h3>}
                      <div className="space-y-3">
                          {validData.map((item, index) => ( // Use validData here
                              <div key={index} className="grid grid-cols-4 gap-4 items-center group">
                                  <span className="col-span-1 text-sm text-slate-300 truncate" title={item.name}>{item.name}</span>
                                  <div className="col-span-3">
                                      <div className="flex items-center">
                                          <div className="w-full bg-slate-700 rounded-full h-4 relative"> {/* Added relative positioning */}
                                              <div
                                                  className="h-4 rounded-full transition-all duration-500 css-bar-chart-bar"
                                                  style={{
                                                       width: `${(item.value / maxValue) * 100}%`,
                                                       backgroundColor: COLORS[index % COLORS.length]
                                                  }}
                                              ></div>
                                              {/* Optional: Add value label inside or next to bar */}
                                              {/* <span className="absolute left-2 top-0 bottom-0 flex items-center text-xs text-white mix-blend-difference pl-1">{formatCurrency(item.value)}</span> */}
                                          </div>
                                          <span className="ml-3 text-sm font-semibold text-white w-28 text-right flex-shrink-0">{formatCurrency(item.value)}</span> {/* Added flex-shrink-0 */}
                                      </div>
                                  </div>
                              </div>
                          ))}
                      </div>
                  </div>
             );
         };

        // ComparisonView
        function ComparisonView({ analysis, profile }) {
             const comparisonData = useMemo(() => {
                 if (!analysis || !profile || !profile.allocations) return null;

                 const { totalValue, currentAllocationByClass } = analysis; // Uses detailed keys

                 // Recommended Map (using normalized keys)
                 const recommendedAllocationMap = profile.allocations.reduce((acc, alloc) => {
                     if ((alloc.subcategories || []).length > 0) {
                          alloc.subcategories.forEach(sub => {
                              const key = alloc.Classe + (sub.name ? ` - ${sub.name}` : '');
                              const normalizedKey = normalizeString(key);
                              acc[normalizedKey] = {
                                  originalName: key,
                                  value: (sub.percentage / 100) * totalValue,
                                  percentage: sub.percentage / 100
                              };
                          });
                     } else {
                          const key = alloc.Classe;
                          const normalizedKey = normalizeString(key);
                          if(normalizedKey){
                              acc[normalizedKey] = {
                                  originalName: key,
                                  value: (alloc.percentage / 100) * totalValue,
                                  percentage: alloc.percentage / 100
                              };
                          }
                     }
                     return acc;
                 }, {});

                 // Current Map (using normalized keys)
                 const currentAllocationMap = Object.keys(currentAllocationByClass).reduce((acc, key) => {
                     const normalizedKey = normalizeString(key); // Normalize the key from currentAllocation
                     acc[normalizedKey] = {
                         originalName: key, // Keep the original display name
                         ...currentAllocationByClass[key] // Spread value and percentage
                     };
                     return acc;
                 }, {});

                 const allNormalizedClasses = [...new Set([...Object.keys(currentAllocationMap), ...Object.keys(recommendedAllocationMap)])];

                 const comparison = allNormalizedClasses.map(normalizedClass => {
                     const current = currentAllocationMap[normalizedClass] || { value: 0, percentage: 0, originalName: normalizedClass }; // Provide default originalName
                     const recommended = recommendedAllocationMap[normalizedClass] || { value: 0, percentage: 0, originalName: normalizedClass };

                     return {
                         name: current.originalName || recommended.originalName, // Prioritize display name
                         currentValue: current.value,
                         recommendedValue: recommended.value,
                         currentPercent: current.percentage,
                         recommendedPercent: recommended.percentage,
                         diffValue: current.value - recommended.value,
                     };
                 // Sort primarily by recommended percentage (desc), then current (desc) to group similar items
                 }).sort((a,b) => (b.recommendedPercent*1000 + b.currentPercent) - (a.recommendedPercent*1000 + a.currentPercent))
                 .filter(item => item.recommendedPercent > 0 || item.currentPercent > 0); // Filter out zero items


                 // Use pre-calculated chart data from analysis
                 return {
                     comparison,
                     currentChartData: analysis.currentChartData || [],
                     recommendedChartData: analysis.recommendedChartData || [],
                     institutionalChartData: analysis.institutionalChartData || []
                 };
             }, [analysis, profile]);

            if (!comparisonData) {
                return (
                    <div className="text-center p-10 bg-slate-800 rounded-lg">
                        <h3 className="text-lg text-slate-400">Dados insuficientes para comparação.</h3>
                        <p className="text-slate-500 mt-2">Carregue um portfólio e verifique se o cliente possui um perfil de investidor definido.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-8">
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <SvgPieChart data={comparisonData.currentChartData} title="Carteira Atual (por Classe)" />
                        <SvgPieChart data={comparisonData.recommendedChartData} title="Carteira Recomendada (por Classe)" />
                    </div>

                    <div className="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                        <h3 className="text-xl font-semibold text-white p-4">Análise de Enquadramento (Detalhado)</h3>
                        <table className="w-full text-left">
                           <thead className="border-b border-slate-700">
                               <tr>
                                   <th className="p-4 text-sm font-semibold text-slate-300">Classe / Subclasse</th>
                                   <th className="p-4 text-sm font-semibold text-slate-300 w-1/2">Alocação</th>
                                   <th className="p-4 text-sm font-semibold text-slate-300 text-right">Diferença (R$)</th>
                               </tr>
                           </thead>
                           <tbody>
                               {comparisonData.comparison.map((item, index) => (
                                   <tr key={index} className="border-b border-slate-700 last:border-b-0">
                                       <td className="p-4 font-medium text-white">{item.name}</td>
                                       <td className="p-4 text-slate-300">
                                           <div className="space-y-1">
                                               <div className="flex justify-between text-xs">
                                                   <span className="font-semibold text-white">Atual: {formatPercent(item.currentPercent)}</span>
                                                   <span className="text-slate-400">Rec: {formatPercent(item.recommendedPercent)}</span>
                                               </div>
                                               {/* Visual Bar */}
                                               <div className="w-full bg-slate-700 rounded-full h-2.5 relative">
                                                    {/* Current Allocation Bar */}
                                                    <div className="bg-sky-500 h-2.5 rounded-full" style={{ width: `${Math.min(item.currentPercent * 100, 100)}%` }}></div>
                                                    {/* Recommended Allocation Marker */}
                                                    <div className="absolute top-0 bottom-0 border-l-2 border-white" style={{ left: `${Math.min(item.recommendedPercent * 100, 100)}%` }}>
                                                         {/* Small dot on the marker line for visibility */}
                                                          <div className="w-1.5 h-1.5 bg-white rounded-full absolute -ml-1 top-1/2 -translate-y-1/2"></div>
                                                    </div>
                                               </div>
                                           </div>
                                       </td>
                                       <td className={`p-4 text-right font-semibold text-sm ${item.diffValue >= -0.01 && item.diffValue <= 0.01 ? 'text-slate-400' : item.diffValue > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                            {item.diffValue >= -0.01 && item.diffValue <= 0.01 ? 'Manter' : (item.diffValue > 0 ? `Resgatar ${formatCurrency(item.diffValue)}` : `Aplicar ${formatCurrency(Math.abs(item.diffValue))}`)}
                                       </td>

                                   </tr>
                               ))}
                           </tbody>
                        </table>
                    </div>

                    <CssBarChart data={comparisonData.institutionalChartData} title="Valor por Instituição" />
                </div>
            );
        }

        // IssuerView
         function IssuerView({ analysis }) {
             // Use pre-calculated issuerChartData from analysis
             const issuerChartData = analysis?.issuerChartData || [];

             if (!analysis || issuerChartData.length === 0) {
                 return <div className="text-center p-10 bg-slate-800 rounded-lg"><h3 className="text-lg text-slate-400">Nenhum emissor identificado ou todos com valor zero.</h3></div>;
             }

             return (
                 <div className="space-y-6">
                     <CssBarChart data={issuerChartData} title="Concentração por Emissor" />
                 </div>
             )
         }


        // RebalanceWorkspace
        function RebalanceWorkspace({ analysis, profile, redemptions, setRedemptions, applications, setApplications, recommendedAssets, totalAppliedPerClass, observations, setObservations, onSaveObservations }) {
            // ... (RebalanceWorkspace logic remains the same) ...
            const movements = useMemo(() => {
                if (!analysis || !profile || !profile.allocations) return null;
                const { totalValue, currentAllocationByClass } = analysis; // currentAllocationByClass IS using detailed keys

                 // Recommended Map (using normalized detailed keys)
                const recommendedAllocationMap = profile.allocations.reduce((acc, alloc) => {
                    if ((alloc.subcategories || []).length > 0) {
                         alloc.subcategories.forEach(sub => {
                             const key = alloc.Classe + (sub.name ? ` - ${sub.name}` : '');
                             const normalizedKey = normalizeString(key);
                             acc[normalizedKey] = {
                                 originalName: key,
                                 value: (sub.percentage / 100) * totalValue
                             };
                         });
                    } else {
                         const key = alloc.Classe;
                         const normalizedKey = normalizeString(key);
                         if(normalizedKey){
                             acc[normalizedKey] = {
                                 originalName: key,
                                 value: (alloc.percentage / 100) * totalValue
                             };
                         }
                    }
                    return acc;
                }, {});

                 // Current Map (using normalized detailed keys)
                const currentAllocationMap = Object.keys(currentAllocationByClass).reduce((acc, key) => {
                    const normalizedKey = normalizeString(key); // Normalize the detailed key
                    acc[normalizedKey] = {
                        originalName: key, // Keep original detailed name
                        value: currentAllocationByClass[key].value
                    };
                    return acc;
                }, {});


                const allKeys = [...new Set([...Object.keys(currentAllocationMap), ...Object.keys(recommendedAllocationMap)])];
                const diffs = {};

                allKeys.forEach(normalizedKey => {
                    const current = currentAllocationMap[normalizedKey] || { value: 0 };
                    const recommended = recommendedAllocationMap[normalizedKey] || { value: 0 };
                    const diff = current.value - recommended.value;
                     // Ensure originalName exists, fallback to normalizedKey if needed (shouldn't happen often)
                    const originalName = (current.originalName || recommended.originalName || normalizedKey);

                     // Only include significant differences to avoid tiny adjustments
                    if (Math.abs(diff) > 1) { // Threshold of R$1.00
                         diffs[originalName] = diff; // Use original detailed name as key
                    }
                });


                return {
                     // Keys are original detailed names (Class - Subclass)
                     toRedeem: Object.entries(diffs).filter(([, val]) => val > 0).reduce((acc, [key, val]) => ({...acc, [key]: val }), {}),
                     toApply: Object.entries(diffs).filter(([, val]) => val < 0).reduce((acc, [key, val]) => ({...acc, [key]: Math.abs(val) }), {}),
                };
            }, [analysis, profile]);

            const handleRedemptionChange = (asset, value) => {
                const assetId = `${asset.Instituição}-${asset["Número da Conta"] || 'N/A'}-${asset.Nome}-${asset.Valor}`; // More robust ID
                // Attempt to parse the value, considering BR format (comma for decimal)
                const rawValue = String(value).replace(/\./g, '').replace(',', '.');
                const amount = Math.min(parseFloat(rawValue) || 0, asset.Valor);


                if (amount <= 0.001) { // Use a small threshold for zero
                    const newRedemptions = { ...redemptions };
                    delete newRedemptions[assetId];
                    setRedemptions(newRedemptions);
                } else {
                    setRedemptions(prev => ({
                        ...prev,
                        [assetId]: { amount, asset } // Store full asset info
                    }));
                }
            };


             const handleAddApplication = (institution, newApp) => {
                  setApplications(prev => {
                      const currentApps = prev[institution] || [];
                      // Add a unique ID to each application for easier deletion
                      const appWithId = {...newApp, id: Date.now() + Math.random()};
                      return {
                          ...prev,
                          [institution]: [...currentApps, appWithId]
                      };
                  });
             };

            const handleDeleteApplication = (institution, appIdToDelete) => {
                setApplications(prev => {
                    const institutionApps = prev[institution] || [];
                    return {
                        ...prev,
                        [institution]: institutionApps.filter(app => app.id !== appIdToDelete)
                    };
                });
            };

            if (!analysis || !movements) {
                return <div className="text-center p-10 bg-slate-800 rounded-lg"><h3 className="text-lg text-slate-400">Dados insuficientes para gerar sugestões de rebalanceamento. Verifique o portfólio e o perfil.</h3></div>;
            }

            return (
                <div className="space-y-8">
                    {/* Observations Block */}
                     <div className="bg-slate-800 p-6 rounded-xl shadow-lg">
                         <h2 className="text-2xl font-bold text-white mb-4">Observações sobre o Plano</h2>
                         <textarea
                             className="w-full h-32 p-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500"
                             placeholder="Descreva a estratégia, os motivos das movimentações e outros pontos importantes para o cliente..."
                             value={observations}
                             onChange={(e) => setObservations(e.target.value)}
                         ></textarea>
                         <div className="text-right mt-4">
                             <button
                                 onClick={onSaveObservations}
                                 className="bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors"
                             >
                                 Salvar Observações
                             </button>
                         </div>
                     </div>

                    {/* Rebalance Blocks per Institution */}
                    {analysis.institutions.map(institution => (
                        <InstitutionRebalanceBlock
                            key={institution}
                            institution={institution}
                            portfolio={analysis.portfolio}
                            movements={movements}
                            redemptions={redemptions}
                            onRedemptionChange={handleRedemptionChange}
                            applications={applications}
                            onAddApplication={handleAddApplication}
                            onDeleteApplication={handleDeleteApplication}
                            recommendedAssets={recommendedAssets}
                            totalAppliedPerClass={totalAppliedPerClass} // Pass down
                        />
                    ))}
                </div>
            );
        }

        // InstitutionRebalanceBlock
         function InstitutionRebalanceBlock({ institution, portfolio, movements, redemptions, onRedemptionChange, applications, onAddApplication, onDeleteApplication, recommendedAssets, totalAppliedPerClass }) {

             const totalRedeemedInAccount = useMemo(() => {
                 return Object.values(redemptions)
                     .filter(({ asset }) => (asset.Instituição + (asset["Número da Conta"] ? ` - ${asset["Número da Conta"]}` : '')) === institution)
                     .reduce((sum, { amount }) => sum + amount, 0);
             }, [redemptions, institution]);

             const totalAppliedInAccount = useMemo(() => {
                 return (applications[institution] || []).reduce((sum, app) => sum + app.value, 0);
             }, [applications, institution]);

             const availableCash = totalRedeemedInAccount - totalAppliedInAccount;

             // Calculate remaining redemption need PER CLASS within THIS institution
             const remainingRedemptionNeed = useMemo(() => {
                 const need = {};
                 Object.entries(movements.toRedeem).forEach(([assetClass, totalAmountNeeded]) => {
                     // Find assets of this class ONLY in this institution
                     const assetsInClassAndAccount = portfolio.filter(p =>
                         (p.Classe + (p.Subclasse ? ` - ${p.Subclasse}`: '')) === assetClass &&
                         (p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '')) === institution
                     );
                     // Find redemptions already marked for this class (across ALL institutions)
                     let redeemedInClassTotal = 0;
                     Object.values(redemptions).forEach(({asset, amount}) => {
                          if ((asset.Classe + (asset.Subclasse ? ` - ${asset.Subclasse}`: '')) === assetClass) {
                              redeemedInClassTotal += amount;
                          }
                     });

                     // How much MORE needs to be redeemed from this class globally?
                     const globalRemainingNeed = Math.max(0, totalAmountNeeded - redeemedInClassTotal);

                     // How much is available to redeem from this class in THIS account?
                     const availableToRedeemHere = assetsInClassAndAccount.reduce((sum, asset) => {
                         const assetId = `${asset.Instituição}-${asset["Número da Conta"] || 'N/A'}-${asset.Nome}-${asset.Valor}`;
                         const alreadyRedeeming = redemptions[assetId]?.amount || 0;
                         return sum + (asset.Valor - alreadyRedeeming);
                     }, 0);

                     // The remaining need displayed for this class/account block is the minimum of the global need and what's available here
                     need[assetClass] = Math.min(globalRemainingNeed, availableToRedeemHere);

                 });
                 return need;
             }, [movements.toRedeem, portfolio, redemptions, institution]);


             // Calculate remaining application need PER CLASS, considering apps in THIS institution
              const remainingApplicationNeed = useMemo(() => {
                   const need = {};
                   Object.entries(movements.toApply).forEach(([assetClass, totalAmountNeeded]) => {
                       // How much is still needed for this class globally (considering ALL applications)?
                       const appliedGlobally = totalAppliedPerClass[assetClass] || 0;
                       const globalRemaining = Math.max(0, totalAmountNeeded - appliedGlobally);
                       need[assetClass] = globalRemaining;
                   });
                   return need;
              }, [movements.toApply, totalAppliedPerClass]); // Simplified dependency


             const AssetDetailRow = ({asset}) => (
                 <div className="text-xs text-slate-400 grid grid-cols-3 gap-x-2">
                     <span>Vcto: {formatDisplayDate(asset.Vencimento)}</span>
                     <span>Taxa: {asset.Taxa || 'N/A'}</span>
                     <span>Liq.: {asset.Liquidez || 'N/A'}</span>
                 </div>
             );

             return (
                 <div className="bg-slate-800 p-6 rounded-xl shadow-lg">
                     <h2 className="text-2xl font-bold text-white mb-2">{institution}</h2>
                     {/* Summary Boxes */}
                     <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                          <div className="bg-slate-700/50 p-3 rounded-lg"><p className="text-sm text-slate-400">Total Resgatado</p><p className="text-lg font-semibold text-red-400">{formatCurrency(totalRedeemedInAccount)}</p></div>
                          <div className="bg-slate-700/50 p-3 rounded-lg"><p className="text-sm text-slate-400">Total Aplicado</p><p className="text-lg font-semibold text-green-400">{formatCurrency(totalAppliedInAccount)}</p></div>
                          <div className="bg-slate-700/50 p-3 rounded-lg"><p className="text-sm text-slate-400">Caixa Disponível</p><p className={`text-lg font-semibold ${availableCash < -0.01 ? 'text-red-400' : 'text-sky-400'}`}>{formatCurrency(availableCash)}</p></div>
                     </div>

                     {/* Redemption and Application Columns */}
                     <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                         {/* Redemption Section */}
                         <div className="space-y-4">
                             <h3 className="text-xl font-semibold text-red-400 border-b border-slate-700 pb-2">Sugestões de Resgate</h3>
                              {Object.entries(movements.toRedeem) // Iterate through global redemption needs
                                   .filter(([assetClass]) => // Only show classes present in this institution
                                         portfolio.some(p =>
                                             (p.Classe + (p.Subclasse ? ` - ${p.Subclasse}`: '')) === assetClass &&
                                             (p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '')) === institution
                                         )
                                   )
                                   .map(([assetClass, totalAmountNeededGlobally]) => { // Renamed variable
                                       // Get assets of this class within this specific institution
                                       const assetsInClassAndAccount = portfolio.filter(p =>
                                            (p.Classe + (p.Subclasse ? ` - ${p.Subclasse}`: '')) === assetClass &&
                                            (p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '')) === institution
                                       );

                                       // Use the pre-calculated remaining need specific to this block
                                       const remainingToRedeemHere = remainingRedemptionNeed[assetClass] || 0;

                                       // Only render the block if there's a need OR assets to display
                                       if (remainingToRedeemHere <= 0.01 && assetsInClassAndAccount.length === 0) {
                                           return null;
                                       }


                                       return (
                                           <div key={assetClass} className="bg-slate-700/50 p-3 rounded-lg">
                                                <div className="flex justify-between items-center mb-2">
                                                    <h4 className="font-semibold text-white">{assetClass}</h4>
                                                    {/* Display remaining need for this class/account */}
                                                     <span className="text-sm text-red-400 font-bold">Falta Resgatar ~{formatCurrency(remainingToRedeemHere)}</span>
                                                </div>
                                               {/* List assets available for redemption in this class/account */}
                                               {assetsInClassAndAccount.map((asset) => {
                                                    const assetId = `${asset.Instituição}-${asset["Número da Conta"] || 'N/A'}-${asset.Nome}-${asset.Valor}`;
                                                    const currentRedemption = redemptions[assetId]?.amount || 0;
                                                     // Format input value correctly (display only)
                                                    const displayValue = currentRedemption > 0 ? new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(currentRedemption) : '';

                                                    return (
                                                        <div key={assetId} className="space-y-2 py-2 border-b border-slate-600 last:border-b-0">
                                                             <div className="flex items-center justify-between space-x-2">
                                                                  <div className="text-sm text-slate-300 flex-1 min-w-0">
                                                                      <p className="truncate font-semibold" title={asset.Nome}>{asset.Nome}</p>
                                                                      <p className="text-xs text-slate-400">Disp: {formatCurrency(asset.Valor)}</p>
                                                                  </div>
                                                                 <div className="flex items-center space-x-2 flex-shrink-0">
                                                                     <input
                                                                         type="text" // Keep as text for formatting
                                                                         placeholder="R$ 0,00"
                                                                         value={displayValue} // Use formatted display value
                                                                         onChange={(e) => {
                                                                              // Handle input change: remove formatting, then call handler
                                                                              const rawValue = e.target.value.replace(/\./g, '').replace(',', '.');
                                                                              onRedemptionChange(asset, rawValue); // Pass raw numeric string
                                                                         }}
                                                                         onBlur={(e) => { // Optional: Reformat on blur if needed, or rely on state update
                                                                               // This might cause cursor jumps if not handled carefully
                                                                         }}
                                                                         inputMode="decimal" // Help mobile keyboards
                                                                         className="w-28 px-2 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm text-right focus:ring-2 focus:ring-sky-500 focus:outline-none"
                                                                     />
                                                                     <button type="button" onClick={() => onRedemptionChange(asset, asset.Valor)} className="text-xs bg-sky-600 hover:bg-sky-700 text-white font-semibold px-2 py-1 rounded-md">Total</button>
                                                                 </div>
                                                             </div>
                                                             <AssetDetailRow asset={asset} />
                                                        </div>
                                                    )
                                                })}
                                           </div>
                                       )
                                   })}
                             {Object.keys(movements.toRedeem).length === 0 && <p className="text-slate-400 text-sm">Nenhum resgate sugerido.</p>}
                         </div>

                         {/* Application Section */}
                         <div className="space-y-4">
                             <h3 className="text-xl font-semibold text-green-400 border-b border-slate-700 pb-2">Sugestões de Aplicação</h3>
                              {Object.entries(movements.toApply)
                                   .filter(([assetClass]) => remainingApplicationNeed[assetClass] > 1) // Only show if global need > 1
                                   .map(([assetClass, totalAmountNeededGlobally]) => { // Iterate global needs

                                   // Use pre-calculated global remaining need
                                   const remainingToApplyGlobally = remainingApplicationNeed[assetClass] || 0;

                                   return (
                                       <div key={assetClass} className="bg-slate-700/50 p-3 rounded-lg">
                                            <div className="flex justify-between items-center mb-2">
                                                <h4 className="font-semibold text-white">{assetClass}</h4>
                                                {/* Display GLOBAL remaining need */}
                                                 <span className="text-sm text-green-400 font-bold">Falta Aplicar ~{formatCurrency(remainingToApplyGlobally)}</span>
                                            </div>
                                           {/* List applications already added for this class IN THIS institution */}
                                           {(applications[institution] || [])
                                                .filter(app => app.Classe === assetClass)
                                                .map((app) => ( // Use app.id for key and deletion
                                                <div key={app.id} className="flex items-center justify-between bg-slate-600/50 p-2 rounded mb-2">
                                                     <div>
                                                         <p className="text-sm font-semibold">{app.name}</p>
                                                         <p className="text-xs text-slate-300">{formatCurrency(app.value)}</p>
                                                     </div>
                                                     <button onClick={() => onDeleteApplication(institution, app.id)} className="text-red-400 hover:text-red-300"><Icon path={ICONS.TRASH} className="h-4 w-4" /></button>
                                                </div>
                                           ))}
                                           {/* Add Application Form */}
                                           <AddApplicationForm
                                                assetClass={assetClass} // Pass the detailed class name
                                                institution={institution}
                                                availableCash={availableCash} // Pass cash available IN THIS ACCOUNT
                                                onAddApplication={onAddApplication}
                                                recommendedAssets={recommendedAssets}
                                           />
                                       </div>
                                   )
                              })}
                             {Object.keys(movements.toApply).length === 0 && <p className="text-slate-400 text-sm">Nenhuma aplicação sugerida.</p>}

                         </div>
                     </div>
                 </div>
             )
         }

        // AddApplicationForm
         function AddApplicationForm({ assetClass, institution, availableCash, onAddApplication, recommendedAssets }) {
             const [selectedAsset, setSelectedAsset] = useState('');
             const [customAssetName, setCustomAssetName] = useState('');
             const [value, setValue] = useState('');
             const [error, setError] = useState('');

             const handleSubmit = (e) => {
                 e.preventDefault();
                 setError(''); // Clear previous error

                 // Parse value robustly
                 const numValue = parseFloat(value.replace(/\./g, '').replace(',', '.')) || 0;
                 const assetName = selectedAsset === 'custom' ? customAssetName.trim() : selectedAsset;

                 if (!assetName) {
                     setError('Selecione ou digite o nome do ativo.');
                     return;
                 }
                  if (numValue <= 0) {
                     setError('Digite um valor de aplicação válido.');
                     return;
                 }
                 // Check against available cash IN THIS ACCOUNT
                 if (numValue > availableCash + 0.01) { // Add small tolerance for float issues
                     setError(`Valor ${formatCurrency(numValue)} excede o caixa disponível (${formatCurrency(availableCash || 0)}). Libere mais caixa com resgates.`);
                     return;
                 }

                 // Pass the DETAILED assetClass received as prop
                 onAddApplication(institution, { name: assetName, value: numValue, Classe: assetClass });

                 // Reset form
                 setSelectedAsset('');
                 setCustomAssetName('');
                 setValue('');
                 setError('');
             };

            const handleValueChange = (e) => {
                const rawValue = e.target.value.replace(/\D/g, ''); // Remove non-digits
                if (rawValue === '') {
                     setValue('');
                     return;
                }
                const num = parseInt(rawValue, 10) / 100;
                 // Format using Intl.NumberFormat for locale-specific formatting
                 setValue(new Intl.NumberFormat('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num));
            };


             // Filter recommended assets based on the DETAILED assetClass
             const filteredRecommendedAssets = useMemo(() => {
                 const [mainClass, subClass] = assetClass.split(' - ');
                  const institutionNameOnly = institution.split(' - ')[0]; // Use only the institution name for matching


                 return recommendedAssets.filter(asset =>
                     normalizeString(asset.class) === normalizeString(mainClass) &&
                     (!subClass || normalizeString(asset.subclass || '') === normalizeString(subClass)) && // Handle case where asset might not have subclass
                     (asset.institutions || []).includes(institutionNameOnly) // Check if institution name is included
                 );
             }, [recommendedAssets, assetClass, institution]);

             return (
                 <form onSubmit={handleSubmit} className="space-y-2 mt-2">
                     <div className="flex flex-col space-y-2">
                         <select
                             value={selectedAsset}
                             onChange={(e) => {setSelectedAsset(e.target.value); if(e.target.value !== 'custom') setCustomAssetName('');}} // Clear custom name if selecting recommended
                             className="w-full px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm"
                         >
                             <option value="">Selecione um ativo recomendado...</option>
                             {filteredRecommendedAssets.map(asset => (
                                 <option key={asset.id} value={asset.name}>{asset.name}</option>
                             ))}
                             <option value="custom">-- Outro Ativo --</option>
                         </select>

                         {selectedAsset === 'custom' && (
                              <input
                                  type="text"
                                  placeholder="Nome do Ativo Personalizado"
                                  value={customAssetName}
                                  onChange={e => setCustomAssetName(e.target.value)}
                                  className="w-full px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm"
                                  required // Make required if 'custom' is selected
                              />
                         )}

                         <div className="flex space-x-2">
                             <input
                                 type="text" // Keep as text for formatting
                                 placeholder="R$ 0,00"
                                 value={value}
                                 onChange={handleValueChange}
                                 className="flex-1 px-2 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm text-right"
                                 inputMode="decimal" // Help mobile keyboards
                             />
                             <button type="submit" className="p-2 bg-sky-600 rounded-lg hover:bg-sky-500"><Icon path={ICONS.PLUS} className="h-4 w-4"/></button>
                         </div>
                     </div>
                     {error && <p className="text-xs text-red-400">{error}</p>}
                 </form>
             );
         }


        // ConfirmModal
        function ConfirmModal({ title, message, onConfirm, onCancel }) {
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4"> {/* Added padding */}
                    <div className="bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-md"> {/* Adjusted padding */}
                        <h2 className="text-xl font-bold text-white mb-4">{title}</h2>
                        <p className="text-slate-300 mb-6 text-sm">{message}</p> {/* Adjusted font size */}
                        <div className="flex justify-end pt-4 space-x-3">
                            <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-600 text-sm rounded-lg hover:bg-slate-500"> {/* Adjusted font size */}
                                Cancelar
                            </button>
                            <button type="button" onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg hover:bg-red-700"> {/* Adjusted font size */}
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Settings Page and Components ---
        // SettingsPage
        function SettingsPage() {
             const [activeTab, setActiveTab] = useState('profiles');
             return(
                 <div>
                     <div className="flex justify-between items-center mb-6">
                         <h1 className="text-3xl font-bold text-white">Configurações</h1>
                     </div>
                     <div className="flex border-b border-slate-700 mb-6">
                         <TabButton name="Perfis de Investidor" id="profiles" activeTab={activeTab} setActiveTab={setActiveTab} />
                         <TabButton name="Ativos Recomendados" id="assets" activeTab={activeTab} setActiveTab={setActiveTab} />
                         <TabButton name="Classes de Ativos" id="classes" activeTab={activeTab} setActiveTab={setActiveTab} />
                     </div>
                     {activeTab === 'profiles' && <ProfilesSettings />}
                     {activeTab === 'assets' && <RecommendedAssetsSettings />}
                     {activeTab === 'classes' && <ClassesSettings />}
                 </div>
             )
         }
        // ProfilesSettings
         function ProfilesSettings() {
             const [profiles, setProfiles] = useState([]);
             const [loading, setLoading] = useState(true);
             const [isModalOpen, setIsModalOpen] = useState(false);
             const [editingProfile, setEditingProfile] = useState(null);
             const [confirmingDelete, setConfirmingDelete] = useState(null);
             const [assetClasses, setAssetClasses] = useState([]);
             const [refreshTrigger, setRefreshTrigger] = useState(0); // Used to trigger re-fetch

             useEffect(() => {
                 const fetchData = async () => {
                     setLoading(true);
                     try {
                         // Fetch profiles and sort by name
                         const profilesSnapshot = await db.collection('profiles').orderBy('name').get();
                         const profilesData = profilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         setProfiles(profilesData);

                         // Fetch asset classes (needed for the modal)
                         const classesSnapshot = await db.collection('assetClasses').orderBy('name').get();
                         const classesData = classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         setAssetClasses(classesData);

                     } catch (error) {
                         console.error("Error fetching data for ProfilesSettings:", error);
                         // Handle error display if needed
                     } finally {
                         setLoading(false);
                     }
                 };
                 fetchData();
             }, [refreshTrigger]); // Re-fetch when refreshTrigger changes

             const openEditModal = (profile) => {
                 setEditingProfile(profile);
                 setIsModalOpen(true);
             }

             const openNewModal = () => {
                 setEditingProfile(null);
                 setIsModalOpen(true);
             }

             const openDeleteConfirmation = (profile) => {
                 setConfirmingDelete(profile);
             };

             const handleConfirmDelete = async () => {
                 if (confirmingDelete) {
                     try {
                          await db.collection("profiles").doc(confirmingDelete.id).delete();
                          setRefreshTrigger(t => t + 1); // Trigger re-fetch
                     } catch (error) {
                          console.error("Error deleting profile:", error);
                         // Handle error display
                     } finally {
                         setConfirmingDelete(null); // Close confirmation modal
                     }
                 }
             };

             // Helper to calculate total percentage for display
             const getTotalAllocation = (allocations) => {
                 return (allocations || []).reduce((sum, alloc) => sum + (Number(alloc.percentage) || 0), 0);
             };


             return (
                 <div>
                     <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                         <h2 className="text-2xl font-bold text-slate-300">Gerenciar Perfis de Investidor</h2>
                         <button onClick={openNewModal} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors">
                              <Icon path={ICONS.PLUS} className="h-5 w-5 mr-2" />
                              Novo Perfil
                         </button>
                     </div>

                     <div className="space-y-4">
                         {loading ? <div className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></div> : profiles.map(profile => (
                             <div key={profile.id} className="bg-slate-800 p-4 rounded-lg">
                                 <div className="flex justify-between items-start">
                                      <div>
                                          <h3 className="text-lg font-semibold text-white">{profile.name}</h3>
                                          <span className={`text-xs font-medium px-2 py-0.5 rounded ${getTotalAllocation(profile.allocations) === 100 ? 'bg-green-500/20 text-green-300' : 'bg-yellow-500/20 text-yellow-300'}`}>
                                               {getTotalAllocation(profile.allocations)}% Alocado
                                           </span>
                                      </div>
                                     <div className="flex items-center space-x-3 flex-shrink-0">
                                         <button onClick={() => openEditModal(profile)} title="Editar Perfil" className="text-sky-400 hover:text-sky-300"><Icon path={ICONS.EDIT} className="h-5 w-5" /></button>
                                         <button onClick={() => openDeleteConfirmation(profile)} title="Excluir Perfil" className="text-red-400 hover:text-red-300"><Icon path={ICONS.TRASH} className="h-5 w-5" /></button>
                                     </div>
                                 </div>
                                 {/* Optional: Display a summary of allocations */}
                                  <div className="mt-3 space-y-1 max-h-40 overflow-y-auto pr-2">
                                     {(profile.allocations || [])
                                         .sort((a,b) => b.percentage - a.percentage) // Sort allocations by percentage
                                         .map((alloc, i) => (
                                         <div key={i} className="bg-slate-700/50 p-2 rounded-md text-xs">
                                             <div className="flex justify-between">
                                                  <span className="text-slate-200 font-medium">{alloc.Classe}</span>
                                                  <span className="text-slate-200 font-bold">{alloc.percentage}%</span>
                                             </div>
                                             {/* Optionally show subclasses */}
                                              {(alloc.subcategories || []).length > 0 && (
                                                   <div className="pl-3 mt-1 text-slate-400 border-l border-slate-600 ml-1">
                                                        {(alloc.subcategories || []).map((sub, j) => (
                                                            <div key={j} className="flex justify-between">
                                                                 <span>- {sub.name}</span>
                                                                 <span>{sub.percentage}%</span>
                                                             </div>
                                                        ))}
                                                   </div>
                                              )}
                                         </div>
                                     ))}
                                 </div>
                             </div>
                         ))}
                         {profiles.length === 0 && !loading && (
                              <p className="text-center text-slate-400 py-8">Nenhum perfil cadastrado.</p>
                         )}
                     </div>
                     {isModalOpen && <ProfileModal profile={editingProfile} assetClasses={assetClasses} onClose={() => { setIsModalOpen(false); setRefreshTrigger(t => t + 1); }} />}
                     {confirmingDelete && (
                         <ConfirmModal
                             title="Confirmar Exclusão"
                             message={`Tem certeza que deseja excluir o perfil "${confirmingDelete.name}"? Clientes associados a este perfil precisarão ser atualizados.`}
                             onConfirm={handleConfirmDelete}
                             onCancel={() => setConfirmingDelete(null)}
                         />
                     )}
                 </div>
             );
         }
        // ProfileModal
         function ProfileModal({ profile, onClose, assetClasses }) {
             // Ensure initialAllocations handles potential missing subcategories gracefully
              const initialAllocations = profile
                  ? (profile.allocations || []).map(a => ({
                      ...a,
                      Classe: a.Classe || a.class, // Handle potential old 'class' key
                      class: undefined, // Remove old key if present
                      subcategories: Array.isArray(a.subcategories) ? a.subcategories.map(s => ({ ...s, id: Math.random() })) : [], // Ensure subcategories is array and add temporary ID
                      id: Math.random() // Temporary ID for mapping
                  }))
                  : [{ Classe: '', percentage: '', subcategories: [], id: Date.now() }]; // Start with one empty row

             const [name, setName] = useState(profile ? profile.name : '');
             const [allocations, setAllocations] = useState(initialAllocations);
             const [loading, setLoading] = useState(false);
             const [error, setError] = useState(''); // Added error state


             const handleAllocationChange = (id, field, value) => {
                 const newAllocations = allocations.map(alloc => {
                     if (alloc.id === id) {
                         let newValue = value;
                         let newSubcategories = alloc.subcategories; // Keep existing subs by default

                         // Handle percentage input
                         if (field === 'percentage') {
                              // Allow empty string, otherwise parse and cap between 0 and 100
                             newValue = value === '' ? '' : Math.max(0, Math.min(100, Number(value) || 0));
                         }

                         // If changing the main Class, reset subcategories
                          if (field === 'Classe' && value !== alloc.Classe) {
                              newSubcategories = [];
                              // Optionally reset percentage if class changes? Decided against it for now.
                          }


                         return { ...alloc, [field]: newValue, subcategories: newSubcategories };
                     }
                     return alloc;
                 });
                 setAllocations(newAllocations);
             };


             const addAllocation = () => setAllocations([...allocations, { Classe: '', percentage: '', subcategories: [], id: Date.now() + Math.random() }]); // Ensure unique ID
             const removeAllocation = (id) => setAllocations(allocations.filter((a) => a.id !== id));

             const handleSubcategoryChange = (classId, subId, field, value) => {
                 const newAllocations = allocations.map(alloc => {
                     if (alloc.id === classId) {
                         const newSubcategories = alloc.subcategories.map(sub => {
                             if (sub.id === subId) {
                                 let newValue = value;
                                 if (field === 'percentage') {
                                      // Allow empty string, otherwise parse and cap >= 0
                                     newValue = value === '' ? '' : Math.max(0, Number(value) || 0);
                                 }
                                 // Update name or percentage
                                 return { ...sub, [field]: newValue };
                              }
                             return sub;
                         });
                         return {...alloc, subcategories: newSubcategories};
                     }
                     return alloc;
                 });
                 setAllocations(newAllocations);
             };

             const addSubcategory = (classId) => {
                 const newAllocations = allocations.map(alloc => {
                     if (alloc.id === classId) {
                         // Find available subclasses for the selected Classe
                         const selectedClassInfo = assetClasses.find(c => c.name === alloc.Classe);
                         const availableSubs = selectedClassInfo?.subclasses || [];
                        const newSubcategories = [...(alloc.subcategories || []), { name: '', percentage: '', id: Math.random() }]; // Add temporary ID
                        return {...alloc, subcategories: newSubcategories};
                     }
                     return alloc;
                 });
                 setAllocations(newAllocations);
             };

             const removeSubcategory = (classId, subId) => {
                 const newAllocations = allocations.map(alloc => {
                     if (alloc.id === classId) {
                         const newSubcategories = alloc.subcategories.filter(sub => sub.id !== subId);
                         return {...alloc, subcategories: newSubcategories};
                     }
                     return alloc;
                 });
                 setAllocations(newAllocations);
             };

             const totalPercentage = allocations.reduce((sum, alloc) => sum + (Number(alloc.percentage) || 0), 0);

             // Validation function before submit
              const validateAllocations = () => {
                  setError(''); // Clear previous errors
                  if (!name.trim()) {
                      setError("O nome do perfil é obrigatório.");
                      return false;
                  }
                  if (allocations.length === 0) {
                      setError("Adicione pelo menos uma classe de ativo.");
                      return false;
                  }
                  if (Math.abs(totalPercentage - 100) > 0.01) { // Use tolerance for float issues
                      setError(`A alocação total (${totalPercentage.toFixed(2)}%) deve ser igual a 100%.`);
                      return false;
                  }

                   // Validate each allocation
                   for (const alloc of allocations) {
                       if (!alloc.Classe) {
                            setError("Todas as alocações devem ter uma Classe selecionada.");
                           return false;
                       }
                       if (alloc.percentage === '' || Number(alloc.percentage) < 0) {
                            setError(`A porcentagem para a classe "${alloc.Classe}" deve ser 0 ou maior.`);
                           return false;
                       }

                       // Validate subcategories if they exist
                       if (alloc.subcategories && alloc.subcategories.length > 0) {
                            const subTotal = alloc.subcategories.reduce((sum, sub) => sum + (Number(sub.percentage) || 0), 0);
                            if (Math.abs(subTotal - Number(alloc.percentage)) > 0.01) {
                                 setError(`A soma das subcategorias (${subTotal.toFixed(2)}%) para "${alloc.Classe}" não corresponde ao total da classe (${Number(alloc.percentage) || 0}%).`);
                                 return false;
                            }
                            for (const sub of alloc.subcategories) {
                                if (!sub.name) {
                                     setError(`Selecione ou digite um nome para todas as subcategorias em "${alloc.Classe}".`);
                                     return false;
                                }
                                if (sub.percentage === '' || Number(sub.percentage) < 0) {
                                     setError(`A porcentagem para a subcategoria "${sub.name}" em "${alloc.Classe}" deve ser 0 ou maior.`);
                                     return false;
                                }
                            }
                       }
                   }

                  return true; // All valid
              };


             const handleSubmit = async (e) => {
                 e.preventDefault();
                 if (!validateAllocations()) {
                     return; // Stop if validation fails
                 }

                 setLoading(true);
                 // Prepare data for Firestore, removing temporary IDs
                 const data = {
                     name: name.trim(),
                     allocations: allocations.map(({ id, ...alloc }) => ({ // Remove class-level temp ID
                         Classe: alloc.Classe,
                         percentage: Number(alloc.percentage) || 0,
                         subcategories: (alloc.subcategories || [])
                             .map(({ id: subId, ...sub }) => ({ // Remove subcategory temp ID
                                 name: sub.name,
                                 percentage: Number(sub.percentage) || 0,
                             }))
                             .filter(sub => sub.name && sub.percentage >= 0) // Ensure valid subs are saved
                     }))
                     .filter(a => a.Classe && a.percentage >= 0) // Ensure valid allocations are saved
                 };

                 try {
                     if (profile) {
                         await db.collection('profiles').doc(profile.id).update(data);
                     } else {
                         await db.collection('profiles').add(data);
                     }
                     onClose(); // Close modal on success
                 } catch (saveError) {
                      console.error("Error saving profile:", saveError);
                      setError("Erro ao salvar o perfil. Tente novamente.");
                 } finally {
                     setLoading(false);
                 }
             };

             return (
                  <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                       {/* Modal Content */}
                      <div className="bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-2xl max-h-[90vh] flex flex-col">
                          <div className="flex justify-between items-center mb-6 flex-shrink-0">
                             <h2 className="text-2xl font-bold text-white">{profile ? 'Editar Perfil' : 'Novo Perfil'}</h2>
                              <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon path={ICONS.CLOSE} /></button>
                          </div>

                          {/* Form Area with Scrolling */}
                          <form onSubmit={handleSubmit} className="flex-grow overflow-y-auto pr-2 space-y-4"> {/* Added pr-2 for scrollbar */}
                              <input type="text" placeholder="Nome do Perfil" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white" required />

                              {/* Allocation Header */}
                              <div className="flex justify-between items-center bg-slate-900 p-3 rounded-lg sticky top-0 z-10 -mx-2 px-2"> {/* Sticky header */}
                                  <h3 className="text-lg font-semibold text-white">Alocações</h3>
                                  <span className={`font-bold text-lg ${Math.abs(totalPercentage - 100) > 0.01 ? 'text-red-400' : 'text-green-400'}`}>
                                      {totalPercentage.toFixed(2)}% / 100%
                                  </span>
                              </div>

                              {/* Allocation Rows */}
                              {allocations.map((alloc) => {
                                  const selectedClassInfo = assetClasses.find(c => c.name === alloc.Classe);
                                  const availableSubclasses = selectedClassInfo?.subclasses || [];
                                  const subTotal = (alloc.subcategories || []).reduce((sum, sub) => sum + (Number(sub.percentage) || 0), 0);
                                  const classPercentage = Number(alloc.percentage) || 0;
                                  const subTotalMismatch = (alloc.subcategories || []).length > 0 && Math.abs(subTotal - classPercentage) > 0.01;

                                 return (
                                  <div key={alloc.id} className="bg-slate-700/50 p-4 rounded-lg space-y-3">
                                       {/* Main Class Row */}
                                      <div className="flex items-center space-x-2">
                                          <select
                                              value={alloc.Classe}
                                              onChange={e => handleAllocationChange(alloc.id, 'Classe', e.target.value)}
                                              className="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm" // Reduced size
                                          >
                                              <option value="">Selecione a Classe</option>
                                              {assetClasses.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                          </select>
                                          <input type="number" placeholder="%" min="0" max="100" step="0.01" value={alloc.percentage} onChange={e => handleAllocationChange(alloc.id, 'percentage', e.target.value)} className="w-24 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm" /> {/* Reduced size */}
                                          <button type="button" onClick={() => removeAllocation(alloc.id)} className="text-red-400 hover:text-red-300 p-2"><Icon path={ICONS.TRASH} className="h-5 w-5" /></button>
                                      </div>

                                      {/* Subcategories Section */}
                                      {(availableSubclasses.length > 0 || alloc.subcategories.length > 0) && ( // Show if potential subs exist OR if some are already added
                                      <div className="pl-6 pt-2 border-l-2 border-slate-600 ml-2 space-y-2">
                                          {(alloc.subcategories || []).map((sub) => (
                                              <div key={sub.id} className="flex items-center space-x-2">
                                                  <select // Use select for subclasses
                                                       value={sub.name}
                                                       onChange={e => handleSubcategoryChange(alloc.id, sub.id, 'name', e.target.value)}
                                                       className="flex-1 px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-xs" // Extra small size
                                                   >
                                                       <option value="">Selecione Subclasse</option>
                                                       {availableSubclasses.map(sName => <option key={sName} value={sName}>{sName}</option>)}
                                                       {/* Allow custom if needed, or remove this part */}
                                                       {/* <option value="custom">-- Outra --</option> */}
                                                   </select>
                                                   {/* Add input for custom if needed */}
                                                   <input type="number" placeholder="%" min="0" step="0.01" value={sub.percentage} onChange={e => handleSubcategoryChange(alloc.id, sub.id, 'percentage', e.target.value)} className="w-20 px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-xs" /> {/* Extra small size */}
                                                   <button type="button" onClick={() => removeSubcategory(alloc.id, sub.id)} className="text-red-500 hover:text-red-400 p-1"><Icon path={ICONS.TRASH} className="h-4 w-4" /></button>
                                               </div>
                                          ))}
                                           {/* Only allow adding subs if the main class allows them */}
                                           {availableSubclasses.length > 0 && (
                                               <button type="button" onClick={() => addSubcategory(alloc.id)} className="text-sky-400 text-xs font-semibold flex items-center pt-1"><Icon path={ICONS.PLUS} className="h-3 w-3 mr-1"/>Adicionar Subcategoria</button>
                                           )}
                                            {subTotalMismatch && (
                                                <div className="text-yellow-400 text-xs mt-1">
                                                     Soma Subs ({subTotal.toFixed(2)}%) ≠ Classe ({classPercentage.toFixed(2)}%)
                                                 </div>
                                            )}
                                      </div>
                                       )}

                                  </div>
                              )})}

                             <button type="button" onClick={addAllocation} className="text-sky-400 font-semibold text-sm flex items-center"><Icon path={ICONS.PLUS} className="h-4 w-4 mr-1"/>Adicionar Classe</button>

                             {error && <p className="text-red-400 text-xs text-center pt-2">{error}</p>} {/* Display errors */}

                             {/* Form Actions (Fixed at Bottom) */}
                             <div className="flex justify-end pt-4 space-x-3 flex-shrink-0 sticky bottom-0 bg-slate-800 -mx-2 px-2 pb-1"> {/* Sticky actions */}
                                 <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500 text-sm">Cancelar</button>
                                 <button type="submit" disabled={loading} className="px-4 py-2 bg-sky-600 rounded-lg hover:bg-sky-700 disabled:bg-sky-800 flex items-center text-sm">
                                     {loading && <Loader className="h-4 w-4 mr-2" />} {/* Smaller loader */}
                                     Salvar
                                 </button>
                             </div>
                         </form>
                      </div>
                   </div>
              )
         }

        // RecommendedAssetsSettings
         function RecommendedAssetsSettings() {
             const [assets, setAssets] = useState([]);
             const [loading, setLoading] = useState(true);
             const [isModalOpen, setIsModalOpen] = useState(false);
             const [editingAsset, setEditingAsset] = useState(null);
             const [confirmingDelete, setConfirmingDelete] = useState(null);
             const [assetClasses, setAssetClasses] = useState([]); // Fetch asset classes
             const [refreshTrigger, setRefreshTrigger] = useState(0);

             useEffect(() => {
                 setLoading(true);
                 const fetchData = async () => {
                     try {
                         // Fetch assets and sort
                         const assetsSnapshot = await db.collection('recommendedAssets').orderBy('name').get();
                         setAssets(assetsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                         // Fetch asset classes (needed for the modal)
                         const classesSnapshot = await db.collection('assetClasses').orderBy('name').get();
                         setAssetClasses(classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                     } catch (error) {
                         console.error("Error fetching data for RecommendedAssetsSettings:", error);
                     } finally {
                         setLoading(false);
                     }
                 };
                 fetchData();
             }, [refreshTrigger]); // Re-fetch on trigger change

             const openEditModal = (asset) => {
                 setEditingAsset(asset);
                 setIsModalOpen(true);
             }

             const openNewModal = () => {
                 setEditingAsset(null);
                 setIsModalOpen(true);
             }

             const openDeleteConfirmation = (asset) => {
                 setConfirmingDelete(asset);
             };

             const handleConfirmDelete = async () => {
                 if (confirmingDelete) {
                     try {
                          await db.collection("recommendedAssets").doc(confirmingDelete.id).delete();
                          setRefreshTrigger(t => t + 1); // Trigger re-fetch
                     } catch(error){
                          console.error("Error deleting asset:", error);
                          // Add error handling feedback
                     } finally {
                          setConfirmingDelete(null);
                     }

                 }
             };

               return (
                    <div>
                        <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-slate-300">Gerenciar Ativos Recomendados</h2>
                            <button onClick={openNewModal} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors">
                                <Icon path={ICONS.PLUS} className="h-5 w-5 mr-2" />
                                Novo Ativo
                            </button>
                        </div>

                        <div className="bg-slate-800 rounded-xl shadow-lg">
                            <table className="w-full text-left">
                                <thead className="border-b border-slate-700">
                                    <tr>
                                        <th className="p-4 text-sm font-semibold text-slate-300">Nome do Ativo</th>
                                        <th className="p-4 text-sm font-semibold text-slate-300">Classe</th>
                                        <th className="p-4 text-sm font-semibold text-slate-300">Subclasse</th>
                                        <th className="p-4 text-sm font-semibold text-slate-300">Corretoras</th>
                                        <th className="p-4 text-sm font-semibold text-slate-300 text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {loading ? (
                                        <tr><td colSpan="5" className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></td></tr>
                                    ) : assets.length > 0 ? assets.map(asset => (
                                        <tr key={asset.id} className="border-b border-slate-700 last:border-b-0 hover:bg-slate-700/50">
                                            <td className="p-4 font-medium text-white">{asset.name}</td>
                                            <td className="p-4 text-slate-300">{asset.class}</td>
                                            <td className="p-4 text-slate-300">{asset.subclass || 'N/A'}</td>
                                            <td className="p-4 text-slate-300 text-xs">{(asset.institutions || []).join(', ')}</td>
                                            <td className="p-4 flex justify-end items-center space-x-4">
                                                <button onClick={() => openEditModal(asset)} className="text-slate-400 hover:text-white"><Icon path={ICONS.EDIT} className="h-5 w-5"/></button>
                                                <button onClick={() => openDeleteConfirmation(asset)} className="text-slate-400 hover:text-red-400"><Icon path={ICONS.TRASH} className="h-5 w-5"/></button>
                                            </td>
                                        </tr>
                                    )) : (
                                        <tr><td colSpan="5" className="text-center p-8 text-slate-400">Nenhum ativo recomendado encontrado.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                        {isModalOpen && <RecommendedAssetModal asset={editingAsset} assetClasses={assetClasses} onClose={() => { setIsModalOpen(false); setRefreshTrigger(t => t + 1); }} />}
                        {confirmingDelete && (
                            <ConfirmModal
                                title="Confirmar Exclusão"
                                message={`Tem certeza que deseja excluir o ativo "${confirmingDelete.name}"?`}
                                onConfirm={handleConfirmDelete}
                                onCancel={() => setConfirmingDelete(null)}
                            />
                        )}
                    </div>
                );
         }
        // RecommendedAssetModal
        function RecommendedAssetModal({ asset, onClose, assetClasses }) {
            const [name, setName] = useState(asset ? asset.name : '');
            const [assetClass, setAssetClass] = useState(asset ? asset.class : '');
            const [subclass, setSubclass] = useState(asset ? asset.subclass || '' : ''); // Default to empty string if missing
            const [institutions, setInstitutions] = useState(asset ? asset.institutions || [] : []);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(''); // Added error state


            // Calculate available subclasses based on selected assetClass
            const availableSubclasses = useMemo(() => {
                if (!assetClass) return [];
                const selected = assetClasses.find(c => c.name === assetClass);
                return selected ? selected.subclasses || [] : [];
            }, [assetClass, assetClasses]);

             // Reset subclass if the selected class doesn't support the current subclass
             useEffect(() => {
                  if (subclass && !availableSubclasses.includes(subclass)) {
                      setSubclass(''); // Reset if subclass is no longer valid for the selected class
                  }
             }, [assetClass, subclass, availableSubclasses]);


            const handleInstitutionToggle = (institution) => {
                setInstitutions(prev =>
                    prev.includes(institution)
                        ? prev.filter(i => i !== institution)
                        : [...prev, institution]
                );
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); // Clear previous errors
                if (!name.trim() || !assetClass) {
                     setError('Nome do Ativo e Classe são obrigatórios.');
                     return;
                }
                 // Ensure subclass is valid if selected
                 if (subclass && !availableSubclasses.includes(subclass)) {
                     setError(`Subclasse "${subclass}" não é válida para a classe "${assetClass}". Selecione uma subclasse válida ou deixe em branco.`);
                     setSubclass(''); // Optionally reset the invalid subclass
                     return;
                 }
                  // Ensure at least one institution is selected
                  if (institutions.length === 0) {
                     setError('Selecione pelo menos uma corretora onde este ativo está disponível.');
                     return;
                  }


                setLoading(true);
                const data = {
                     name: name.trim(),
                     class: assetClass,
                     // Only include subclass if it's not an empty string
                     subclass: subclass || null, // Store null if empty for cleaner data
                     institutions: institutions.sort() // Store sorted list
                 };


                try {
                    if (asset) {
                        await db.collection('recommendedAssets').doc(asset.id).update(data);
                    } else {
                        await db.collection('recommendedAssets').add(data);
                    }
                     onClose(); // Close on success
                } catch (error) {
                    console.error("Error saving asset:", error);
                    setError("Erro ao salvar o ativo. Tente novamente.");
                } finally {
                    setLoading(false);
                }
            };

            return (
                 <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                     <div className="bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-lg"> {/* Adjusted padding */}
                         <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl md:text-2xl font-bold text-white">{asset ? 'Editar Ativo' : 'Novo Ativo Recomendado'}</h2> {/* Responsive font size */}
                             <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon path={ICONS.CLOSE} /></button>
                         </div>
                         <form onSubmit={handleSubmit} className="space-y-4">
                             <input type="text" placeholder="Nome do Ativo" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm" required /> {/* Adjusted font size */}
                             <select value={assetClass} onChange={e => { setAssetClass(e.target.value); setSubclass(''); }} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm" required> {/* Adjusted font size */}
                                 <option value="">Selecione a Classe</option>
                                 {assetClasses.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                             </select>
                             <select value={subclass} onChange={e => setSubclass(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm" disabled={availableSubclasses.length === 0}> {/* Adjusted font size */}
                                 <option value="">Selecione a Subclasse (opcional)</option>
                                 {availableSubclasses.map(s => <option key={s} value={s}>{s}</option>)}
                             </select>

                             <div>
                                 <label className="text-xs font-semibold text-slate-300 mb-2 block">Corretoras Disponíveis</label> {/* Adjusted font size */}
                                 <div className="grid grid-cols-2 sm:grid-cols-3 gap-2 p-3 bg-slate-700/50 rounded-lg"> {/* Responsive grid */}
                                     {INSTITUICOES.map(inst => (
                                         <label key={inst} className="flex items-center space-x-2 text-xs cursor-pointer"> {/* Adjusted font size */}
                                             <input
                                                 type="checkbox"
                                                 checked={institutions.includes(inst)}
                                                 onChange={() => handleInstitutionToggle(inst)}
                                                 className="form-checkbox h-4 w-4 rounded bg-slate-600 border-slate-500 text-sky-500 focus:ring-sky-500 focus:ring-offset-slate-800" // Added offset
                                             />
                                             <span>{inst}</span>
                                         </label>
                                     ))}
                                 </div>
                             </div>

                              {error && <p className="text-red-400 text-xs text-center">{error}</p>} {/* Display errors */}

                             <div className="flex justify-end pt-4 space-x-3">
                                 <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-600 text-sm rounded-lg hover:bg-slate-500">Cancelar</button> {/* Adjusted font size */}
                                 <button type="submit" disabled={loading} className="px-4 py-2 bg-sky-600 text-sm rounded-lg hover:bg-sky-700 disabled:bg-sky-800 flex items-center"> {/* Adjusted font size */}
                                     {loading && <Loader className="h-4 w-4 mr-2" />} {/* Smaller loader */}
                                     Salvar
                                 </button>
                             </div>
                         </form>
                     </div>
                 </div>
            );
        }

        // ClassesSettings
         function ClassesSettings() {
             const [classes, setClasses] = useState([]);
             const [loading, setLoading] = useState(true);
             const [isModalOpen, setIsModalOpen] = useState(false);
             const [editingClass, setEditingClass] = useState(null);
             const [confirmingDelete, setConfirmingDelete] = useState(null);
             const [seeding, setSeeding] = useState(false);
             const [refreshTrigger, setRefreshTrigger] = useState(0);

             useEffect(() => {
                 setLoading(true);
                 db.collection('assetClasses').orderBy('name').get() // Order by name
                     .then(snapshot => {
                         const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                         setClasses(data);
                     })
                     .catch(error => {
                         console.error("Error fetching asset classes:", error);
                     })
                     .finally(() => {
                         setLoading(false);
                     });
             }, [refreshTrigger]);

             const handleSeedData = async () => {
                 if (classes.length > 0) {
                     console.warn("Seeding aborted: Classes already exist.");
                     alert("As classes iniciais já existem ou foram cadastradas. O pré-cadastro foi cancelado.");
                     return; // Don't seed if data exists
                 }
                  setSeeding(true);
                  const initialClasses = { // Ensure consistency with model/dropdowns
                    'Renda Fixa Pós': ['Soberano', 'Crédito Privado', 'Bancário'],
                    'Renda Fixa Pré': ['Bancário'],
                    'Renda Fixa IPCA': ['Inflação'],
                    'Renda Variável': ['Long Only', 'Long Biased'], // Matches dropdown
                    'Multimercado': ['Macro', 'Long & Short'],
                    'Fundos Listados': ['FII', 'FI Infra', 'FI Agro'],
                    'Exterior': ['Renda Variável', 'Renda Fixa'], // Matches dropdown
                    'Alternativo': ['FIDC'], // Added
                    'Ações BR': ['Long Biased', 'Long Only'] // Added
                  };

                  const batch = db.batch();
                  // No need to check existing if logic prevents seeding when classes exist
                  Object.entries(initialClasses).forEach(([name, subclasses]) => {
                      const docRef = db.collection('assetClasses').doc(); // Auto-generate ID
                      batch.set(docRef, { name, subclasses: subclasses.sort() });
                  });

                   try {
                        await batch.commit();
                        console.log("Initial asset classes seeded successfully.");
                        setRefreshTrigger(t => t + 1); // Refresh list after seeding
                   } catch (error) {
                        console.error("Error seeding asset classes:", error);
                        alert("Erro ao pré-cadastrar classes.");
                   } finally {
                        setSeeding(false);
                   }
             };

             const handleDelete = async () => {
                 if (confirmingDelete) {
                     try {
                          await db.collection('assetClasses').doc(confirmingDelete.id).delete();
                           setRefreshTrigger(t => t + 1); // Refresh list
                     } catch(error) {
                          console.error("Error deleting class:", error);
                          alert("Erro ao excluir classe.");
                     } finally {
                          setConfirmingDelete(null);
                     }

                 }
             };

             return (
                 <div>
                     <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                         <h2 className="text-2xl font-bold text-slate-300">Gerenciar Classes e Subclasses</h2>
                         <div className="flex items-center space-x-4">
                             <button onClick={handleSeedData} disabled={seeding || classes.length > 0} title={classes.length > 0 ? "O pré-cadastro só pode ser executado uma vez com a lista vazia." : "Adiciona classes e subclasses comuns."} className="flex items-center bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-indigo-800 disabled:cursor-not-allowed disabled:opacity-50">
                                 {seeding ? <Loader className="h-5 w-5 mr-2" /> : null}
                                 Pré-cadastrar Padrão
                             </button>
                             <button onClick={() => { setEditingClass(null); setIsModalOpen(true); }} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors">
                                 <Icon path={ICONS.PLUS} className="h-5 w-5 mr-2" />
                                 Nova Classe
                             </button>
                         </div>
                     </div>
                     <div className="bg-slate-800 rounded-xl shadow-lg">
                         <table className="w-full text-left">
                             <thead className="border-b border-slate-700">
                                 <tr>
                                     <th className="p-4 text-sm font-semibold text-slate-300">Classe</th>
                                     <th className="p-4 text-sm font-semibold text-slate-300">Subclasses</th>
                                     <th className="p-4 text-sm font-semibold text-slate-300 text-right">Ações</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 {loading ? (
                                     <tr><td colSpan="3" className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></td></tr>
                                 ) : classes.map(c => (
                                     <tr key={c.id} className="border-b border-slate-700 last:border-b-0">
                                         <td className="p-4 font-bold text-white w-1/4">{c.name}</td>
                                         <td className="p-4 text-slate-300">
                                             <div className="flex flex-wrap gap-1"> {/* Reduced gap */}
                                                  {/* Sort subclasses alphabetically for consistent display */}
                                                 {(c.subclasses || []).sort().map(s => <span key={s} className="text-xs bg-slate-700 px-2 py-0.5 rounded-full">{s}</span>)} {/* Smaller padding/font */}
                                                 {(c.subclasses || []).length === 0 && <span className="text-xs text-slate-500 italic">Nenhuma</span>}
                                             </div>
                                         </td>
                                         <td className="p-4 flex justify-end items-center space-x-4">
                                             <button onClick={() => { setEditingClass(c); setIsModalOpen(true);}} className="text-slate-400 hover:text-white"><Icon path={ICONS.EDIT} className="h-5 w-5"/></button>
                                             <button onClick={() => setConfirmingDelete(c)} className="text-slate-400 hover:text-red-400"><Icon path={ICONS.TRASH} className="h-5 w-5"/></button>
                                         </td>
                                     </tr>
                                 ))}
                                  {classes.length === 0 && !loading && (
                                       <tr><td colSpan="3" className="text-center p-8 text-slate-400">Nenhuma classe cadastrada. Use "Pré-cadastrar Padrão" ou "Nova Classe".</td></tr>
                                  )}
                             </tbody>
                         </table>
                     </div>
                     {isModalOpen && <ClassModal assetClass={editingClass} onClose={() => { setIsModalOpen(false); setRefreshTrigger(t => t + 1); }} />}
                     {confirmingDelete && (
                         <ConfirmModal
                             title="Confirmar Exclusão"
                             message={`Tem certeza que deseja excluir a classe "${confirmingDelete.name}" e todas as suas subclasses? Verifique se esta classe não está em uso em Perfis ou Ativos Recomendados.`}
                             onConfirm={handleDelete}
                             onCancel={() => setConfirmingDelete(null)}
                         />
                     )}
                 </div>
             );
         }
        // ClassModal
        function ClassModal({ assetClass, onClose }) {
            const [name, setName] = useState(assetClass ? assetClass.name : '');
             // Ensure subclasses is always an array, map to objects with IDs
            const [subclasses, setSubclasses] = useState(assetClass ? (assetClass.subclasses || []).map(s => ({id: Math.random(), name: s})) : []);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(''); // Added error state


            const handleSubclassChange = (id, value) => {
                setSubclasses(subs => subs.map(s => s.id === id ? {...s, name: value.trim()} : s)); // Trim whitespace
            };

            const addSubclass = () => {
                // Add only if the last one isn't already empty (optional usability improvement)
                 // if (subclasses.length > 0 && subclasses[subclasses.length - 1].name === '') return;
                setSubclasses(subs => [...subs, { id: Math.random(), name: '' }]);
            };

            const removeSubclass = (id) => {
                setSubclasses(subs => subs.filter(s => s.id !== id));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(''); // Clear errors
                const trimmedName = name.trim();
                 if (!trimmedName) {
                     setError("O nome da classe é obrigatório.");
                     return;
                 }

                setLoading(true);

                 // Filter out empty subclasses, trim names, remove duplicates, and sort
                const finalSubclasses = [...new Set(
                     subclasses
                         .map(s => s.name.trim())
                         .filter(Boolean) // Remove empty strings
                 )].sort(); // Sort alphabetically


                const data = {
                    name: trimmedName,
                    subclasses: finalSubclasses
                };

                 try {
                     if (assetClass) {
                         await db.collection('assetClasses').doc(assetClass.id).update(data);
                     } else {
                         // Check if class name already exists before adding
                          const existingClass = await db.collection('assetClasses').where('name', '==', trimmedName).limit(1).get();
                          if (!existingClass.empty) {
                              setError(`A classe "${trimmedName}" já existe.`);
                              setLoading(false);
                              return;
                          }
                         await db.collection('assetClasses').add(data);
                     }
                      onClose(); // Close on success
                 } catch (saveError) {
                      console.error("Error saving asset class:", saveError);
                      setError("Erro ao salvar classe. Tente novamente.");
                 } finally {
                     setLoading(false);
                 }
            };

            return (
                 <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                     <div className="bg-slate-800 rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-lg flex flex-col max-h-[90vh]"> {/* Flex column and max height */}
                           <div className="flex justify-between items-center mb-6 flex-shrink-0"> {/* Header doesn't shrink */}
                               <h2 className="text-xl md:text-2xl font-bold text-white">{assetClass ? 'Editar Classe' : 'Nova Classe de Ativo'}</h2>
                                <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon path={ICONS.CLOSE} /></button>
                           </div>
                           {/* Form takes remaining space and scrolls */}
                           <form onSubmit={handleSubmit} className="flex-grow overflow-y-auto pr-2 space-y-4"> {/* Added scroll and padding */}
                              <input type="text" placeholder="Nome da Classe" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm" required />
                              <div>
                                  <h3 className="text-base font-semibold text-white mb-2">Subclasses (Opcional)</h3> {/* Adjusted size */}
                                  {/* Subclass list area */}
                                  <div className="space-y-2 mb-2">
                                      {subclasses.map((sub, index) => (
                                          <div key={sub.id} className="flex items-center space-x-2">
                                              <input type="text" placeholder={`Subclasse ${index + 1}`} value={sub.name} onChange={e => handleSubclassChange(sub.id, e.target.value)} className="flex-1 px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-xs" /> {/* Adjusted size */}
                                              <button type="button" onClick={() => removeSubclass(sub.id)} className="text-red-500 hover:text-red-400 p-1"><Icon path={ICONS.TRASH} className="h-4 w-4" /></button>
                                          </div>
                                      ))}
                                       {subclasses.length === 0 && <p className="text-xs text-slate-400 italic">Nenhuma subclasse adicionada.</p>}
                                  </div>
                                   <button type="button" onClick={addSubclass} className="text-sky-400 font-semibold text-xs flex items-center"><Icon path={ICONS.PLUS} className="h-3 w-3 mr-1"/>Adicionar Subclasse</button> {/* Adjusted size */}
                              </div>
                              {error && <p className="text-red-400 text-xs text-center">{error}</p>} {/* Error display */}

                           </form>
                           {/* Actions outside scrolling area */}
                            <div className="flex justify-end pt-4 space-x-3 mt-4 border-t border-slate-700 flex-shrink-0"> {/* Footer doesn't shrink */}
                              <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-600 text-sm rounded-lg hover:bg-slate-500">Cancelar</button>
                              {/* Need to trigger submit from outside form */}
                               <button type="button" onClick={handleSubmit} disabled={loading} className="px-4 py-2 bg-sky-600 text-sm rounded-lg hover:bg-sky-700 disabled:bg-sky-800 flex items-center">
                                   {loading && <Loader className="h-4 w-4 mr-2" />}
                                   Salvar
                               </button>
                           </div>
                     </div>
                 </div>
            )
        }

        // --- PresentationView and Slide Components ---
        // SlideHeader and SlideFooter (Updated footer for print)
        const SlideHeader = ({ title }) => (
             <div className="slide-header-print flex justify-between items-center border-b border-slate-700 pb-2 mb-4">
                 <h2 className="text-lg font-semibold text-sky-400">{title}</h2>
                 {/* Only show HIGHPAR text in print header */}
                 <h1 className="text-xl font-bold text-sky-500 hidden print:block">HIGHPAR</h1>
                 <Icon path={ICONS.CHART} className="h-6 w-6 text-sky-400 print:hidden" /> {/* Hide icon in print */}
             </div>
        );

        // Updated SlideFooter to show only HIGHPAR and simplified date/page for print
        const SlideFooter = ({ pageNumber, totalPages }) => (
            <div className="slide-footer-print text-center text-xs text-slate-400 border-t border-slate-700 pt-2 mt-auto">
                <span className="print:hidden">HIGHPAR | {formatDisplayDate(new Date())} | Página {pageNumber} de {totalPages}</span>
                <span className="hidden print:inline">HIGHPAR | {formatDisplayDate(new Date())} | {pageNumber} / {totalPages}</span>
            </div>
        );


        // General slide wrapper (remains mostly the same)
        const PresentationSlide = ({ title, children, pageNumber, totalPages, className = "" }) => (
            <div className={`presentation-slide flex flex-col p-8 bg-slate-900 border border-slate-700 rounded-lg shadow-xl ${className}`}>
                <SlideHeader title={title} />
                <div className="slide-content-print flex-grow overflow-y-auto">
                    {children}
                </div>
                <SlideFooter pageNumber={pageNumber} totalPages={totalPages} />
            </div>
        );

        // --- Specific Slide Content Components (Updated) ---
        // CoverSlide (Updated content)
        const CoverSlide = ({ client, user, pageNumber, totalPages }) => (
            <PresentationSlide title="" pageNumber={pageNumber} totalPages={totalPages} className="items-center justify-center text-center">
                {/* <Icon path={ICONS.CHART} className="h-24 w-24 text-sky-400 mb-6" /> Removed Icon */}
                <h1 className="text-5xl font-bold text-sky-400 mb-10">HIGHPAR</h1> {/* Added HIGHPAR title */}
                <h2 className="text-3xl font-bold mb-4 text-white">Análise e Rebalanceamento de Carteira</h2>
                <p className="text-2xl text-slate-300 mb-12">{client.name}</p>
                {/* <p className="text-lg text-slate-400">Preparado por: {user?.name || 'Consultor'}</p> */}
                <p className="text-lg text-slate-400 mt-auto">Data: {formatDisplayDate(new Date())}</p> {/* Moved Date to bottom */}
            </PresentationSlide>
        );

        // SummarySlide (Updated to include recommended and institutional charts)
        const SummarySlide = ({ analysis, profile, pageNumber, totalPages }) => (
            <PresentationSlide title="Resumo da Carteira" pageNumber={pageNumber} totalPages={totalPages}>
                {!analysis ? <p className="text-slate-400">Dados da carteira não disponíveis.</p> : (
                    <div className="flex flex-col h-full"> {/* Ensure flex column for layout */}
                        <div className="mb-6">
                            <h3 className="text-lg font-semibold mb-3 text-white">Informações Gerais</h3>
                            <div className="grid grid-cols-3 gap-4 text-center text-sm">
                                <div className="bg-slate-800/50 p-3 rounded">
                                    <p className="text-slate-400 mb-1">Valor Total</p>
                                    <p className="font-bold text-base text-white">{formatCurrency(analysis.totalValue)}</p>
                                </div>
                                <div className="bg-slate-800/50 p-3 rounded">
                                    <p className="text-slate-400 mb-1">Perfil de Risco</p>
                                    <p className="font-semibold text-base text-white">{profile?.name || 'N/A'}</p>
                                </div>
                                <div className="bg-slate-800/50 p-3 rounded">
                                    <p className="text-slate-400 mb-1">Contas Vinculadas</p>
                                    <p className="font-semibold text-base text-white">{analysis.institutions.length}</p>
                                </div>
                            </div>
                        </div>

                        {/* Charts take remaining space */}
                        <div className="flex-grow grid grid-cols-1 md:grid-cols-3 gap-6 items-center justify-center">
                             {/* Adjust chart components to fit, potentially smaller */}
                            <SvgPieChart data={analysis.currentChartData || []} title="Carteira Atual (Classe)" />
                            <SvgPieChart data={analysis.recommendedChartData || []} title="Carteira Recomendada (Classe)" />
                            <CssBarChart data={analysis.institutionalChartData || []} title="Valor por Instituição"/>
                        </div>
                    </div>
                )}
            </PresentationSlide>
        );

        // AllocationComparisonSlide (Updated to include visual bars)
        const AllocationComparisonSlide = ({ analysis, profile, pageNumber, totalPages }) => {
            const comparisonData = useMemo(() => {
                 if (!analysis || !profile || !profile.allocations) return null;
                 const { totalValue, currentAllocationByClass } = analysis; // Uses detailed keys
                 const recommendedAllocationMap = profile.allocations.reduce((acc, alloc) => {
                     if ((alloc.subcategories || []).length > 0) {
                          alloc.subcategories.forEach(sub => {
                              const key = alloc.Classe + (sub.name ? ` - ${sub.name}` : '');
                              const normalizedKey = normalizeString(key);
                              acc[normalizedKey] = { originalName: key, value: (sub.percentage / 100) * totalValue, percentage: sub.percentage / 100 };
                          });
                     } else {
                          const key = alloc.Classe;
                          const normalizedKey = normalizeString(key);
                          if(normalizedKey) acc[normalizedKey] = { originalName: key, value: (alloc.percentage / 100) * totalValue, percentage: alloc.percentage / 100 };
                     }
                     return acc;
                 }, {});
                 const currentAllocationMap = Object.keys(currentAllocationByClass).reduce((acc, key) => {
                     const normalizedKey = normalizeString(key);
                     acc[normalizedKey] = { originalName: key, ...currentAllocationByClass[key] };
                     return acc;
                 }, {});
                 const allNormalizedClasses = [...new Set([...Object.keys(currentAllocationMap), ...Object.keys(recommendedAllocationMap)])];
                 const comparison = allNormalizedClasses.map(normalizedClass => {
                     const current = currentAllocationMap[normalizedClass] || { value: 0, percentage: 0, originalName: normalizedClass };
                     const recommended = recommendedAllocationMap[normalizedClass] || { value: 0, percentage: 0, originalName: normalizedClass };
                     return { name: current.originalName || recommended.originalName, currentPercent: current.percentage, recommendedPercent: recommended.percentage, diffValue: current.value - recommended.value };
                 }).sort((a,b) => (b.recommendedPercent*1000 + b.currentPercent) - (a.recommendedPercent*1000 + a.currentPercent)).filter(item => item.recommendedPercent > 0 || item.currentPercent > 0);
                 return comparison;
            }, [analysis, profile]);

            return (
                <PresentationSlide title="Comparativo: Carteira Atual vs. Recomendada" pageNumber={pageNumber} totalPages={totalPages}>
                    {!comparisonData ? <p className="text-slate-400">Dados insuficientes.</p> : (
                        <div className="space-y-4">
                            <table className="w-full text-left text-sm">
                                <thead className="border-b border-slate-700">
                                    <tr>
                                        <th className="py-2 pr-2 font-semibold text-slate-300">Classe / Subclasse</th>
                                        <th className="py-2 px-2 font-semibold text-slate-300 w-1/3">Alocação (%)</th> {/* Combined column */}
                                        <th className="py-2 pl-2 font-semibold text-slate-300 text-right">Ajuste Sugerido (R$)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {comparisonData.map((item, index) => (
                                        <tr key={index} className="border-b border-slate-700/50 last:border-b-0">
                                            <td className="py-2 pr-2 font-medium text-white">{item.name}</td>
                                            <td className="py-2 px-2 text-slate-300"> {/* Bar column */}
                                                <div className="space-y-1">
                                                    <div className="flex justify-between text-xs">
                                                        <span className="font-semibold text-white">Atual: {formatPercent(item.currentPercent)}</span>
                                                        <span className="text-slate-400">Rec: {formatPercent(item.recommendedPercent)}</span>
                                                    </div>
                                                    {/* Visual Bar */}
                                                    <div className="w-full bg-slate-700 rounded-full h-2.5 relative">
                                                         {/* Current Allocation Bar */}
                                                         <div className="bg-sky-500 h-2.5 rounded-full" style={{ width: `${Math.min(item.currentPercent * 100, 100)}%` }}></div>
                                                         {/* Recommended Allocation Marker */}
                                                         <div className="absolute top-0 bottom-0 border-l-2 border-white" style={{ left: `${Math.min(item.recommendedPercent * 100, 100)}%` }}>
                                                              <div className="w-1.5 h-1.5 bg-white rounded-full absolute -ml-1 top-1/2 -translate-y-1/2"></div>
                                                         </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td className={`py-2 pl-2 text-right font-semibold ${item.diffValue >= -0.01 && item.diffValue <= 0.01 ? 'text-slate-400' : item.diffValue > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                                 {item.diffValue >= -0.01 && item.diffValue <= 0.01 ? 'Manter' : (item.diffValue > 0 ? `Resgatar ${formatCurrency(item.diffValue)}` : `Aplicar ${formatCurrency(Math.abs(item.diffValue))}`)}
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </PresentationSlide>
            );
        };


        // LiquiditySlide (Updated to show a table instead of pie chart)
        const LiquiditySlide = ({ analysis, pageNumber, totalPages }) => {
            const liquidityOrder = ['D+0', 'D+5', 'D+30', 'D+180', 'D+365', '>D+365'];
            const sortedLiquidity = useMemo(() => {
                if (!analysis || !analysis.liquidityAnalysis) return [];
                return [...analysis.liquidityAnalysis].sort((a, b) => { // Create copy before sort
                    return liquidityOrder.indexOf(a.name) - liquidityOrder.indexOf(b.name);
                });
            }, [analysis]);

            return (
                <PresentationSlide title="Análise de Liquidez da Carteira" pageNumber={pageNumber} totalPages={totalPages}>
                    {!analysis || sortedLiquidity.length === 0 ? (
                        <p className="text-slate-400">Dados de liquidez não disponíveis.</p>
                    ) : (
                        <table className="w-full text-left text-sm mt-4">
                            <thead className="border-b border-slate-700">
                                <tr>
                                    <th className="py-2 pr-2 font-semibold text-slate-300">Prazo</th>
                                    <th className="py-2 px-2 font-semibold text-slate-300 text-right">Valor Alocado</th>
                                    <th className="py-2 pl-2 font-semibold text-slate-300 text-right">% da Carteira</th>
                                </tr>
                            </thead>
                            <tbody>
                                {sortedLiquidity.map(bucket => (
                                    <tr key={bucket.name} className="border-b border-slate-700/50 last:border-b-0">
                                        <td className="py-2 pr-2 font-medium text-white">{bucket.name.replace('>', '')}</td>
                                        <td className="py-2 px-2 text-slate-300 text-right font-semibold">{formatCurrency(bucket.value)}</td>
                                        <td className="py-2 pl-2 text-slate-300 text-right font-semibold">{formatPercent(bucket.percentage)}</td>
                                    </tr>
                                ))}
                            </tbody>
                            <tfoot className="border-t-2 border-slate-600">
                                <tr className="font-bold">
                                     <td className="py-2 pr-2 text-white">TOTAL</td>
                                     <td className="py-2 px-2 text-white text-right">{formatCurrency(analysis.totalValue)}</td>
                                     <td className="py-2 pl-2 text-white text-right">100,00%</td>
                                </tr>
                            </tfoot>
                        </table>
                    )}
                </PresentationSlide>
            );
        };

        // NEW IssuerSlide Component
        const IssuerSlide = ({ analysis, pageNumber, totalPages }) => (
            <PresentationSlide title="Concentração por Emissor" pageNumber={pageNumber} totalPages={totalPages}>
                {!analysis || !analysis.issuerChartData || analysis.issuerChartData.length === 0 ? (
                    <p className="text-slate-400">Dados de emissores não disponíveis.</p>
                ) : (
                     // Using CssBarChart, ensuring data is passed correctly
                    <CssBarChart data={analysis.issuerChartData} title="" /> // Title handled by slide
                )}
            </PresentationSlide>
        );


        // RedemptionSlide (Remains mostly the same)
        const RedemptionSlide = ({ redemptions, pageNumber, totalPages }) => {
            const redemptionList = Object.values(redemptions);
            const totalRedeemed = redemptionList.reduce((sum, { amount }) => sum + amount, 0);

            return (
                <PresentationSlide title="Plano de Resgates" pageNumber={pageNumber} totalPages={totalPages}>
                    {redemptionList.length === 0 ? <p className="text-slate-400">Nenhum resgate planejado.</p> : (
                        <div className="space-y-4">
                            <table className="w-full text-left text-sm">
                                <thead className="border-b border-slate-700">
                                    <tr>
                                        <th className="py-2 pr-2 font-semibold text-slate-300">Ativo</th>
                                        <th className="py-2 px-2 font-semibold text-slate-300">Conta</th>
                                        <th className="py-2 pl-2 font-semibold text-slate-300 text-right">Valor a Resgatar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {redemptionList.sort((a,b) => b.amount - a.amount).map(({ asset, amount }, index) => (
                                        <tr key={index} className="border-b border-slate-700/50 last:border-b-0">
                                            <td className="py-2 pr-2 font-medium text-white">{asset.Nome}</td>
                                            <td className="py-2 px-2 text-slate-300 text-xs">{asset.Instituição}{asset["Número da Conta"] ? ` - ${asset["Número da Conta"]}` : ''}</td>
                                            <td className="py-2 pl-2 text-red-400 font-semibold text-right">{formatCurrency(amount)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="border-t-2 border-slate-600">
                                    <tr>
                                        <td colSpan="2" className="py-2 pr-2 font-bold text-white text-right">Total Resgatado:</td>
                                        <td className="py-2 pl-2 font-bold text-red-400 text-right">{formatCurrency(totalRedeemed)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    )}
                </PresentationSlide>
            );
        };

        // ApplicationSlide (Remains mostly the same)
        const ApplicationSlide = ({ applications, pageNumber, totalPages }) => {
            const applicationList = Object.entries(applications).flatMap(([institution, apps]) =>
                apps.map(app => ({ ...app, institution }))
            );
            const totalApplied = applicationList.reduce((sum, app) => sum + app.value, 0);

            return (
                <PresentationSlide title="Plano de Aplicações" pageNumber={pageNumber} totalPages={totalPages}>
                    {applicationList.length === 0 ? <p className="text-slate-400">Nenhuma aplicação planejada.</p> : (
                        <div className="space-y-4">
                            <table className="w-full text-left text-sm">
                                <thead className="border-b border-slate-700">
                                    <tr>
                                        <th className="py-2 pr-2 font-semibold text-slate-300">Ativo</th>
                                        <th className="py-2 px-2 font-semibold text-slate-300">Classe</th>
                                        <th className="py-2 px-2 font-semibold text-slate-300">Conta</th>
                                        <th className="py-2 pl-2 font-semibold text-slate-300 text-right">Valor a Aplicar</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {applicationList.sort((a,b) => b.value - a.value).map((app, index) => (
                                        <tr key={app.id || index} className="border-b border-slate-700/50 last:border-b-0">
                                            <td className="py-2 pr-2 font-medium text-white">{app.name}</td>
                                            <td className="py-2 px-2 text-slate-300 text-xs">{app.Classe}</td>
                                            <td className="py-2 px-2 text-slate-300 text-xs">{app.institution}</td>
                                            <td className="py-2 pl-2 text-green-400 font-semibold text-right">{formatCurrency(app.value)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                                <tfoot className="border-t-2 border-slate-600">
                                    <tr>
                                        <td colSpan="3" className="py-2 pr-2 font-bold text-white text-right">Total Aplicado:</td>
                                        <td className="py-2 pl-2 font-bold text-green-400 text-right">{formatCurrency(totalApplied)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    )}
                </PresentationSlide>
            );
        };

        // QuotationSlide (Remains mostly the same)
        const QuotationSlide = ({ quotations, redemptions, applications, pageNumber, totalPages }) => {
            const quotationItems = Object.entries(quotations).map(([assetId, data]) => {
                const redemption = Object.values(redemptions).find(r => `${r.asset.Instituição}-${r.asset["Número da Conta"] || 'N/A'}-${r.asset.Nome}-${r.asset.Valor}` === assetId);
                return {
                    id: assetId,
                    assetName: redemption?.asset?.Nome || 'Desconhecido',
                    institution: redemption?.asset?.Instituição || 'N/A',
                    account: redemption?.asset?.["Número da Conta"] || 'N/A',
                    amount: redemption?.amount || 0,
                    quotationData: data || {} // { pu: '', taxa: '' }
                };
            }).filter(item => item.amount > 0); // Only show items actually being redeemed

             // Calculate totals
            const totalRedeemed = Object.values(redemptions).reduce((sum, { amount }) => sum + amount, 0);
            const totalApplied = Object.values(applications).flat().reduce((sum, app) => sum + app.value, 0);
            const netCashFlow = totalRedeemed - totalApplied;


            return (
                <PresentationSlide title="Resumo das Movimentações e Cotações" pageNumber={pageNumber} totalPages={totalPages}>
                    {quotationItems.length === 0 && totalApplied === 0 ? <p className="text-slate-400">Nenhuma movimentação planejada.</p> : (
                        <div className="space-y-4">
                           {quotationItems.length > 0 && (<>
                                <h3 className="text-lg font-semibold text-white mb-2">Cotações para Resgate</h3>
                                <table className="w-full text-left text-sm">
                                    <thead className="border-b border-slate-700">
                                        <tr>
                                            <th className="py-2 pr-2 font-semibold text-slate-300">Ativo</th>
                                            <th className="py-2 px-2 font-semibold text-slate-300">Conta</th>
                                            <th className="py-2 px-2 font-semibold text-slate-300 text-right">Valor Resgate</th>
                                            <th className="py-2 px-2 font-semibold text-slate-300 text-center">PU (Cotação)</th>
                                            <th className="py-2 pl-2 font-semibold text-slate-300 text-center">Taxa (Cotação)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {quotationItems.sort((a, b) => b.amount - a.amount).map((item) => (
                                            <tr key={item.id} className="border-b border-slate-700/50 last:border-b-0">
                                                <td className="py-2 pr-2 font-medium text-white">{item.assetName}</td>
                                                <td className="py-2 px-2 text-slate-300 text-xs">{item.institution}{item.account !== 'N/A' ? ` - ${item.account}` : ''}</td>
                                                <td className="py-2 px-2 text-red-400 font-semibold text-right">{formatCurrency(item.amount)}</td>
                                                <td className="py-2 px-2 text-center text-slate-300">{item.quotationData.pu || '___'}</td>
                                                <td className="py-2 pl-2 text-center text-slate-300">{item.quotationData.taxa || '___'}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                 </table>
                           </>)}
                             <div className="mt-6 pt-4 border-t border-slate-700 grid grid-cols-3 gap-4 text-center">
                                <div className="bg-slate-700/50 p-3 rounded-lg">
                                    <p className="text-sm text-slate-400">Total Resgatado</p>
                                    <p className="text-lg font-semibold text-red-400">{formatCurrency(totalRedeemed)}</p>
                                </div>
                                <div className="bg-slate-700/50 p-3 rounded-lg">
                                    <p className="text-sm text-slate-400">Total Aplicado</p>
                                    <p className="text-lg font-semibold text-green-400">{formatCurrency(totalApplied)}</p>
                                </div>
                                <div className="bg-slate-700/50 p-3 rounded-lg">
                                    <p className="text-sm text-slate-400">Caixa Líquido</p>
                                    <p className={`text-lg font-semibold ${netCashFlow < -0.01 ? 'text-red-400' : 'text-green-400'}`}>{formatCurrency(netCashFlow)}</p>
                                </div>
                             </div>
                        </div>
                    )}
                </PresentationSlide>
            );
        };


        // ObservationsSlide (Remains the same, conditionally rendered)
        const ObservationsSlide = ({ observations, pageNumber, totalPages }) => (
            <PresentationSlide title="Observações" pageNumber={pageNumber} totalPages={totalPages}>
                <div className="text-slate-300 text-sm whitespace-pre-wrap">{observations || 'Nenhuma observação adicionada.'}</div>
            </PresentationSlide>
        );

        // --- PresentationView Component (Updated slide array and dependencies) ---
        function PresentationView({ client, profile, user, analysis, redemptions, applications, quotations, observations, onClose }) {
            const [currentSlide, setCurrentSlide] = useState(0);

            // Updated slide array: Added IssuerSlide, removed DisclaimerSlide
            const slides = useMemo(() => [
                <CoverSlide client={client} user={user} />,
                analysis && <SummarySlide analysis={analysis} profile={profile} />, // Only show if analysis exists
                analysis && profile && <AllocationComparisonSlide analysis={analysis} profile={profile} />, // Only show if analysis & profile exist
                analysis && analysis.liquidityAnalysis && <LiquiditySlide analysis={analysis} />, // Only show if liquidity data exists
                analysis && analysis.issuerChartData && analysis.issuerChartData.length > 0 && <IssuerSlide analysis={analysis} />, // Add Issuer slide
                (Object.keys(redemptions || {}).length > 0) && <RedemptionSlide redemptions={redemptions} />,
                (Object.values(applications || {}).flat().length > 0) && <ApplicationSlide applications={applications} />,
                // Show Quotation slide if there are redemptions OR applications (to show net cash)
                (Object.keys(redemptions || {}).length > 0 || Object.values(applications || {}).flat().length > 0) && <QuotationSlide quotations={quotations} redemptions={redemptions} applications={applications}/>,
                observations && <ObservationsSlide observations={observations} />,
                // <DisclaimerSlide /> // Removed Disclaimer slide
            ].filter(Boolean), [client, user, analysis, profile, redemptions, applications, quotations, observations]); // Updated dependencies

            const totalSlides = slides.length; // Calculate totalSlides AFTER filtering

            const nextSlide = () => setCurrentSlide((prev) => Math.min(prev + 1, totalSlides - 1));
            const prevSlide = () => setCurrentSlide((prev) => Math.max(prev - 1, 0));
            const handlePrint = () => window.print();

            // Effect to handle keyboard navigation
            useEffect(() => {
                const handleKeyDown = (event) => {
                    if (event.key === 'ArrowRight') nextSlide();
                    else if (event.key === 'ArrowLeft') prevSlide();
                    else if (event.key === 'Escape') onClose();
                };
                window.addEventListener('keydown', handleKeyDown);
                return () => window.removeEventListener('keydown', handleKeyDown);
            }, [totalSlides, onClose]);

            return (
                <div className="fixed inset-0 bg-slate-900 z-40 flex flex-col p-4 md:p-8">
                    {/* Header Controls (No Print) */}
                    <div className="flex justify-between items-center mb-4 no-print flex-shrink-0">
                        <div className="text-lg font-semibold text-white">
                            {client.name} - Apresentação
                        </div>
                        <div className="flex items-center space-x-4">
                            {/* Ensured Print button exists */}
                            <button onClick={handlePrint} className="p-2 text-slate-300 hover:text-white" title="Imprimir / Salvar PDF"><Icon path={ICONS.PDF} /></button>
                            <span className="text-sm text-slate-400">Slide {currentSlide + 1} / {totalSlides}</span>
                            <button onClick={prevSlide} disabled={currentSlide === 0} className="p-2 text-slate-300 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed"><Icon path={ICONS.CHEVRON_LEFT} /></button>
                            <button onClick={nextSlide} disabled={currentSlide === totalSlides - 1} className="p-2 text-slate-300 hover:text-white disabled:opacity-50 disabled:cursor-not-allowed"><Icon path={ICONS.CHEVRON_RIGHT} /></button>
                            <button onClick={onClose} className="p-2 text-slate-300 hover:text-white" title="Fechar (Esc)"><Icon path={ICONS.CLOSE} /></button>
                        </div>
                    </div>

                    {/* Slide Container (Handles visibility for screen) */}
                    <div className="flex-grow relative overflow-hidden no-print">
                        {slides.map((slide, index) => (
                            <div
                                key={index}
                                className={`absolute inset-0 transition-opacity duration-300 ${currentSlide === index ? 'opacity-100 z-10' : 'opacity-0 z-0'}`}
                            >
                                {/* Pass page number and total pages to the actual Slide component */}
                                {React.cloneElement(slide, { pageNumber: index + 1, totalPages: totalSlides })}
                            </div>
                        ))}
                    </div>

                    {/* Printable Content (Hidden on Screen) */}
                    <div className="printable-content">
                        {slides.map((slide, index) => (
                             // Pass totalPages here as well for printing
                            React.cloneElement(slide, { key: `print-${index}`, pageNumber: index + 1, totalPages: totalSlides })
                        ))}
                    </div>
                </div>
            );
        }

        // --- Quotation View Component ---
        function QuotationView({ redemptions, quotations, setQuotations }) {
             // ... (QuotationView logic remains the same) ...
            const redemptionItems = useMemo(() => {
                return Object.entries(redemptions).map(([assetId, { asset, amount }]) => ({
                    id: assetId,
                    assetName: asset.Nome,
                    institution: asset.Instituição,
                    account: asset["Número da Conta"] || 'N/A',
                    amount: amount
                })).filter(item => item.amount > 0); // Only show items actually being redeemed
            }, [redemptions]);

            const handleQuotationChange = (assetId, field, value) => {
                setQuotations(prev => ({
                    ...prev,
                    [assetId]: {
                        ...(prev[assetId] || {}), // Keep existing data for the other field
                        [field]: value
                    }
                }));
            };

             if (redemptionItems.length === 0) {
                 return <div className="text-center p-10 bg-slate-800 rounded-lg"><h3 className="text-lg text-slate-400">Nenhum resgate selecionado para cotação.</h3></div>;
             }


            return (
                <div className="bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h2 className="text-2xl font-bold text-white mb-4">Registro de Cotações para Resgate</h2>
                    <p className="text-sm text-slate-400 mb-6">Preencha o PU (Preço Unitário / Cota) e/ou a Taxa da operação no momento da execução do resgate.</p>
                    <div className="space-y-4">
                        <table className="w-full text-left text-sm">
                            <thead className="border-b border-slate-700">
                                <tr>
                                    <th className="py-2 pr-2 font-semibold text-slate-300">Ativo</th>
                                    <th className="py-2 px-2 font-semibold text-slate-300">Conta</th>
                                    <th className="py-2 px-2 font-semibold text-slate-300 text-right">Valor Resgate</th>
                                    <th className="py-2 px-2 font-semibold text-slate-300 text-center w-32">PU (Cotação)</th>
                                    <th className="py-2 pl-2 font-semibold text-slate-300 text-center w-32">Taxa (Cotação)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {redemptionItems.sort((a,b) => b.amount - a.amount).map((item) => {
                                    const currentQuotation = quotations[item.id] || {};
                                    return (
                                        <tr key={item.id} className="border-b border-slate-700/50 last:border-b-0">
                                            <td className="py-2 pr-2 font-medium text-white">{item.assetName}</td>
                                            <td className="py-2 px-2 text-slate-300 text-xs">{item.institution}{item.account !== 'N/A' ? ` - ${item.account}` : ''}</td>
                                            <td className="py-2 px-2 text-red-400 font-semibold text-right">{formatCurrency(item.amount)}</td>
                                            <td className="py-2 px-2 text-center">
                                                <input
                                                    type="text"
                                                    value={currentQuotation.pu || ''}
                                                    onChange={(e) => handleQuotationChange(item.id, 'pu', e.target.value)}
                                                    className="w-full px-2 py-1 bg-slate-700 border border-slate-600 rounded-lg text-white text-xs text-center focus:ring-1 focus:ring-sky-500 focus:outline-none"
                                                    placeholder="-"
                                                />
                                            </td>
                                            <td className="py-2 pl-2 text-center">
                                                <input
                                                    type="text"
                                                    value={currentQuotation.taxa || ''}
                                                    onChange={(e) => handleQuotationChange(item.id, 'taxa', e.target.value)}
                                                    className="w-full px-2 py-1 bg-slate-700 border border-slate-600 rounded-lg text-white text-xs text-center focus:ring-1 focus:ring-sky-500 focus:outline-none"
                                                    placeholder="-"
                                                />
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        }

        // --- Render App ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>
</html>

