<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enquadramento de Carteira - HIGHPAR</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.2/papaparse.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; /* slate-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b; /* slate-500 */
        }
        
        /* Hides the print-only content from the screen */
        /* Hides the print-only content from the screen (by moving it off-screen) */
/* Hides the print-only content from the screen (by moving it off-screen) */
.printable-content {
    /* display: none; */ 

    /* Novas regras para "esconder" fora da tela */
    display: block;
    /* visibility: hidden; <-- REMOVIDO */
    position: absolute;
    z-index: -1;
    top: 0;
    left: -9999px; /* Isso aqui já esconde o conteúdo para o usuário */
}

        /* STYLES DE IMPRESSÃO (CORRIGIDOS) */
        @media print {
            body, html {
                background-color: #fff !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                height: auto !important;
                overflow: visible !important;
                font-size: 10px; /* Adjust base font size for print */
            }
            /* Hide screen-only elements */
            .no-print {
                display: none !important;
            }

            /* ADICIONE ESTA NOVA REGRA AQUI */
            main {
                overflow: visible !important;
            }

            /* Show print-only content */
            .printable-content {
                display: block !important;
            }
            .presentation-slide {
                width: 100% !important;
                /* height: 100vh !important; -- REMOVED FOR BETTER PAGE BREAKS */
                page-break-after: always !important;
                display: flex !important;
                flex-direction: column !important;
                visibility: visible !important;
                opacity: 1 !important;
                position: relative !important;
                transform: none !important;
                border: 1px solid #e2e8f0 !important; /* slate-200 */
                background: #fff !important;
                color: #0f172a !important; /* slate-900 */
                overflow: hidden !important; /* Hide overflow in print */
                padding: 2.5rem !important;
                min-height: 27cm; /* A bit less than A4 height to ensure footer fits */
            }
            .presentation-slide h1, .presentation-slide h2, .presentation-slide h3, .presentation-slide p, .presentation-slide span, .presentation-slide th, .presentation-slide td, .presentation-slide div {
                color: #0f172a !important;
            }
            .presentation-slide .bg-slate-800, .presentation-slide .bg-slate-700, .presentation-slide .bg-slate-900, .presentation-slide .bg-slate-700\/50 {
                background-color: #f8fafc !important; /* slate-50 for backgrounds */
                border-color: #cbd5e1 !important; /* slate-300 */
            }
            .presentation-slide .border-slate-700 {
                border-color: #cbd5e1 !important; /* slate-300 */
            }
            .presentation-slide .text-white, .presentation-slide .text-slate-200, .presentation-slide .text-slate-300, .presentation-slide .text-slate-400 {
                color: #1e293b !important; /* slate-800 */
            }
            .presentation-slide .text-sky-400, .presentation-slide .text-sky-500 { color: #0ea5e9 !important; }
            .presentation-slide .text-green-400 { color: #22c55e !important; }
            .presentation-slide .text-red-400 { color: #ef4444 !important; }
            .presentation-slide .text-yellow-400 { color: #f59e0b !important; }
            .presentation-slide .bg-sky-500 { background-color: #0ea5e9 !important; color: #fff !important; }
            .presentation-slide table {
                page-break-inside: avoid !important;
            }
            .slide-content-print {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .slide-header-print {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid #cbd5e1;
                padding-bottom: 1rem;
                margin-bottom: 1rem; /* Reduced margin */
                flex-shrink: 0;
            }
            .slide-footer-print {
                text-align: center;
                border-top: 1px solid #cbd5e1;
                padding-top: 0.75rem;
                margin-top: 1rem; /* Reduced margin */
                font-size: 9px;
                color: #475569;
                flex-shrink: 0;
            }
        }
        /* --- FIM DA LIMPEZA DO CSS --- */
    </style>
</head>
<body class="bg-slate-900 text-white">
    <div id="root"></div>

    <script type="text/babel">
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDeAjUfGfnj1aLrym1NaJ_wMp1nzhmdgPw",
          authDomain: "enquadramento-de-carteira.firebaseapp.com",
          projectId: "enquadramento-de-carteira",
          storageBucket: "enquadramento-de-carteira.firebasestorage.app",
          messagingSenderId: "547291070273",
          appId: "1:547291070273:web:d800bf84374a5d8aefabc0",
          measurementId: "G-Q5205EXRBD"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const serverTimestamp = firebase.firestore.FieldValue.serverTimestamp;
        
        const { useState, useEffect, useMemo, useCallback, Fragment, useRef } = React;

        // --- SVG ICON COMPONENTS ---
        const Icon = ({ path, className = "h-6 w-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}>
                <path d={path} />
            </svg>
        );
        const ICONS = {
            DASHBOARD: "M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z",
            SETTINGS: "M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61-.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61-.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24-.42-.12-.64l2 3.46c.12.22.39.3.61-.22l2.49-1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z",
            LOGOUT: "M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z",
            CHEVRON_DOWN: "M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z",
            CHEVRON_UP: "M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z",
            CHEVRON_LEFT: "M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z",
            CHEVRON_RIGHT: "M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z",
            PLUS: "M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z",
            CLOSE: "M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z",
            UPLOAD: "M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z",
            DOWNLOAD: "M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z",
            EDIT: "M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z",
            TRASH: "M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z",
            CHART: "M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z",
            PDF: "M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm-2.5-2H15V8.5h-2.5v1.5zm-5-1.5H9v1.5h-.5V8.5zM22 12c0 1.1-.9 2-2 2V4c0-1.1-.9-2-2-2H4C2.9 2 2 2.9 2 4v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2v-8z"
        };

        const Loader = ({className}) => <svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>;

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (value) => {
            const num = parseFloat(value);
            if (isNaN(num)) return "R$ 0,00";
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(num);
        };
        const formatPercent = (value) => {
             const num = parseFloat(value);
            if (isNaN(num)) return "0,00%";
            return `${(num * 100).toFixed(2).replace('.',',')}%`;
        }
        
        const formatDisplayDate = (dateValue) => {
            if (!dateValue) return 'N/A';
            let date;
            
            if (dateValue && typeof dateValue.seconds === 'number') {
                date = new Date(dateValue.seconds * 1000);
            }
            else if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                const parts = dateValue.split('-');
                date = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
            }
            else if (typeof dateValue === 'number' || (typeof dateValue === 'string' && /^\d{5}$/.test(dateValue))) {
                try {
                    const excelSerial = Number(dateValue);
                    if (excelSerial < 60) {
                        date = new Date(1899, 11, 30 + excelSerial);
                    } else {
                        date = new Date(1899, 11, 30 + excelSerial - 1);
                    }
                } catch (e) { /* falha, segue para o próximo */ }
            }
            else if (typeof dateValue === 'string') {
                date = new Date(dateValue);
            }
            
            if (date && !isNaN(date.getTime())) {
                return new Intl.DateTimeFormat('pt-BR', { timeZone: 'UTC' }).format(date);
            }
            return dateValue.toString();
        };

        const normalizeString = (str) => {
            if (!str) return '';
            return str
                .toString()
                .trim()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        };

        const INSTITUICOES = ['XP', 'BTG', 'XP INTERNACIONAL', 'BTG INTERNACIONAL', 'AVENUE', 'BANCO DO BRASIL', 'SICOOB', 'BRADESCO', 'SANTANDER', 'SAFRA', 'NUBANK', 'INTER'];

        // --- MAIN APP COMPONENT ---
        function App() {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [page, setPage] = useState('dashboard'); 
            const [selectedClientId, setSelectedClientId] = useState(null);

                 useEffect(() => {
                      let unsubscribeUserDoc = () => {};
                      const unsubscribeAuth = auth.onAuthStateChanged((currentUser) => {
                            unsubscribeUserDoc();

                            if (currentUser) {
                                const userDocRef = db.collection("users").doc(currentUser.uid);
                                unsubscribeUserDoc = userDocRef.onSnapshot(async (doc) => {
                                    if (doc.exists) {
                                        setUser(currentUser);
                                        setUserData({ uid: currentUser.uid, ...doc.data() });
                                        setLoading(false);
                                    } else {
                                        try {
                                            const role = currentUser.email.toLowerCase().includes('admin') ? 'admin' : 'consultant';
                                            const name = currentUser.displayName || currentUser.email.split('@')[0];
                                            await userDocRef.set({
                                                name: name,
                                                email: currentUser.email,
                                                role: role,
                                            });
                                        } catch (error) {
                                            console.error("Failed to auto-create user document:", error);
                                            setUser(currentUser);
                                            setUserData(null);
                                            setLoading(false);
                                        }
                                    }
                                }, (error) => {
                                     console.error("Error fetching user data snapshot:", error);
                                     setUser(currentUser);
                                     setUserData(null);
                                     setLoading(false);
                                });
                            } else {
                                setUser(null);
                                setUserData(null);
                                setLoading(false);
                            }
                      });

                      return () => {
                            unsubscribeAuth();
                            unsubscribeUserDoc();
                      };
                 }, []);
            
            const handleSignOut = () => {
                auth.signOut();
                setPage('dashboard');
                setSelectedClientId(null);
            };

            if (loading) {
                return <div className="h-screen w-full flex items-center justify-center"><Loader className="h-12 w-12 text-sky-400" /></div>;
            }

            if (!user) {
                return <LoginPage />;
            }
            
            if (user && !userData) {
                 return (
                       <div className="h-screen w-full flex flex-col items-center justify-center text-center p-8 bg-slate-900 text-white">
                            <h1 className="text-2xl text-red-400 font-bold mb-4">Erro de Perfil</h1>
                            <p className="text-slate-400 mb-6 max-w-md">Não foi possível carregar ou criar os dados do seu perfil. Verifique as regras de segurança do Firebase e tente novamente.</p>
                            <button 
                                 onClick={handleSignOut} 
                                className="px-6 py-2 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors"
                            >
                                 Sair
                            </button>
                       </div>
                 );
            }
            
            return (
                <div className="min-h-screen bg-slate-900 flex">
                    <Sidebar user={userData} setPage={setPage} handleSignOut={handleSignOut} currentPage={page} />
                    <main className="flex-1 p-8 overflow-y-auto">
                        {page === 'dashboard' && <Dashboard user={userData} setPage={setPage} setSelectedClientId={setSelectedClientId} />}
                        {page === 'client' && <ClientDetail clientId={selectedClientId} user={userData} setPage={setPage} />}
                        {page === 'settings' && userData?.role === 'admin' && <SettingsPage />}
                    </main>
                </div>
            );
        }
        
        // --- COMPONENTS ---
        function Sidebar({ user, setPage, handleSignOut, currentPage }) {
            const NavItem = ({ iconPath, text, pageName }) => (
                <button
                    onClick={() => setPage(pageName)}
                    className={`flex items-center w-full px-4 py-3 text-sm font-medium rounded-lg transition-colors duration-200 group ${
                        currentPage === pageName ? 'bg-sky-500 text-white' : 'text-slate-300 hover:bg-slate-700 hover:text-white'
                    }`}
                >
                    <Icon path={iconPath} className={`h-5 w-5 ${currentPage === pageName ? 'text-white' : 'text-slate-400 group-hover:text-white'}`} />
                    <span className="ml-3">{text}</span>
                </button>
            );

            return (
                <aside className="w-64 bg-slate-800 p-4 flex flex-col justify-between border-r border-slate-700 no-print">
                    <div>
                        <div className="flex items-center mb-8 px-2">
                            <Icon path={ICONS.CHART} className="h-8 w-8 text-sky-400" />
                            <h1 className="ml-2 text-xl font-bold text-white">HIGHPAR</h1>
                        </div>
                        <nav className="space-y-2">
                            <NavItem iconPath={ICONS.DASHBOARD} text="Dashboard" pageName="dashboard" />
                            {user?.role === 'admin' && <NavItem iconPath={ICONS.SETTINGS} text="Configurações" pageName="settings" />}
                        </nav>
                    </div>
                    <div className="border-t border-slate-700 pt-4">
                       <div className="px-4 py-3">
                            <p className="text-sm font-medium text-white truncate">{user?.name}</p>
                            <p className="text-xs text-slate-400 truncate">{user?.email}</p>
                        </div>
                        <button
                            onClick={handleSignOut}
                            className="flex items-center w-full px-4 py-3 text-sm font-medium text-slate-300 hover:bg-slate-700 hover:text-white rounded-lg transition-colors duration-200 group"
                        >
                            <Icon path={ICONS.LOGOUT} className="h-5 w-5 text-slate-400 group-hover:text-white" />
                            <span className="ml-3">Sair</span>
                        </button>
                    </div>
                </aside>
            );
        }
        
        function LoginPage() {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [name, setName] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    if (isLogin) {
                        await auth.signInWithEmailAndPassword(email, password);
                    } else {
                        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                        const role = email.toLowerCase().includes('admin') ? 'admin' : 'consultant'; 
                        await db.collection("users").doc(userCredential.user.uid).set({
                            name: name,
                            email: email,
                            role: role,
                        });
                    }
                } catch (err) {
                    setError("Credenciais inválidas. Verifique seu e-mail e senha.");
                } finally {
                    setLoading(false);
                }
            };
            
            return (
                <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="flex justify-center items-center mb-6">
                            <Icon path={ICONS.CHART} className="h-10 w-10 text-sky-400" />
                            <h1 className="ml-3 text-3xl font-bold text-white">HIGHPAR</h1>
                        </div>
                        <div className="bg-slate-800 p-8 rounded-xl shadow-2xl">
                            <h2 className="text-2xl font-semibold text-center text-white mb-2">{isLogin ? 'Bem-vindo de volta!' : 'Crie sua conta'}</h2>
                            <p className="text-sm text-slate-400 text-center mb-6">{isLogin ? 'Faça login para continuar' : 'Preencha para se registrar'}</p>
                            <form onSubmit={handleAuth} className="space-y-4">
                                {!isLogin && (
                                    <input type="text" placeholder="Nome Completo" value={name} onChange={(e) => setName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                                )}
                                <input type="email" placeholder="Email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                                <input type="password" placeholder="Senha" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                                
                                {error && <p className="text-red-400 text-xs text-center">{error}</p>}

                                <button type="submit" disabled={loading} className="w-full py-3 bg-sky-600 text-white font-semibold rounded-lg hover:bg-sky-700 transition-colors duration-200 disabled:bg-sky-800 disabled:cursor-not-allowed flex items-center justify-center">
                                    {loading && <Loader className="h-5 w-5 mr-2" />}
                                    {isLogin ? 'Entrar' : 'Registrar'}
                                </button>
                            </form>
                            <p className="text-center text-sm text-slate-400 mt-6">
                                {isLogin ? 'Não tem uma conta?' : 'Já tem uma conta?'}
                                <button onClick={() => setIsLogin(!isLogin)} className="font-semibold text-sky-400 hover:text-sky-300 ml-1">
                                    {isLogin ? 'Registre-se' : 'Faça login'}
                                </button>
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        const calculateFrameworkStatus = (portfolio, profile) => {
            if (!portfolio || portfolio.length === 0 || !profile || !profile.allocations) {
                return { status: 'Aguardando Ativos', deviation: 100 };
            }

            const totalValue = portfolio.reduce((sum, asset) => sum + asset.Valor, 0);
            if (totalValue === 0) return { status: 'Aguardando Ativos', deviation: 100 };

            const currentAllocationByClass = portfolio.reduce((acc, asset) => {
                const key = asset.Classe + (asset.Subclasse ? ` - ${asset.Subclasse}` : '');
                if (!acc[key]) acc[key] = 0;
                acc[key] += asset.Valor;
                return acc;
            }, {});

            const recommendedAllocationMap = profile.allocations.reduce((acc, alloc) => {
                if ((alloc.subcategories || []).length > 0) {
                    alloc.subcategories.forEach(sub => {
                        const key = alloc.Classe + (sub.name ? ` - ${sub.name}` : '');
                        acc[normalizeString(key)] = sub.percentage / 100;
                    });
                } else {
                    const key = alloc.Classe;
                    if(key) acc[normalizeString(key)] = alloc.percentage / 100;
                }
                return acc;
            }, {});
            
            const currentAllocationMap = Object.entries(currentAllocationByClass).reduce((acc, [key, value]) => {
                acc[normalizeString(key)] = value / totalValue;
                return acc;
            }, {});

            const allKeys = [...new Set([...Object.keys(currentAllocationMap), ...Object.keys(recommendedAllocationMap)])];
            
            let totalDeviation = 0;
            allKeys.forEach(key => {
                const current = currentAllocationMap[key] || 0;
                const recommended = recommendedAllocationMap[key] || 0;
                totalDeviation += Math.abs(current - recommended);
            });
            
            const deviationPercentage = (totalDeviation / 2) * 100;

            if (deviationPercentage <= 5) return { status: 'Enquadrado', deviation: deviationPercentage };
            if (deviationPercentage <= 20) return { status: 'Atenção', deviation: deviationPercentage };
            return { status: 'Desenquadrado', deviation: deviationPercentage };
        };

        const StatusBadge = ({ status, deviation }) => {
            const styleMap = {
                'Enquadrado': 'bg-green-500/20 text-green-400',
                'Atenção': 'bg-yellow-500/20 text-yellow-400',
                'Desenquadrado': 'bg-red-500/20 text-red-400',
                'Aguardando Ativos': 'bg-slate-600/50 text-slate-400'
            };
            return (
                <div className="flex flex-col items-start">
                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${styleMap[status] || styleMap['Aguardando Ativos']}`}>
                        {status}
                    </span>
                    {status !== 'Aguardando Ativos' && (
                        <span className="text-xs text-slate-400 mt-1">{deviation.toFixed(2)}% desalinhado</span>
                    )}
                </div>
            );
        };

        function Dashboard({ user, setPage, setSelectedClientId }) {
            const [clients, setClients] = useState([]);
            const [loading, setLoading] = useState(true);
            const [modalState, setModalState] = useState({ open: false, client: null });
            const [deletingClient, setDeletingClient] = useState(null);

            useEffect(() => {
    if (!user) {
        setLoading(false);
        return;
    }

    // função que busca os dados iniciais e cria o listener em clients
    const fetchDashboardData = async () => {
        setLoading(true);
        try {
            // busca perfis primeiro (usado para calcular status)
            const profilesSnapshot = await db.collection('profiles').get();
            const profilesData = profilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // monta a query de clients (filtra por consultor se não for admin)
            let clientQuery = db.collection('clients');
            if (user.role !== 'admin') {
                clientQuery = clientQuery.where('consultantId', '==', user.uid);
            }

            // cria o listener em tempo real
            const unsubscribeClients = clientQuery.onSnapshot(
                (querySnapshot) => {
                    const clientsData = querySnapshot.docs.map(doc => {
                        const client = { id: doc.id, ...doc.data() };
                        const clientProfile = profilesData.find(p => p.id === client.profileId);
                        const { status, deviation } = calculateFrameworkStatus(client.portfolioData, clientProfile);
                        return { ...client, status, deviation };
                    });
                    setClients(clientsData);
                    setLoading(false);
                },
                (error) => {
                    console.error("Error fetching clients:", error);
                    setLoading(false);
                }
            );

            // retorna a função de unsubscribe para ser usada no cleanup
            return unsubscribeClients;
        } catch (error) {
            console.error("Error fetching initial dashboard data:", error);
            setLoading(false);
            // retorna uma função vazia para manter a assinatura consistente
            return () => {};
        }
    };

    // invoca a função e captura a promise que resolve para o unsubscribe
    let unsubscribe = () => {};
    fetchDashboardData().then((unsub) => {
        if (typeof unsub === 'function') unsubscribe = unsub;
    }).catch((err) => {
        console.error("fetchDashboardData failed:", err);
    });

    // cleanup do useEffect
    return () => {
        try {
            if (typeof unsubscribe === 'function') unsubscribe();
        } catch (e) {
            // swallow
        }
    };
}, [user]);

            const viewClient = (clientId) => {
                setSelectedClientId(clientId);
                setPage('client');
            };

            const handleDelete = async () => {
                if(deletingClient) {
                    await db.collection('clients').doc(deletingClient.id).delete();
                    setDeletingClient(null);
                }
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h1 className="text-3xl font-bold text-white">Dashboard de Clientes</h1>
                        <button onClick={() => setModalState({ open: true, client: null })} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors">
                            <Icon path={ICONS.PLUS} className="h-5 w-5 mr-2" />
                            Novo Cliente
                        </button>
                    </div>
                    {loading ? <div className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></div> : (
                        <div className="bg-slate-800 rounded-xl shadow-lg">
                            <table className="w-full text-left">
                                <thead className="border-b border-slate-700">
                                    <tr>
                                        <th className="p-4 text-sm font-semibold text-slate-300">Nome do Cliente</th>
                                        <th className="p-4 text-sm font-semibold text-slate-300">Perfil de Investidor</th>
                                        {user?.role === 'admin' && <th className="p-4 text-sm font-semibold text-slate-300">Consultor</th>}
                                        <th className="p-4 text-sm font-semibold text-slate-300">Status</th>
                                        <th className="p-4 text-sm font-semibold text-slate-300 text-right">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {clients.length > 0 ? clients.map(client => (
                                        <tr key={client.id} className="border-b border-slate-700 last:border-b-0 hover:bg-slate-700/50 transition-colors">
                                            <td className="p-4 font-medium text-white">{client.name}</td>
                                            <td className="p-4 text-slate-300">{client.profileName || 'Não definido'}</td>
                                            {user?.role === 'admin' && <td className="p-4 text-slate-300">{client.consultantName}</td>}
                                            <td className="p-4">
                                                <StatusBadge status={client.status} deviation={client.deviation} />
                                            </td>
                                            <td className="p-4 flex justify-end items-center space-x-4">
                                                <button onClick={() => viewClient(client.id)} className="text-sky-400 hover:text-sky-300 font-semibold">Visualizar</button>
                                                <button onClick={() => setModalState({ open: true, client: client })} className="text-slate-400 hover:text-white"><Icon path={ICONS.EDIT} className="h-5 w-5"/></button>
                                                <button onClick={() => setDeletingClient(client)} className="text-slate-400 hover:text-red-400"><Icon path={ICONS.TRASH} className="h-5 w-5"/></button>
                                            </td>
                                        </tr>
                                    )) : (
                                        <tr><td colSpan={user?.role === 'admin' ? 5 : 4} className="text-center p-8 text-slate-400">Nenhum cliente encontrado.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    )}
                    {modalState.open && user && <ClientModal user={user} clientToEdit={modalState.client} onClose={() => setModalState({ open: false, client: null })} />}
                    {deletingClient && (
                        <ConfirmModal 
                            title="Excluir Cliente"
                            message={`Tem certeza que deseja excluir "${deletingClient.name}"? Esta ação não pode ser desfeita.`}
                            onConfirm={handleDelete}
                            onCancel={() => setDeletingClient(null)}
                        />
                    )}
                </div>
            );
        }

        function ClientModal({ user, clientToEdit, onClose }) {
            const [clientName, setClientName] = useState('');
            const [profileId, setProfileId] = useState('');
            const [consultantId, setConsultantId] = useState('');
            
            const [profiles, setProfiles] = useState([]);
            const [consultants, setConsultants] = useState([]);
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if(clientToEdit){
                    setClientName(clientToEdit.name || '');
                    setProfileId(clientToEdit.profileId || '');
                    setConsultantId(clientToEdit.consultantId || '');
                } else if (user?.role === 'consultant') {
                    setConsultantId(user.uid);
                }
            }, [clientToEdit, user]);

            useEffect(() => {
                if (!user) return;
                const fetchInitialData = async () => {
                    const profilesSnapshot = await db.collection('profiles').get();
                    setProfiles(profilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                    if (user.role === 'admin') {
                        const consultantsSnapshot = await db.collection('users').where('role', '==', 'consultant').get();
                        setConsultants(consultantsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    }
                };
                fetchInitialData();
            }, [user]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                
                const selectedProfile = profiles.find(p => p.id === profileId);
                let selectedConsultant;
                if(user.role === 'admin'){
                    selectedConsultant = consultants.find(c => c.id === consultantId);
                } else {
                    selectedConsultant = {id: user.uid, name: user.name};
                }

                const clientData = {
                    name: clientName,
                    profileId: profileId,
                    profileName: selectedProfile?.name || '',
                    consultantId: selectedConsultant?.id,
                    consultantName: selectedConsultant?.name,
                };

                if(clientToEdit) {
                    await db.collection('clients').doc(clientToEdit.id).update(clientData);
                } else {
                    await db.collection('clients').add({...clientData, createdAt: serverTimestamp()});
                }
                
                setLoading(false);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                    <div className="bg-slate-800 rounded-xl shadow-2xl p-8 w-full max-w-lg">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-2xl font-bold text-white">{clientToEdit ? 'Editar Cliente' : 'Adicionar Novo Cliente'}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><Icon path={ICONS.CLOSE} /></button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                             <input type="text" placeholder="Nome do Cliente" value={clientName} onChange={e => setClientName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required />
                            <select value={profileId} onChange={e => setProfileId(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                 <option value="">Selecione um Perfil</option>
                                {profiles.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                            </select>
                            {user?.role === 'admin' && (
                                <select value={consultantId} onChange={e => setConsultantId(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500" required>
                                    <option value="">Atribuir a um Consultor</option>
                                    {consultants.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                </select>
                            )}
                            <div className="flex justify-end pt-4 space-x-3">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">Cancelar</button>
                                <button type="submit" disabled={loading} className="px-4 py-2 bg-sky-600 rounded-lg hover:bg-sky-700 disabled:bg-sky-800 flex items-center">
                                    {loading && <Loader className="h-5 w-5 mr-2" />}
                                    Salvar Cliente
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function ClientDetail({ clientId, user, setPage }) {
            const [client, setClient] = useState(null);
            const [profile, setProfile] = useState(null);
            const [recommendedAssets, setRecommendedAssets] = useState([]);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('consolidada');
            const [portfolio, setPortfolio] = useState([]);
            const [presentationMode, setPresentationMode] = useState(false);
            const [observations, setObservations] = useState('');
            const [saveStatus, setSaveStatus] = useState('');
            
            const [redemptions, setRedemptions] = useState({});
            const [applications, setApplications] = useState({});
            const [quotations, setQuotations] = useState({});
            
            useEffect(() => {
                if(!clientId) return;
                
                const fetchRecommendedAssets = async () => {
                    try {
                        const snapshot = await db.collection("recommendedAssets").get();
const assetsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
setRecommendedAssets(assetsData);
                    } catch (error) {
                        console.error("Error fetching recommended assets:", error);
                    }
                };
                
                fetchRecommendedAssets();

                const unsubscribe = db.collection("clients").doc(clientId).onSnapshot(async (doc) => {
                    if (doc.exists) {
                        const clientData = { id: doc.id, ...doc.data() };
                        setClient(clientData);
                        setPortfolio(clientData.portfolioData || []);
                        setObservations(clientData.observations || '');

                        if (clientData.profileId) {
                            try {
                                const profileDoc = await db.collection("profiles").doc(clientData.profileId).get();
                                if (profileDoc.exists) {
                                    setProfile({id: profileDoc.id, ...profileDoc.data()});
                                } else {
                                    setProfile(null);
                                }
                            } catch (error) {
                                console.error("Error fetching profile:", error);
                                setProfile(null);
                            }
                        } else {
                            setProfile(null);
                        }
                    } else {
                        setClient(null);
                        setPortfolio([]);
                        setProfile(null);
                    }
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [clientId]);
            
            const portfolioAnalysis = useMemo(() => {
                if (!portfolio || portfolio.length === 0) return null;
                
                const totalValue = portfolio.reduce((sum, asset) => sum + asset.Valor, 0);
                const institutions = [...new Set(portfolio.map(p => {
                    return p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '');
                }))];
                
                const currentAllocationByClass = portfolio.reduce((acc, asset) => {
                    const key = asset.Classe + (asset.Subclasse ? ` - ${asset.Subclasse}` : '');
                    if (!acc[key]) {
                        acc[key] = { value: 0, percentage: 0 };
                    }
                    acc[key].value += asset.Valor;
                    return acc;
                }, {});

                Object.keys(currentAllocationByClass).forEach(key => {
                    currentAllocationByClass[key].percentage = totalValue > 0 ? currentAllocationByClass[key].value / totalValue : 0;
                });
                
                const issuerConcentration = portfolio.reduce((acc, asset) => {
                    const key = asset.Emissor || 'Não Especificado';
                    if(!acc[key]) acc[key] = 0;
                    acc[key] += asset.Valor;
                    return acc;
                }, {});

                const allocationByAssetType = portfolio.reduce((acc, asset) => {
                    const key = asset['Tipo de Ativo'] || 'Não Especificado';
                    if (!acc[key]) acc[key] = { value: 0, assets: [] };
                    acc[key].value += asset.Valor;
                    acc[key].assets.push(asset);
                    return acc;
                }, {});

                Object.keys(allocationByAssetType).forEach(key => {
                    allocationByAssetType[key].percentage = totalValue > 0 ? allocationByAssetType[key].value / totalValue : 0;
                });

                return { totalValue, institutions, currentAllocationByClass, portfolio, issuerConcentration, allocationByAssetType };
            }, [portfolio]);

            const liquidityAnalysis = useMemo(() => {
                if (!portfolio || portfolio.length === 0) return null;

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const buckets = {
                    'D+0': { label: 'D+0', value: 0, days: 0 },
                    'D+5': { label: 'D+1 a D+5', value: 0, days: 5 },
                    'D+30': { label: 'D+6 a D+30', value: 0, days: 30 },
                    'D+180': { label: 'D+31 a D+180', value: 0, days: 180 },
                    'D+365': { label: 'D+181 a D+365', value: 0, days: 365 },
                    '>D+365': { label: '> D+365', value: 0, days: Infinity },
                };

                const parseLiquidityString = (liqStr) => {
                    if (!liqStr) return null;
                    const match = String(liqStr).match(/\d+/);
                    return match ? parseInt(match[0], 10) : null;
                };

                portfolio.forEach(asset => {
                    let daysToLiquidity = null;

                    if (asset.Vencimento) {
                        let assetDate;
                        const dateValue = asset.Vencimento;
                         if (dateValue && typeof dateValue.seconds === 'number') {
                            assetDate = new Date(dateValue.seconds * 1000);
                        } else if (typeof dateValue === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(dateValue)) {
                            const parts = dateValue.split('-');
                            assetDate = new Date(Date.UTC(parts[0], parts[1] - 1, parts[2]));
                        } else if (typeof dateValue === 'number' || (typeof dateValue === 'string' && /^\d{5}$/.test(dateValue))) {
                            const excelSerial = Number(dateValue);
                            assetDate = new Date(1899, 11, 30 + excelSerial - (excelSerial < 60 ? 0 : 1));
                        } else if (typeof dateValue === 'string') {
                            assetDate = new Date(dateValue);
                        }

                        if (assetDate && !isNaN(assetDate.getTime())) {
                            const diffTime = assetDate.getTime() - today.getTime();
                            daysToLiquidity = Math.max(0, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));
                        }
                    }
                    
                    if (daysToLiquidity === null && asset.Liquidez) {
                         daysToLiquidity = parseLiquidityString(asset.Liquidez);
                    }

                    if (daysToLiquidity === null) {
                        daysToLiquidity = 5;
                    }

                    if (daysToLiquidity <= buckets['D+0'].days) {
                        buckets['D+0'].value += asset.Valor;
                    } else if (daysToLiquidity <= buckets['D+5'].days) {
                        buckets['D+5'].value += asset.Valor;
                    } else if (daysToLiquidity <= buckets['D+30'].days) {
                        buckets['D+30'].value += asset.Valor;
                    } else if (daysToLiquidity <= buckets['D+180'].days) {
                        buckets['D+180'].value += asset.Valor;
                    } else if (daysToLiquidity <= buckets['D+365'].days) {
                        buckets['D+365'].value += asset.Valor;
                    } else {
                        buckets['>D+365'].value += asset.Valor;
                    }
                });
                
                return Object.values(buckets).map(b => ({name: b.label, value: b.value}));

            }, [portfolio]);
            
            const totalAppliedPerClass = useMemo(() => {
                return Object.values(applications).flat().reduce((acc, app) => {
                    if (!acc[app.Classe]) acc[app.Classe] = 0;
                    acc[app.Classe] += app.value;
                    return acc;
                }, {});
            }, [applications]);
            const handleSaveObservations = async () => {
                if (!client) return;
                setSaveStatus('Salvando...');
                try {
                    await db.collection("clients").doc(client.id).update({
                        observations: observations
                    });
                    setSaveStatus('Salvo!');
                } catch (error) {
                    console.error("Error saving observations:", error);
                    setSaveStatus('Erro!');
                } finally {
                    setTimeout(() => setSaveStatus(''), 2000);
                }
            };

            if (loading) return <div className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></div>;
            if (!client) return <div className="text-center p-8 text-slate-400">Cliente não encontrado.</div>;
            
            if (presentationMode) {
                const presentationComponent = (
                    <PresentationView 
                        client={client}
                        profile={profile}
                        user={user}
                        analysis={portfolioAnalysis}
                        liquidityAnalysis={liquidityAnalysis}
                        redemptions={redemptions}
                        applications={applications}
                        quotations={quotations}
                        observations={observations}
                        onClose={() => setPresentationMode(false)}
                    />
                );
                return ReactDOM.createPortal(presentationComponent, document.body);
            }

            return (
                <div className="space-y-6">
                     <button onClick={() => setPage('dashboard')} className="flex items-center text-sky-400 hover:text-sky-300 mb-4 text-sm font-semibold">
                         <Icon path={ICONS.CHEVRON_LEFT} className="h-5 w-5"/>
                         Voltar para Dashboard
                     </button>
                    <div className="flex justify-between items-start">
                        <div>
                            <h1 className="text-3xl font-bold text-white">{client.name}</h1>
                            <p className="text-slate-400">Perfil: <span className="font-semibold text-slate-300">{client.profileName}</span></p>
                        </div>
                       <PortfolioUploader client={client} />
                    </div>

                    <div className="flex justify-between items-center border-b border-slate-700">
                        <nav className="flex space-x-1 sm:space-x-6">
                            <TabButton name="Consolidada" id="consolidada" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <TabButton name="Comparativo" id="comparativo" activeTab={activeTab} setActiveTab={setActiveTab} disabled={!portfolioAnalysis}/>
                            <TabButton name="Emissores" id="emissores" activeTab={activeTab} setActiveTab={setActiveTab} disabled={!portfolioAnalysis} />
                            <TabButton name="Rebalanceamento" id="rebalanceamento" activeTab={activeTab} setActiveTab={setActiveTab} disabled={!portfolioAnalysis} />
                            <TabButton name="Cotação" id="cotacao" activeTab={activeTab} setActiveTab={setActiveTab} disabled={Object.keys(redemptions).length === 0} />
                        </nav>
                        <button onClick={() => setPresentationMode(true)} disabled={!portfolioAnalysis} className="flex items-center bg-teal-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-teal-700 transition-colors disabled:bg-teal-800 disabled:cursor-not-allowed">
                           <Icon path={ICONS.CHART} className="h-5 w-5 mr-2" />
                            Apresentação
                        </button>
                    </div>

                    <div>
                        <div style={{ display: activeTab === 'consolidada' ? 'block' : 'none' }}><ConsolidatedView analysis={portfolioAnalysis} liquidityAnalysis={liquidityAnalysis} /></div>
                        <div style={{ display: activeTab === 'comparativo' ? 'block' : 'none' }}><ComparisonView analysis={portfolioAnalysis} profile={profile} /></div>
                        <div style={{ display: activeTab === 'emissores' ? 'block' : 'none' }}><IssuerView analysis={portfolioAnalysis} /></div>
                        <div style={{ display: activeTab === 'rebalanceamento' ? 'block' : 'none' }}>
                            <RebalanceWorkspace 
                                analysis={portfolioAnalysis} 
                                profile={profile} 
                                redemptions={redemptions}
                                setRedemptions={setRedemptions}
                                applications={applications}
                                setApplications={setApplications}
                                recommendedAssets={recommendedAssets}
                                totalAppliedPerClass={totalAppliedPerClass}
                                observations={observations}
                                setObservations={setObservations}
                                onSaveObservations={handleSaveObservations}
                                saveStatus={saveStatus}
                            />
                        </div>
                        <div style={{ display: activeTab === 'cotacao' ? 'block' : 'none' }}>
                            <QuotationView
                                redemptions={redemptions}
                                quotations={quotations}
                                setQuotations={setQuotations}
                            />
                        </div>
                    </div>
                </div>
            )
        }
        
        const TabButton = ({ name, id, activeTab, setActiveTab, disabled = false }) => (
            <button
                onClick={() => !disabled && setActiveTab(id)}
                disabled={disabled}
                className={`py-3 px-1 text-sm font-semibold border-b-2 transition-colors duration-200 ${
                    activeTab === id
                        ? 'border-sky-500 text-sky-400'
                        : 'border-transparent text-slate-400'
                } ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:text-white'}`}
            >
                {name}
            </button>
        );

        function PortfolioUploader({ client }) {
            const [uploading, setUploading] = useState(false);
            const [error, setError] = useState(null);
            const fileInputRef = React.useRef(null);

            const handleDownloadModelo = () => {
                const wb = XLSX.utils.book_new();

                const classes = ['Renda Fixa Pós', 'Renda Fixa Pré', 'Renda Fixa IPCA', 'Renda Variável', 'Multimercado', 'Fundos Listados', 'Exterior'];
                const assetTypes = ['Fundo de Investimento', 'CDB', 'LCI', 'LCA', 'Ações', 'FII', 'ETF', 'BDR', 'Previdência'];

                const ws_listas_data = [
                    ["Instituição", "Classes", null, "Renda_Fixa_Pós", "Renda_Fixa_Pré", "Renda_Fixa_IPCA", "Renda_Variável", "Multimercado", "Fundos_Listados", "Exterior"],
                    [INSTITUICOES[0], classes[0], null, 'Soberano', 'Bancário', 'Inflação', 'Long Only', 'Macro', 'FII', 'Renda Variável'],
                    [INSTITUICOES[1], classes[1], null, 'Crédito Privado', null, null, 'Long Biased', 'Long & Short', 'FI Infra', 'Renda Fixa'],
                    [INSTITUICOES[2], classes[2], null, null, null, null, null, 'FI Agro', null],
                    [INSTITUICOES[3], classes[3]],
                    [INSTITUICOES[4], classes[4]],
                    [INSTITUICOES[5], classes[5]],
                    [INSTITUICOES[6], classes[6]],
                    [INSTITUICOES[7]],
                    [INSTITUICOES[8]],
                    [INSTITUICOES[9]],
                    [INSTITUICOES[10]],
                    [INSTITUICOES[11]],
                ];
                
                const ws_listas = XLSX.utils.aoa_to_sheet(ws_listas_data);
                ws_listas['!cols'] = [{wch:20}, {wch:20}, {wch:5}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:20}, {wch:20}];
                XLSX.utils.book_append_sheet(wb, ws_listas, "LISTAS");

                const ws_tipos_data = [["Tipos de Ativos"], ...assetTypes.map(t => [t])];
                const ws_tipos = XLSX.utils.aoa_to_sheet(ws_tipos_data);
                ws_tipos['!cols'] = [{ wch: 25 }];
                XLSX.utils.book_append_sheet(wb, ws_tipos, "LISTA_TIPOS");

                if(!wb.Workbook) wb.Workbook = {};
                if(!wb.Workbook.Sheets) wb.Workbook.Sheets = [];
                wb.Workbook.Sheets.push({ Name: 'LISTAS', Hidden: 1 });
                wb.Workbook.Sheets.push({ Name: 'LISTA_TIPOS', Hidden: 1 });

                const ws_dados = XLSX.utils.aoa_to_sheet([
                    [], [],
                    [null, "Instituição", "Número da Conta", "Nome", "Emissor", "Vencimento", "Taxa", "Liquidez", "Valor", "Classe", "Subclasse", "Tipo de Ativo"]
                ]);

                const headerStyle = { font: { bold: true, color: { rgb: "FFFFFF" } }, fill: { fgColor: { rgb: "0284C7" } } };
                ['B3', 'C3', 'D3', 'E3', 'F3', 'G3', 'H3', 'I3', 'J3', 'K3', 'L3'].forEach(c => {
                    if(ws_dados[c]) ws_dados[c].s = headerStyle;
                });
                
                for (let i = 4; i <= 103; i++) { 
                    ws_dados[`B${i}`] = { t:'s', v:'', dv: { type: "list", formula1: 'LISTAS!$A$2:$A$13' } };
                    ws_dados[`F${i}`] = { t:'n', z: 'dd/mm/yyyy' };
                    ws_dados[`J${i}`] = { t:'s', v:'', dv: { type: "list", formula1: 'LISTAS!$B$2:$B$8' } };
                    ws_dados[`K${i}`] = { t:'s', v:'', dv: { type: "list", formula1: `INDIRECT(SUBSTITUTE(J${i}," ","_"))` } };
                    ws_dados[`L${i}`] = { t:'s', v:'', dv: { type: "list", formula1: 'LISTA_TIPOS!$A$2:$A$10' } };
                }

                if(!wb.Workbook.Names) wb.Workbook.Names = [];
                wb.Workbook.Names.push({ Name: "Renda_Fixa_Pós", Ref: "'LISTAS'!$D$2:$D$3" });
                wb.Workbook.Names.push({ Name: "Renda_Fixa_Pré", Ref: "'LISTAS'!$E$2:$E$2" });
                wb.Workbook.Names.push({ Name: "Renda_Fixa_IPCA", Ref: "'LISTAS'!$F$2:$F$2" });
                wb.Workbook.Names.push({ Name: "Renda_Variável", Ref: "'LISTAS'!$G$2:$G$3" });
                wb.Workbook.Names.push({ Name: "Multimercado", Ref: "'LISTAS'!$H$2:$H$3" });
                wb.Workbook.Names.push({ Name: "Fundos_Listados", Ref: "'LISTAS'!$I$2:$I$4" });
                wb.Workbook.Names.push({ Name: "Exterior", Ref: "'LISTAS'!$J$2:$J$3" });
                
                ws_dados['!cols'] = [ {wch: 2}, {wch: 20}, {wch: 20}, {wch: 35}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 20}, {wch: 20}, {wch: 20}, {wch: 25}];
                XLSX.utils.book_append_sheet(wb, ws_dados, "DADOS");

                XLSX.writeFile(wb, "Planilha_Modelo_Highpar.xlsx");
            };
            
            const processAndUpload = (jsonData, originalFile) => {
                const cleanData = jsonData.map(row => {
                    const rawValue = row.Valor || row.valor || '0';
                    let numericValue;
                    if (typeof rawValue === 'number') {
                        numericValue = rawValue;
                    } else {
                        numericValue = parseFloat(String(rawValue).replace(/\./g, '').replace(',', '.')) || 0;
                    }
                    
                    const vcto = row.Vencimento;
                    let vencimentoValue = '';
                    if (vcto instanceof Date) {
                        vencimentoValue = vcto.toISOString().split('T')[0];
                    } else if (vcto) {
                        vencimentoValue = vcto.toString();
                    }

                    return {
                        "Instituição": row.Instituição || '', 
                        "Número da Conta": row["Número da Conta"] || '',
                        "Nome": row.Nome || '', 
                        "Emissor": row.Emissor || '',
                        "Vencimento": vencimentoValue,
                        "Taxa": row.Taxa || '', 
                        "Liquidez": row.Liquidez || '', 
                        "Valor": numericValue,
                        "Classe": row.Classe || '', 
                        "Subclasse": row.Subclasse || '',
                        "Tipo de Ativo": row["Tipo de Ativo"] || '',
                    }
                }).filter(row => row.Instituição && row.Nome && row.Valor > 0);
                
                if (cleanData.length === 0) {
                    setError("Nenhum dado válido encontrado na planilha. Verifique o preenchimento.");
                    setUploading(false);
                    return;
                }
                
                const storageRef = storage.ref(`portfolios/${client.id}/${originalFile.name}`);
                const uploadTask = storageRef.put(originalFile);

                uploadTask.on('state_changed', 
                  (snapshot) => {}, 
                  (error) => {
                    console.error("Erro no upload para o Storage:", error);
                    setError("Falha ao enviar o arquivo.");
                    setUploading(false);
                  }, 
                  () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                      db.collection("clients").doc(client.id).update({
                        portfolioData: cleanData,
                        lastPortfolioFileUrl: downloadURL,
                        lastUpdate: serverTimestamp()
                      }).then(() => {
                        setUploading(false);
                        setError(null);
                      }).catch((dbError) => {
                        console.error("Erro ao atualizar o Firestore:", dbError);
                        setError("Falha ao salvar os dados.");
                        setUploading(false);
                      });
                    }).catch((urlError) => {
                         console.error("Erro ao obter a URL de download:", urlError);
                         setError("Ocorreu um erro ao finalizar o upload.");
                         setUploading(false);
                    });
                  }
                );
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setUploading(true);
                setError(null);

                if (file.name.endsWith('.csv')) {
                    window.Papa.parse(file, {
                        header: true,
                        skipEmptyLines: 'greedy',
                        complete: (results) => processAndUpload(results.data, file),
                        error: (error) => {
                            setError("Erro ao processar o arquivo CSV.");
                            setUploading(false);
                        }
                    });
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'array', cellDates: true });
                            const worksheet = workbook.Sheets['DADOS'];
                            if (!worksheet) {
                                setError('Aba "DADOS" não encontrada na planilha.');
                                setUploading(false);
                                return;
                            }
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { range: 2 });
                            processAndUpload(jsonData, file);
                        } catch (error) {
                            setError("Erro ao processar o arquivo Excel.");
                            setUploading(false);
                        }
                    };
                    reader.onerror = () => {
                        setError("Erro ao ler o arquivo.");
                        setUploading(false);
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    setError("Formato de arquivo não suportado. Envie .csv ou .xlsx.");
                    setUploading(false);
                }
                event.target.value = null; 
            };

            const handleDownloadLast = () => {
                if (client.lastPortfolioFileUrl) {
                    window.open(client.lastPortfolioFileUrl, '_blank');
                }
            };

            return (
                 <div className="flex flex-col items-end space-y-2">
                     <div className="flex items-center space-x-3">
                         <button onClick={handleDownloadModelo} className="flex items-center text-sm bg-slate-700 text-slate-300 font-semibold px-4 py-2 rounded-lg hover:bg-slate-600 transition-colors">
                             <Icon path={ICONS.DOWNLOAD} className="h-4 w-4 mr-2" />
                             Baixar Modelo
                         </button>
                         {client.lastPortfolioFileUrl && (
                             <button onClick={handleDownloadLast} className="flex items-center text-sm bg-slate-700 text-slate-300 font-semibold px-4 py-2 rounded-lg hover:bg-slate-600 transition-colors">
                                 <Icon path={ICONS.DOWNLOAD} className="h-4 w-4 mr-2" />
                                 Baixar Último Envio
                             </button>
                         )}
                         <input type="file" accept=".csv,.xlsx,.xls" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                         <button onClick={() => fileInputRef.current.click()} disabled={uploading} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors disabled:bg-sky-800">
                             {uploading ? <Loader className="h-5 w-5 mr-2" /> : <Icon path={ICONS.UPLOAD} className="h-5 w-5 mr-2" />}
                             {uploading ? 'Enviando...' : 'Carregar Planilha'}
                         </button>
                     </div>
                     {error && <p className="text-xs text-red-400 text-right">{error}</p>}
                 </div>
            );
        }

        // --- TAB COMPONENTS for ClientDetail ---
        function ConsolidatedView({ analysis, liquidityAnalysis }) {
            const [selectedInstitution, setSelectedInstitution] = useState('Todas');
            const [viewType, setViewType] = useState('estrategia');

            const groupedData = useMemo(() => {
                if (!analysis) return null;
                
                let sourceData;
                if (viewType === 'estrategia') {
                    sourceData = analysis.currentAllocationByClass;
                } else { // tipo
                    sourceData = analysis.allocationByAssetType;
                }

                if (selectedInstitution !== 'Todas') {
                    let filteredPortfolio = analysis.portfolio.filter(p => (p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '')) === selectedInstitution);
                    sourceData = filteredPortfolio.reduce((acc, asset) => {
                        const key = viewType === 'estrategia' 
                            ? asset.Classe + (asset.Subclasse ? ` - ${asset.Subclasse}` : '')
                            : asset['Tipo de Ativo'] || 'Não Especificado';
                        
                        if (!acc[key]) acc[key] = { value: 0, assets: [] };
                        acc[key].value += asset.Valor;
                        acc[key].assets.push(asset);
                        return acc;
                    }, {});
                }

                return Object.entries(sourceData).map(([name, data]) => ({
                    name,
                    value: data.value,
                    percentage: analysis.totalValue > 0 ? data.value / analysis.totalValue : 0,
                    assets: viewType === 'estrategia' 
                        ? analysis.portfolio.filter(p => (p.Classe + (p.Subclasse ? ` - ${p.Subclasse}`: '')) === name)
                        : data.assets
                })).sort((a,b) => b.value - a.value);

            }, [analysis, selectedInstitution, viewType]);
            
            if (!analysis) {
                return <div className="text-center p-10 bg-slate-800 rounded-lg"><h3 className="text-lg text-slate-400">Nenhum portfólio carregado. Por favor, carregue a planilha de ativos.</h3></div>
            }
            
            const totalValue = selectedInstitution === 'Todas' ? analysis.totalValue : (groupedData || []).reduce((acc, item) => acc + item.value, 0);

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-start">
                         <div>
                            <div className="flex items-center space-x-2 bg-slate-800 p-1 rounded-lg mb-2 w-fit">
                                <button onClick={() => setViewType('estrategia')} className={`px-3 py-1 text-xs font-semibold rounded-md ${viewType === 'estrategia' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>Por Estratégia</button>
                                <button onClick={() => setViewType('tipo')} className={`px-3 py-1 text-xs font-semibold rounded-md ${viewType === 'tipo' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>Por Tipo</button>
                            </div>
                            <div className="flex items-center flex-wrap gap-2 bg-slate-800 p-1 rounded-lg">
                                 <button onClick={() => setSelectedInstitution('Todas')} className={`px-4 py-2 text-sm font-semibold rounded-md transition-colors ${selectedInstitution === 'Todas' ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-700'}`}>
                                     Todas as Contas
                                 </button>
                                 {analysis.institutions.map(inst => (
                                     <button key={inst} onClick={() => setSelectedInstitution(inst)} className={`px-4 py-2 text-sm font-semibold rounded-md transition-colors ${selectedInstitution === inst ? 'bg-sky-600 text-white' : 'text-slate-300 hover:bg-slate-600'}`}>
                                         {inst}
                                     </button>
                                 ))}
                            </div>
                        </div>
                        <div className="bg-slate-800 p-4 rounded-lg text-right">
                            <p className="text-sm text-slate-400">Valor Total</p>
                            <p className="text-2xl font-bold text-white">{formatCurrency(totalValue)}</p>
                        </div>
                    </div>

                    <div className="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                       <GroupedAssetTable data={groupedData || []} totalValue={totalValue} title={viewType === 'estrategia' ? 'Classe / Subclasse' : 'Tipo de Ativo'} />
                    </div>

                    {liquidityAnalysis && (
                        <div className="bg-slate-800 rounded-xl shadow-lg p-6">
                            <CssBarChart data={liquidityAnalysis} title="Liquidez da Carteira" />
                        </div>
                    )}
                </div>
            );
        }
        
        const FlatAssetTable = ({ portfolio }) => (
            <table className="w-full text-left">
               <thead className="border-b border-slate-700">
                    <tr>
                        <th className="p-4 text-sm font-semibold text-slate-300">Nome do Ativo</th>
                        <th className="p-4 text-sm font-semibold text-slate-300">Emissor</th>
                        <th className="p-4 text-sm font-semibold text-slate-300">Tipo</th>
                        <th className="p-4 text-sm font-semibold text-slate-300">Classe / Subclasse</th>
                        <th className="p-4 text-sm font-semibold text-slate-300">Vencimento</th>
                        <th className="p-4 text-sm font-semibold text-slate-300">Taxa</th>
                        <th className="p-4 text-sm font-semibold text-slate-300 text-right">Valor</th>
                    </tr>
                </thead>
                <tbody>
                    {portfolio.length > 0 ? portfolio.map((asset, index) => (
                        <tr key={index} className="border-b border-slate-700 last:border-b-0 hover:bg-slate-700/50">
                            <td className="p-4 font-medium text-white">{asset.Nome}</td>
                            <td className="p-4 text-slate-300">{asset.Emissor || 'N/A'}</td>
                            <td className="p-4 text-slate-300">{asset['Tipo de Ativo'] || 'N/A'}</td>
                            <td className="p-4 text-slate-300">{asset.Classe}{asset.Subclasse ? ` - ${asset.Subclasse}` : ''}</td>
                            <td className="p-4 text-slate-300">{formatDisplayDate(asset.Vencimento)}</td>
                            <td className="p-4 text-slate-300">{asset.Taxa || 'N/A'}</td>
                            <td className="p-4 text-slate-300 text-right font-semibold">{formatCurrency(asset.Valor)}</td>
                        </tr>
                    )) : <tr><td colSpan="7" className="p-8 text-center text-slate-400">Nenhum ativo para esta conta.</td></tr>}
                </tbody>
            </table>
        );

        const GroupedAssetTable = ({ data, totalValue, title }) => {
            const [expanded, setExpanded] = useState({});
            const toggle = (className) => setExpanded(prev => ({...prev, [className]: !prev[className]}));

            return (
                <table className="w-full text-left">
                   <thead className="border-b border-slate-700">
                        <tr>
                            <th className="p-4 text-sm font-semibold text-slate-300 w-1/2">{title}</th>
                            <th className="p-4 text-sm font-semibold text-slate-300 text-right">Valor Total</th>
                            <th className="p-4 text-sm font-semibold text-slate-300 text-right">% da Carteira</th>
                        </tr>
                    </thead>
                    <tbody>
                        {data.map(group => (
                            <Fragment key={group.name}>
                                <tr className="border-b border-slate-700 last:border-b-0 hover:bg-slate-700/50 cursor-pointer" onClick={() => toggle(group.name)}>
                                    <td className="p-4 font-medium text-white flex items-center">
                                        <Icon path={expanded[group.name] ? ICONS.CHEVRON_UP : ICONS.CHEVRON_DOWN} className="h-5 w-5 mr-2" />
                                        {group.name}
                                    </td>
                                    <td className="p-4 text-slate-300 text-right font-semibold">{formatCurrency(group.value)}</td>
                                    <td className="p-4 text-slate-300 text-right font-semibold">{formatPercent(group.percentage)}</td>
                                </tr>
                                {expanded[group.name] && (
                                    <tr className="bg-slate-800/50">
                                        <td colSpan="3" className="p-0">
                                            <div className="p-4">
                                                <FlatAssetTable portfolio={group.assets} />
                                            </div>
                                        </td>
                                    </tr>
                                )}
                            </Fragment>
                        ))}
                    </tbody>
                </table>
            );
        };
        
        const SvgPieChart = ({ data, title }) => {
            const COLORS = ['#0ea5e9', '#14b8a6', '#8b5cf6', '#f97316', '#ec4899', '#facc15', '#64748b', '#ef4444', '#22c55e', '#a855f7'];
            const total = data.reduce((sum, item) => sum + item.value, 0);
            if (total === 0) return null;

            let cumulativePercent = 0;
            const segments = data.map((item, index) => {
                const percent = item.value / total;
                const segment = {
                    ...item,
                    percent,
                    angle: percent * 360,
                    startAngle: cumulativePercent * 360,
                    color: COLORS[index % COLORS.length]
                };
                cumulativePercent += percent;
                return segment;
            });

            const radius = 80;
            const circumference = 2 * Math.PI * radius;

            return (
                <div className="bg-slate-800 p-6 rounded-xl flex flex-col h-full">
                    <h3 className="text-xl font-semibold mb-4 text-white text-center">{title}</h3>
                    <div className="flex-grow flex items-center justify-center">
                         <svg viewBox="0 0 200 200" className="w-48 h-48 transform -rotate-90">
                            {segments.map((segment, index) => {
                                const dashArray = `${segment.percent * circumference} ${circumference}`;
                                const rotation = segment.startAngle;
                                return (
                                    <circle
                                        key={index}
                                        r={radius}
                                        cx="100"
                                        cy="100"
                                        fill="transparent"
                                        stroke={segment.color}
                                        strokeWidth="40"
                                        strokeDasharray={dashArray}
                                        transform={`rotate(${rotation} 100 100)`}
                                    >
                                        <title>{`${segment.name}: ${formatCurrency(segment.value)} (${formatPercent(segment.percent)})`}</title>
                                    </circle>
                                );
                            })}
                        </svg>
                    </div>
                    <div className="mt-4 grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                        {segments.map((segment, index) => (
                            <div key={index} className="flex items-center">
                                <div className="w-3 h-3 rounded-sm mr-2" style={{ backgroundColor: segment.color }}></div>
                                <span className="text-slate-300 truncate" title={segment.name}>{segment.name}</span>
                                <span className="ml-auto font-medium text-slate-200">{formatPercent(segment.percent)}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const CssBarChart = ({ data, title }) => {
            const COLORS = ['#0ea5e9', '#14b8a6', '#8b5cf6', '#f97316', '#ec4899', '#facc15', '#64748b', '#ef4444', '#22c55e', '#a855f7'];
            if (!data || data.length === 0) return null;
            const maxValue = Math.max(...data.map(item => item.value));
            if (maxValue === 0) return null;

            return (
                 <div className="bg-slate-800 p-6 rounded-xl">
                    <h3 className="text-xl font-semibold mb-4 text-white">{title}</h3>
                    <div className="space-y-3">
                        {data.map((item, index) => (
                            <div key={index} className="grid grid-cols-4 gap-4 items-center group">
                                <span className="col-span-1 text-sm text-slate-300 truncate" title={item.name}>{item.name}</span>
                                <div className="col-span-3">
                                    <div className="flex items-center">
                                        <div className="w-full bg-slate-700 rounded-full h-4">
                                            <div
                                                className="h-4 rounded-full transition-all duration-500"
                                                style={{ 
                                                    width: `${(item.value / maxValue) * 100}%`,
                                                    backgroundColor: COLORS[index % COLORS.length]
                                                }}
                                            ></div>
                                        </div>
                                        <span className="ml-3 text-sm font-semibold text-white w-28 text-right">{formatCurrency(item.value)}</span>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        function ComparisonView({ analysis, profile }) {
            const comparisonData = useMemo(() => {
                if (!analysis || !profile || !profile.allocations) return null;

                const { totalValue, currentAllocationByClass } = analysis;
                
                const recommendedAllocationMap = profile.allocations.reduce((acc, alloc) => {
                    if ((alloc.subcategories || []).length > 0) {
                        alloc.subcategories.forEach(sub => {
                            const key = alloc.Classe + (sub.name ? ` - ${sub.name}` : '');
                            const normalizedKey = normalizeString(key);
                            acc[normalizedKey] = {
                                originalName: key,
                                value: (sub.percentage / 100) * totalValue,
                                percentage: sub.percentage / 100
                            };
                        });
                    } else {
                        const key = alloc.Classe;
                        const normalizedKey = normalizeString(key);
                        if(normalizedKey){
                            acc[normalizedKey] = {
                                originalName: key,
                                value: (alloc.percentage / 100) * totalValue,
                                percentage: alloc.percentage / 100
                            };
                        }
                    }
                    return acc;
                }, {});

                const currentAllocationMap = Object.keys(currentAllocationByClass).reduce((acc, key) => {
                    const normalizedKey = normalizeString(key);
                    acc[normalizedKey] = {
                        originalName: key,
                        ...currentAllocationByClass[key]
                    };
                    return acc;
                }, {});

                const allNormalizedClasses = [...new Set([...Object.keys(currentAllocationMap), ...Object.keys(recommendedAllocationMap)])];
                
                const comparison = allNormalizedClasses.map(normalizedClass => {
                    const current = currentAllocationMap[normalizedClass] || { value: 0, percentage: 0 };
                    const recommended = recommendedAllocationMap[normalizedClass] || { value: 0, percentage: 0 };
                    
                    return {
                        name: current.originalName || recommended.originalName || normalizedClass,
                        currentValue: current.value,
                        recommendedValue: recommended.value,
                        currentPercent: current.percentage,
                        recommendedPercent: recommended.percentage,
                        diffValue: current.value - recommended.value,
                    };
                }).sort((a,b) => b.recommendedValue - a.recommendedValue)
                  .filter(item => item.recommendedPercent > 0 || item.currentPercent > 0);
                
                const institutionalData = analysis.portfolio.reduce((acc, asset) => {
                    const account = asset.Instituição + (asset["Número da Conta"] ? ` - ${asset["Número da Conta"]}` : '');
                    if (!acc[account]) acc[account] = 0;
                    acc[account] += asset.Valor;
                    return acc;
                }, {});
                
                const currentByClassForChart = Object.entries(analysis.portfolio.reduce((acc, asset) => {
                    const key = asset.Classe;
                    if(!acc[key]) acc[key] = 0;
                    acc[key] += asset.Valor;
                    return acc;
                }, {})).map(([name, value]) => ({name, value}));

                const recommendedChartData = profile.allocations.reduce((acc, alloc) => {
                    const key = alloc.Classe;
                    const value = (alloc.percentage / 100) * totalValue;
                    if(!acc[key]) {
                        acc[key] = { name: key, value: 0};
                    }
                    acc[key].value += value;
                    return acc;
                }, {});


                return {
                    comparison,
                    currentChartData: currentByClassForChart,
                    recommendedChartData: Object.values(recommendedChartData).filter(d => d.value > 0),
                    institutionalChartData: Object.entries(institutionalData).map(([name, value]) => ({ name, value })).filter(d => d.value > 0)
                };
            }, [analysis, profile]);
        
            if (!comparisonData) {
                return (
                    <div className="text-center p-10 bg-slate-800 rounded-lg">
                        <h3 className="text-lg text-slate-400">Dados insuficientes para comparação.</h3>
                        <p className="text-slate-500 mt-2">Carregue um portfólio e defina um perfil para o cliente.</p>
                    </div>
                );
            }

            return (
                <div className="space-y-8">
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <SvgPieChart data={comparisonData.currentChartData} title="Carteira Atual" />
                        <SvgPieChart data={comparisonData.recommendedChartData} title="Carteira Recomendada" />
                    </div>
                    
                    <div className="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                        <h3 className="text-xl font-semibold text-white p-4">Análise de Enquadramento</h3>
                        <table className="w-full text-left">
                           <thead className="border-b border-slate-700">
                                <tr>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Classe / Subclasse</th>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Alocação</th>
                                    <th className="p-4 text-sm font-semibold text-slate-300 text-right">Diferença (R$)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {comparisonData.comparison.map((item, index) => (
                                    <tr key={index} className="border-b border-slate-700 last:border-b-0">
                                        <td className="p-4 font-medium text-white">{item.name}</td>
                                        <td className="p-4 text-slate-300 w-1/2">
                                            <div className="space-y-1">
                                                <div className="flex justify-between text-xs">
                                                    <span className="font-semibold text-white">Atual: {formatPercent(item.currentPercent)}</span>
                                                    <span className="text-slate-400">Rec: {formatPercent(item.recommendedPercent)}</span>
                                                </div>
                                                <div className="w-full bg-slate-700 rounded-full h-2.5">
                                                    <div className="bg-sky-500 h-2.5 rounded-full" style={{ width: `${Math.min(item.currentPercent * 100, 100)}%` }}></div>
                                                    <div className="border-l-2 border-white h-4 -mt-3" style={{ marginLeft: `${item.recommendedPercent * 100}%` }}></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td className={`p-4 text-right font-semibold ${item.diffValue > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                            {item.diffValue > 0 ? 'Resgatar ' : 'Aplicar '} {formatCurrency(Math.abs(item.diffValue))}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    <CssBarChart data={comparisonData.institutionalChartData} title="Valor por Instituição" />
                </div>
            );
        }

        function RebalanceWorkspace({ analysis, profile, redemptions, setRedemptions, applications, setApplications, recommendedAssets, totalAppliedPerClass, observations, setObservations, onSaveObservations, saveStatus }) {

            const movements = useMemo(() => {
                if (!analysis || !profile || !profile.allocations) return null;
                const { totalValue, currentAllocationByClass } = analysis;

                const recommendedAllocationMap = profile.allocations.reduce((acc, alloc) => {
                    if ((alloc.subcategories || []).length > 0) {
                        alloc.subcategories.forEach(sub => {
                            const key = alloc.Classe + (sub.name ? ` - ${sub.name}` : '');
                            const normalizedKey = normalizeString(key);
                            acc[normalizedKey] = {
                                originalName: key,
                                value: (sub.percentage / 100) * totalValue
                            };
                        });
                    } else {
                        const key = alloc.Classe;
                        const normalizedKey = normalizeString(key);
                         if(normalizedKey){
                            acc[normalizedKey] = {
                                originalName: key,
                                value: (alloc.percentage / 100) * totalValue
                            };
                        }
                    }
                    return acc;
                }, {});
                
                const currentAllocationMap = Object.keys(currentAllocationByClass).reduce((acc, key) => {
                    const normalizedKey = normalizeString(key);
                    acc[normalizedKey] = {
                        originalName: key,
                        value: currentAllocationByClass[key].value
                    };
                    return acc;
                }, {});

                const allKeys = [...new Set([...Object.keys(currentAllocationMap), ...Object.keys(recommendedAllocationMap)])];
                const diffs = {};

                allKeys.forEach(normalizedKey => {
                    const current = currentAllocationMap[normalizedKey] || { value: 0 };
                    const recommended = recommendedAllocationMap[normalizedKey] || { value: 0 };
                    const diff = current.value - recommended.value;
                    const originalName = current.originalName || recommended.originalName;
                    if (Math.abs(diff) > 1) {
                      diffs[originalName] = diff;
                    }
                });

                return {
                    toRedeem: Object.entries(diffs).filter(([, val]) => val > 0).reduce((acc, [key, val]) => ({...acc, [key]: val }), {}),
                    toApply: Object.entries(diffs).filter(([, val]) => val < 0).reduce((acc, [key, val]) => ({...acc, [key]: Math.abs(val) }), {}),
                };
            }, [analysis, profile]);

            const applicationTimeline = useMemo(() => {
                const parseLiquidity = (liqStr) => {
                    if (!liqStr) return 2; // Default D+2
                    const match = String(liqStr).match(/\d+/);
                    return match ? parseInt(match[0], 10) : 2;
                };

                const cashByDate = {}; // e.g., { 2: 1000, 30: 5000 }
                Object.values(redemptions).forEach(({ asset, amount }) => {
                    const days = parseLiquidity(asset.Liquidez);
                    cashByDate[days] = (cashByDate[days] || 0) + amount;
                });

                const totalToApply = Object.values(movements.toApply || {}).reduce((sum, val) => sum + val, 0);
                let appliedSoFar = Object.values(applications || {}).flat().reduce((sum, app) => sum + app.value, 0);

                const timeline = [];
                let cumulativeCash = 0;
                let lastDayCashUsed = 0;

                Object.keys(cashByDate).sort((a, b) => a - b).forEach(day => {
                    cumulativeCash += cashByDate[day];
                    const remainingToApply = totalToApply - appliedSoFar;
                    const cashAvailableInPeriod = cumulativeCash - lastDayCashUsed;
                    const canApply = Math.min(cashAvailableInPeriod, remainingToApply);

                    if (canApply > 1) {
                        timeline.push({ day, amount: canApply });
                        lastDayCashUsed += canApply;
                    }
                });

                return { timeline, totalToApply };
            }, [redemptions, movements, applications]);

            const handleRedemptionChange = (asset, value) => {
                const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                const amount = Math.min(parseFloat(value) || 0, asset.Valor);
                
                if (amount === 0) {
                    const newRedemptions = { ...redemptions };
                    delete newRedemptions[assetId];
                    setRedemptions(newRedemptions);
                } else {
                    setRedemptions(prev => ({
                        ...prev,
                        [assetId]: { amount, asset }
                    }));
                }
            };
            
            const handleAddApplication = (institution, newApp) => {
                 setApplications(prev => ({
                     ...prev,
                     [institution]: [...(prev[institution] || []), newApp]
                 }))
            };
            
            const handleDeleteApplication = (institution, index) => {
                setApplications(prev => ({
                    ...prev,
                    [institution]: prev[institution].filter((_, i) => i !== index)
                }));
            }

            if (!analysis || !movements) {
                return <div className="text-center p-10 bg-slate-800 rounded-lg"><h3 className="text-lg text-slate-400">Dados insuficientes para gerar sugestões de rebalanceamento.</h3></div>;
            }

            return (
                <div className="space-y-8">
                    <div className="bg-slate-800 p-6 rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold text-white mb-4">Observações sobre o Plano</h2>
                        <textarea
                            className="w-full h-32 p-3 bg-slate-700 border border-slate-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-sky-500"
                            placeholder="Descreva a estratégia, os motivos das movimentações e outros pontos importantes para o cliente..."
                            value={observations}
                            onChange={(e) => setObservations(e.target.value)}
                        ></textarea>
                        <div className="text-right mt-4 flex justify-end items-center">
                            {saveStatus && <span className={`mr-4 text-sm ${saveStatus === 'Erro!' ? 'text-red-400' : 'text-green-400'}`}>{saveStatus}</span>}
                            <button
                                onClick={onSaveObservations}
                                className="bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors disabled:opacity-50"
                                disabled={saveStatus === 'Salvando...'}
                            >
                                {saveStatus === 'Salvando...' ? 'Salvando...' : 'Salvar Observações'}
                            </button>
                        </div>
                    </div>
                    
                    {(applicationTimeline.timeline.length > 0 || applicationTimeline.totalToApply > 0) && (
                        <div className="bg-slate-800 p-6 rounded-xl shadow-lg">
                            <h2 className="text-2xl font-bold text-white mb-4">Plano de Aplicação por Prazo</h2>
                            <div className="space-y-2 text-slate-300">
                                {applicationTimeline.timeline.map(item => (
                                    <div key={item.day} className="flex justify-between items-center p-2 bg-slate-700/50 rounded">
                                        <span>Em até <span className="font-bold text-white">{item.day} dias</span> (D+{item.day}), aplicar:</span>
                                        <span className="font-bold text-green-400">{formatCurrency(item.amount)}</span>
                                    </div>
                                ))}
                                 <div className="flex justify-between items-center p-2 border-t border-slate-600 font-bold">
                                    <span className="text-white">Total Previsto para Aplicação:</span>
                                    <span className="text-green-300">{formatCurrency(applicationTimeline.totalToApply)}</span>
                                </div>
                            </div>
                        </div>
                    )}


                    {analysis.institutions.map(institution => (
                        <InstitutionRebalanceBlock 
                            key={institution}
                            institution={institution}
                            portfolio={analysis.portfolio}
                            movements={movements}
                            redemptions={redemptions}
                            onRedemptionChange={handleRedemptionChange}
                            applications={applications}
                            onAddApplication={handleAddApplication}
                            onDeleteApplication={handleDeleteApplication}
                            recommendedAssets={recommendedAssets}
                            totalAppliedPerClass={totalAppliedPerClass}
                        />
                    ))}
                </div>
            );
        }

        function InstitutionRebalanceBlock({ institution, portfolio, movements, redemptions, onRedemptionChange, applications, onAddApplication, onDeleteApplication, recommendedAssets, totalAppliedPerClass }) {
            
            const totalRedeemedInAccount = useMemo(() => {
                return Object.values(redemptions)
                    .filter(({ asset }) => (asset.Instituição + (asset["Número da Conta"] ? ` - ${asset["Número da Conta"]}` : '')) === institution)
                    .reduce((sum, { amount }) => sum + amount, 0);
            }, [redemptions, institution]);

            const totalAppliedInAccount = useMemo(() => {
                return (applications[institution] || []).reduce((sum, app) => sum + app.value, 0);
            }, [applications, institution]);
            
            const availableCash = totalRedeemedInAccount - totalAppliedInAccount;
            
            const AssetDetailRow = ({asset}) => (
                <div className="text-xs text-slate-400 grid grid-cols-3 gap-x-2">
                    <span>Vcto: {formatDisplayDate(asset.Vencimento)}</span>
                    <span>Taxa: {asset.Taxa || 'N/A'}</span>
                    <span>Liq.: {asset.Liquidez || 'N/A'}</span>
                </div>
            );
            
            const totalRedeemedPerClass = useMemo(() => {
                return Object.values(redemptions).reduce((acc, { asset, amount }) => {
                    const classKey = asset.Classe + (asset.Subclasse ? ` - ${asset.Subclasse}` : '');
                    if(!acc[classKey]) acc[classKey] = 0;
                    acc[classKey] += amount;
                    return acc;
                }, {});
            }, [redemptions]);


            return (
                <div className="bg-slate-800 p-6 rounded-xl shadow-lg">
                    <h2 className="text-2xl font-bold text-white mb-2">{institution}</h2>
                    <div className="grid grid-cols-3 gap-4 mb-6 text-center">
                        <div className="bg-slate-700/50 p-3 rounded-lg"><p className="text-sm text-slate-400">Total Resgatado</p><p className="text-lg font-semibold text-red-400">{formatCurrency(totalRedeemedInAccount)}</p></div>
                        <div className="bg-slate-700/50 p-3 rounded-lg"><p className="text-sm text-slate-400">Total Aplicado</p><p className="text-lg font-semibold text-green-400">{formatCurrency(totalAppliedInAccount)}</p></div>
                        <div className="bg-slate-700/50 p-3 rounded-lg"><p className="text-sm text-slate-400">Caixa Disponível</p><p className="text-lg font-semibold text-sky-400">{formatCurrency(availableCash)}</p></div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {/* Redemption Section */}
                        <div className="space-y-4">
                            <h3 className="text-xl font-semibold text-red-400 border-b border-slate-700 pb-2">Sugestões de Resgate</h3>
                             {Object.entries(movements.toRedeem).map(([assetClass, amount]) => {
                                 const assetsInClassAndAccount = portfolio.filter(p => (p.Classe + (p.Subclasse ? ` - ${p.Subclasse}`: '')) === assetClass && (p.Instituição + (p["Número da Conta"] ? ` - ${p["Número da Conta"]}` : '')) === institution);
                                 if (assetsInClassAndAccount.length === 0) return null;

                                 const redeemedInClass = totalRedeemedPerClass[assetClass] || 0;
                                 const remainingToRedeem = amount - redeemedInClass;
                                 
                                 return (
                                     <div key={assetClass} className="bg-slate-700/50 p-3 rounded-lg">
                                         <div className="flex justify-between items-center mb-2">
                                             <h4 className="font-semibold text-white">{assetClass}</h4>
                                             <span className="text-sm text-red-400 font-bold">Falta Resgatar ~{formatCurrency(remainingToRedeem > 0 ? remainingToRedeem : 0)}</span>
                                         </div>
                                         {assetsInClassAndAccount.map((asset) => {
                                             const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                                             return (
                                                 <div key={assetId} className="space-y-2 py-2 border-b border-slate-600 last:border-b-0">
                                                     <div className="flex items-center justify-between space-x-2">
                                                         <div className="text-sm text-slate-300 flex-1 min-w-0">
                                                             <p className="truncate font-semibold" title={asset.Nome}>{asset.Nome}</p>
                                                             <p className="text-xs text-slate-400">Disponível: {formatCurrency(asset.Valor)}</p>
                                                         </div>
                                                         <div className="flex items-center space-x-2 flex-shrink-0">
                                                             <input 
                                                                 type="text" 
                                                                 placeholder="R$ 0,00"
                                                                 value={redemptions[assetId] ? formatCurrency(redemptions[assetId].amount).replace('R$\u00A0', '') : ''}
                                                                 onChange={(e) => {
                                                                     const val = e.target.value.replace(/\D/g, '');
                                                                     onRedemptionChange(asset, val / 100);
                                                                 }}
                                                                 className="w-28 px-2 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm text-right focus:ring-2 focus:ring-sky-500 focus:outline-none"
                                                             />
                                                             <button type="button" onClick={() => onRedemptionChange(asset, asset.Valor)} className="text-xs bg-sky-600 hover:bg-sky-700 text-white font-semibold px-2 py-1 rounded-md">Total</button>
                                                         </div>
                                                     </div>
                                                     <AssetDetailRow asset={asset} />
                                                 </div>
                                             )
                                         })}
                                     </div>
                                 )
                             })}
                        </div>
                        {/* Application Section */}
                        <div className="space-y-4">
                            <h3 className="text-xl font-semibold text-green-400 border-b border-slate-700 pb-2">Sugestões de Aplicação</h3>
                             {Object.entries(movements.toApply).map(([assetClass, amount]) => {
                                const appliedSoFar = totalAppliedPerClass[assetClass] || 0;
                                const remainingToApply = amount - appliedSoFar;

                                if (remainingToApply <= 1) return null;

                                return (
                                 <div key={assetClass} className="bg-slate-700/50 p-3 rounded-lg">
                                     <div className="flex justify-between items-center mb-2">
                                         <h4 className="font-semibold text-white">{assetClass}</h4>
                                         <span className="text-sm text-green-400 font-bold">Falta Aplicar ~{formatCurrency(remainingToApply)}</span>
                                     </div>
                                     {(applications[institution] || []).filter(app => app.Classe === assetClass).map((app, index) => (
                                         <div key={index} className="flex items-center justify-between bg-slate-600/50 p-2 rounded mb-2">
                                             <div>
                                                 <p className="text-sm font-semibold">{app.name}</p>
                                                 <p className="text-xs text-slate-300">{formatCurrency(app.value)}</p>
                                             </div>
                                             <button onClick={() => handleDeleteApplication(institution, index)} className="text-red-400 hover:text-red-300"><Icon path={ICONS.TRASH} className="h-4 w-4" /></button>
                                         </div>
                                     ))}
                                     <AddApplicationForm 
                                         assetClass={assetClass} 
                                         institution={institution}
                                         availableCash={availableCash}
                                         onAddApplication={onAddApplication}
                                         recommendedAssets={recommendedAssets}
                                     />
                                 </div>
                                )
                             })}
                        </div>
                    </div>
                </div>
            )
        }
        
        function AddApplicationForm({ assetClass, institution, availableCash, onAddApplication, recommendedAssets }) {
            const [selectedAsset, setSelectedAsset] = useState('');
            const [customAssetName, setCustomAssetName] = useState('');
            const [value, setValue] = useState('');
            const [error, setError] = useState('');
        
            const handleSubmit = (e) => {
                e.preventDefault();
                const numValue = parseFloat(value.replace(/\D/g, '')) / 100;
                const assetName = selectedAsset === 'custom' ? customAssetName : selectedAsset;
        
                if (!assetName || !numValue || numValue <= 0) {
                    setError('Preencha nome e valor válidos.');
                    return;
                }
                if (numValue > availableCash) {
                    setError(`Valor excede o caixa disponível (${formatCurrency(availableCash)}).`);
                    return;
                }
                
                onAddApplication(institution, { name: assetName, value: numValue, Classe: assetClass });
                setSelectedAsset('');
                setCustomAssetName('');
                setValue('');
                setError('');
            };
        
            const handleValueChange = (e) => {
                const val = e.target.value.replace(/\D/g, '');
                const num = parseFloat(val) / 100;
                if (isNaN(num) || num === 0) {
                    setValue('');
                } else {
                    setValue(formatCurrency(num).replace('R$\u00A0', ''));
                }
            };

            const filteredRecommendedAssets = useMemo(() => {
                const [mainClass, subClass] = assetClass.split(' - ');
                const institutionName = institution.split(' - ')[0];

                return recommendedAssets.filter(asset => 
                    normalizeString(asset.class) === normalizeString(mainClass) &&
                    (!subClass || normalizeString(asset.subclass) === normalizeString(subClass)) &&
                    (asset.institutions || []).includes(institutionName)
                );
            }, [recommendedAssets, assetClass, institution]);
        
            return (
                <form onSubmit={handleSubmit} className="space-y-2 mt-2">
                    <div className="flex flex-col space-y-2">
                        <select
                            value={selectedAsset}
                            onChange={(e) => setSelectedAsset(e.target.value)}
                            className="w-full px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm"
                        >
                            <option value="">Selecione um ativo recomendado...</option>
                            {filteredRecommendedAssets.map(asset => (
                                <option key={asset.id} value={asset.name}>{asset.name}</option>
                            ))}
                            <option value="custom">-- Outro Ativo --</option>
                        </select>

                        {selectedAsset === 'custom' && (
                             <input 
                                type="text" 
                                placeholder="Nome do Ativo Personalizado" 
                                value={customAssetName}
                                onChange={e => setCustomAssetName(e.target.value)}
                                className="w-full px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm"
                            />
                        )}

                        <div className="flex space-x-2">
                           <input 
                                type="text"
                                placeholder="R$ 0,00" 
                                value={value}
                                onChange={handleValueChange}
                                className="flex-1 px-2 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm text-right"
                            />
                           <button type="submit" className="p-2 bg-sky-600 rounded-lg hover:bg-sky-500"><Icon path={ICONS.PLUS} className="h-4 w-4"/></button>
                        </div>
                    </div>
                    {error && <p className="text-xs text-red-400">{error}</p>}
                </form>
            );
        }

        function ConfirmModal({ title, message, onConfirm, onCancel }) {
            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                    <div className="bg-slate-800 rounded-xl shadow-2xl p-8 w-full max-w-md">
                        <h2 className="text-xl font-bold text-white mb-4">{title}</h2>
                        <p className="text-slate-300 mb-6">{message}</p>
                        <div className="flex justify-end pt-4 space-x-3">
                            <button type="button" onClick={onCancel} className="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">
                                Cancelar
                            </button>
                            <button type="button" onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700">
                                Excluir
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Settings Page and Components ---
        function SettingsPage() {
            const [activeTab, setActiveTab] = useState('profiles');
            return(
                <div>
                     <div className="flex justify-between items-center mb-6">
                         <h1 className="text-3xl font-bold text-white">Configurações</h1>
                     </div>
                     <div className="flex border-b border-slate-700 mb-6">
                         <TabButton name="Perfis de Investidor" id="profiles" activeTab={activeTab} setActiveTab={setActiveTab} />
                         <TabButton name="Ativos Recomendados" id="assets" activeTab={activeTab} setActiveTab={setActiveTab} />
                         <TabButton name="Classes de Ativos" id="classes" activeTab={activeTab} setActiveTab={setActiveTab} />
                     </div>
                     {activeTab === 'profiles' && <ProfilesSettings />}
                     {activeTab === 'assets' && <RecommendedAssetsSettings />}
                     {activeTab === 'classes' && <ClassesSettings />}
                </div>
            )
        }

        function ProfilesSettings() {
            const [profiles, setProfiles] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingProfile, setEditingProfile] = useState(null);
            const [confirmingDelete, setConfirmingDelete] = useState(null);
            const [assetClasses, setAssetClasses] = useState([]);
            const [refreshTrigger, setRefreshTrigger] = useState(0);

            useEffect(() => {
                const fetchData = async () => {
                    setLoading(true);
                    try {
                        const profilesSnapshot = await db.collection('profiles').get();
                        const profilesData = profilesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setProfiles(profilesData);

                        const classesSnapshot = await db.collection('assetClasses').get();
                        const classesData = classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setAssetClasses(classesData);
                    } catch (error) {
                        console.error("Error fetching data for ProfilesSettings:", error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [refreshTrigger]);

            const openEditModal = (profile) => {
                setEditingProfile(profile);
                setIsModalOpen(true);
            }

            const openNewModal = () => {
                setEditingProfile(null);
                setIsModalOpen(true);
            }
            
            const openDeleteConfirmation = (profile) => {
                setConfirmingDelete(profile);
            };

            const handleConfirmDelete = async () => {
                if (confirmingDelete) {
                    await db.collection("profiles").doc(confirmingDelete.id).delete();
                    setConfirmingDelete(null);
                    setRefreshTrigger(t => t + 1);
                }
            };

            return (
                <div>
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-300">Gerenciar Perfis de Investidor</h2>
                        <button onClick={openNewModal} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors">
                            <Icon path={ICONS.PLUS} className="h-5 w-5 mr-2" />
                            Novo Perfil
                        </button>
                    </div>

                    <div className="space-y-4">
                        {loading ? <p>Carregando perfis...</p> : profiles.map(profile => (
                            <div key={profile.id} className="bg-slate-800 p-4 rounded-lg">
                                <div className="flex justify-between items-start">
                                    <h3 className="text-lg font-semibold text-white">{profile.name}</h3>
                                    <div className="flex items-center space-x-3">
                                        <button onClick={() => openEditModal(profile)} className="text-sky-400 hover:text-sky-300"><Icon path={ICONS.EDIT} className="h-5 w-5" /></button>
                                        <button onClick={() => openDeleteConfirmation(profile)} className="text-red-400 hover:text-red-300"><Icon path={ICONS.TRASH} className="h-5 w-5" /></button>
                                    </div>
                                </div>
                                <div className="mt-2 space-y-1">
                                    {profile.allocations?.map((alloc, i) => (
                                        <div key={i} className="bg-slate-700/50 p-2 rounded-md">
                                            <div className="flex justify-between">
                                                <span className="text-sm text-slate-200 font-semibold">{alloc.Classe}</span>
                                                <span className="text-sm text-slate-200 font-bold">{alloc.percentage}%</span>
                                            </div>
                                            {alloc.subcategories && alloc.subcategories.length > 0 && (
                                                <div className="pl-4 mt-1 border-l-2 border-slate-600">
                                                    {alloc.subcategories.map((sub, j) => (
                                                        <div key={j} className="flex justify-between text-xs text-slate-400">
                                                            <span>- {sub.name}</span>
                                                            <span>{sub.percentage}%</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        ))}
                    </div>
                    {isModalOpen && <ProfileModal profile={editingProfile} assetClasses={assetClasses} onClose={() => { setIsModalOpen(false); setRefreshTrigger(t => t + 1); }} />}
                    {confirmingDelete && (
                        <ConfirmModal
                            title="Confirmar Exclusão"
                            message={`Tem certeza que deseja excluir o perfil "${confirmingDelete.name}"? Esta ação não pode ser desfeita.`}
                            onConfirm={handleConfirmDelete}
                            onCancel={() => setConfirmingDelete(null)}
                        />
                    )}
                </div>
            );
        }

        function ProfileModal({ profile, onClose, assetClasses }) {
            const initialAllocations = profile 
                ? profile.allocations.map(a => ({
                    ...a,
                    Classe: a.Classe || a.class, // Handle both old and new format
                    class: undefined,
                    subcategories: a.subcategories || [], 
                    id: Math.random()
                })) 
                : [{ Classe: '', percentage: '', subcategories: [], id: Date.now() }];

            const [name, setName] = useState(profile ? profile.name : '');
            const [allocations, setAllocations] = useState(initialAllocations);
            const [loading, setLoading] = useState(false);

            const handleAllocationChange = (id, field, value) => {
                const newAllocations = allocations.map(alloc => {
                    if (alloc.id === id) {
                         if (field === 'percentage') {
                            return { ...alloc, [field]: value === '' ? '' : Math.max(0, Math.min(100, Number(value))) };
                         }
                         return { ...alloc, [field]: value };
                    }
                    return alloc;
                });
                setAllocations(newAllocations);
            };

            const addAllocation = () => setAllocations([...allocations, { Classe: '', percentage: '', subcategories: [], id: Date.now() }]);
            const removeAllocation = (id) => setAllocations(allocations.filter((a) => a.id !== id));

            const handleSubcategoryChange = (classId, subIndex, field, value) => {
                const newAllocations = allocations.map(alloc => {
                    if (alloc.id === classId) {
                        const newSubcategories = [...alloc.subcategories];
                        newSubcategories[subIndex] = { 
                            ...newSubcategories[subIndex], 
                            [field]: field === 'percentage' ? (value === '' ? '' : Math.max(0, Number(value))) : value
                        };
                        return {...alloc, subcategories: newSubcategories};
                    }
                    return alloc;
                });
                setAllocations(newAllocations);
            };

            const addSubcategory = (classId) => {
                const newAllocations = allocations.map(alloc => {
                    if (alloc.id === classId) {
                        const newSubcategories = [...(alloc.subcategories || []), { name: '', percentage: '' }];
                        return {...alloc, subcategories: newSubcategories};
                    }
                    return alloc;
                });
                setAllocations(newAllocations);
            };

            const removeSubcategory = (classId, subIndex) => {
                const newAllocations = allocations.map(alloc => {
                    if (alloc.id === classId) {
                      const newSubcategories = alloc.subcategories.filter((_, i) => i !== subIndex);
                      return {...alloc, subcategories: newSubcategories};
                    }
                    return alloc;
                });
                setAllocations(newAllocations);
            };

            const totalPercentage = allocations.reduce((sum, alloc) => sum + (Number(alloc.percentage) || 0), 0);

            const handleSubmit = async (e) => {
                e.preventDefault();

                if (totalPercentage > 100) {
                    alert("A alocação total não pode exceder 100%.");
                    return;
                }

                setLoading(true);
                const data = { 
                    name, 
                    allocations: allocations.map(({ id, ...alloc }) => ({
                        Classe: alloc.Classe,
                        percentage: Number(alloc.percentage) || 0,
                        subcategories: (alloc.subcategories || []).map(sub => ({
                            ...sub,
                             percentage: Number(sub.percentage) || 0,
                        })).filter(sub => sub.name && sub.percentage >= 0)
                    })).filter(a => a.Classe && a.percentage >= 0)
                };

                if (profile) {
                    await db.collection('profiles').doc(profile.id).update(data);
                } else {
                    await db.collection('profiles').add(data);
                }
                setLoading(false);
                onClose();
            };
            
            return (
                 <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                     <div className="bg-slate-800 rounded-xl shadow-2xl p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                         <h2 className="text-2xl font-bold text-white mb-6">{profile ? 'Editar Perfil' : 'Novo Perfil'}</h2>
                         <form onSubmit={handleSubmit} className="space-y-4">
                             <input type="text" placeholder="Nome do Perfil" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white" required />
                             
                             <h3 className="text-lg font-semibold text-white pt-2">Alocações</h3>
                             <div className="flex justify-between items-center bg-slate-900 p-3 rounded-lg sticky top-0 z-10">
                                 <span className="text-sm font-semibold text-slate-300">Total Alocado:</span>
                                 <span className={`font-bold text-lg ${totalPercentage > 100 ? 'text-red-400' : 'text-green-400'}`}>
                                     {totalPercentage}% / 100%
                                 </span>
                             </div>

                             {allocations.map((alloc, index) => {
                                 const totalSubPercentage = (alloc.subcategories || []).reduce((sum, sub) => sum + (Number(sub.percentage) || 0), 0);
                                 const classPercentage = Number(alloc.percentage) || 0;
                                 const subTotalMismatch = (alloc.subcategories || []).length > 0 && totalSubPercentage !== classPercentage;
                                 return (
                                 <div key={alloc.id} className="bg-slate-700/50 p-4 rounded-lg space-y-3">
                                     <div className="flex items-center space-x-2">
                                         <select 
                                             value={alloc.Classe} 
                                             onChange={e => handleAllocationChange(alloc.id, 'Classe', e.target.value)} 
                                             className="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white"
                                         >
                                             <option value="">Selecione a Classe</option>
                                             {assetClasses.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                                         </select>
                                         <input type="number" placeholder="%" min="0" max="100" value={alloc.percentage} onChange={e => handleAllocationChange(alloc.id, 'percentage', e.target.value)} className="w-24 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white" />
                                         <button type="button" onClick={() => removeAllocation(alloc.id)} className="text-red-400 hover:text-red-300 p-2"><Icon path={ICONS.TRASH} className="h-5 w-5" /></button>
                                     </div>
                                     
                                     <div className="pl-6 pt-2 border-l-2 border-slate-600 ml-2 space-y-2">
                                         {(alloc.subcategories || []).map((sub, subIndex) => (
                                             <div key={subIndex} className="flex items-center space-x-2">
                                                 <input type="text" placeholder="Subcategoria" value={sub.name} onChange={e => handleSubcategoryChange(alloc.id, subIndex, 'name', e.target.value)} className="flex-1 px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm" />
                                                 <input type="number" placeholder="%" min="0" value={sub.percentage} onChange={e => handleSubcategoryChange(alloc.id, subIndex, 'percentage', e.target.value)} className="w-20 px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm" />
                                                 <button type="button" onClick={() => removeSubcategory(alloc.id, subIndex)} className="text-red-500 hover:text-red-400 p-1"><Icon path={ICONS.TRASH} className="h-4 w-4" /></button>
                                             </div>
                                         ))}
                                         <button type="button" onClick={() => addSubcategory(alloc.id)} className="text-sky-400 text-xs font-semibold flex items-center pt-1"><Icon path={ICONS.PLUS} className="h-3 w-3 mr-1"/>Adicionar Subcategoria</button>
                                     </div>
                                     
                                     {subTotalMismatch && (
                                         <div className="pl-6 text-yellow-400 text-xs mt-1">
                                             A soma das subcategorias ({totalSubPercentage}%) não corresponde ao total da classe ({classPercentage}%).
                                         </div>
                                    )}
                                 </div>
                             )})}
                             <button type="button" onClick={addAllocation} className="text-sky-400 font-semibold text-sm flex items-center"><Icon path={ICONS.PLUS} className="h-4 w-4 mr-1"/>Adicionar Classe</button>
                             
                             <div className="flex justify-end pt-4 space-x-3">
                                 <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">Cancelar</button>
                                 <button type="submit" disabled={loading} className="px-4 py-2 bg-sky-600 rounded-lg hover:bg-sky-700 disabled:bg-sky-800 flex items-center">
                                     {loading && <Loader className="h-5 w-5 mr-2" />}
                                     Salvar
                                 </button>
                             </div>
                         </form>
                     </div>
                 </div>
            )
        }

        // --- Recommended Assets Components (NEW) ---
        function RecommendedAssetsSettings() {
            const [assets, setAssets] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingAsset, setEditingAsset] = useState(null);
            const [confirmingDelete, setConfirmingDelete] = useState(null);
            const [assetClasses, setAssetClasses] = useState([]);
            const [refreshTrigger, setRefreshTrigger] = useState(0);

            useEffect(() => {
                setLoading(true);
                const fetchData = async () => {
                    try {
                        const assetsSnapshot = await db.collection('recommendedAssets').get();
                        setAssets(assetsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                        
                        const classesSnapshot = await db.collection('assetClasses').get();
                        setAssetClasses(classesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    } catch (error) {
                        console.error("Error fetching data for RecommendedAssetsSettings:", error);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, [refreshTrigger]);
            
            const openEditModal = (asset) => {
                setEditingAsset(asset);
                setIsModalOpen(true);
            }

            const openNewModal = () => {
                setEditingAsset(null);
                setIsModalOpen(true);
            }
            
            const openDeleteConfirmation = (asset) => {
                setConfirmingDelete(asset);
            };

            const handleConfirmDelete = async () => {
                if (confirmingDelete) {
                    await db.collection("recommendedAssets").doc(confirmingDelete.id).delete();
                    setConfirmingDelete(null);
                    setRefreshTrigger(t => t + 1);
                }
            };
            
             return (
                 <div>
                     <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                         <h2 className="text-2xl font-bold text-slate-300">Gerenciar Ativos Recomendados</h2>
                         <button onClick={openNewModal} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors">
                             <Icon path={ICONS.PLUS} className="h-5 w-5 mr-2" />
                             Novo Ativo
                         </button>
                     </div>

                     <div className="bg-slate-800 rounded-xl shadow-lg">
                         <table className="w-full text-left">
                             <thead className="border-b border-slate-700">
                                 <tr>
                                     <th className="p-4 text-sm font-semibold text-slate-300">Nome do Ativo</th>
                                     <th className="p-4 text-sm font-semibold text-slate-300">Classe</th>
                                     <th className="p-4 text-sm font-semibold text-slate-300">Subclasse</th>
                                     <th className="p-4 text-sm font-semibold text-slate-300">Corretoras</th>
                                     <th className="p-4 text-sm font-semibold text-slate-300 text-right">Ações</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 {loading ? (
                                     <tr><td colSpan="5" className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></td></tr>
                                 ) : assets.length > 0 ? assets.map(asset => (
                                     <tr key={asset.id} className="border-b border-slate-700 last:border-b-0 hover:bg-slate-700/50">
                                         <td className="p-4 font-medium text-white">{asset.name}</td>
                                         <td className="p-4 text-slate-300">{asset.class}</td>
                                         <td className="p-4 text-slate-300">{asset.subclass || 'N/A'}</td>
                                         <td className="p-4 text-slate-300 text-xs">{(asset.institutions || []).join(', ')}</td>
                                         <td className="p-4 flex justify-end items-center space-x-4">
                                             <button onClick={() => openEditModal(asset)} className="text-slate-400 hover:text-white"><Icon path={ICONS.EDIT} className="h-5 w-5"/></button>
                                             <button onClick={() => openDeleteConfirmation(asset)} className="text-slate-400 hover:text-red-400"><Icon path={ICONS.TRASH} className="h-5 w-5"/></button>
                                         </td>
                                     </tr>
                                 )) : (
                                     <tr><td colSpan="5" className="text-center p-8 text-slate-400">Nenhum ativo recomendado encontrado.</td></tr>
                                 )}
                             </tbody>
                         </table>
                     </div>
                     {isModalOpen && <RecommendedAssetModal asset={editingAsset} assetClasses={assetClasses} onClose={() => { setIsModalOpen(false); setRefreshTrigger(t => t + 1); }} />}
                     {confirmingDelete && (
                         <ConfirmModal
                             title="Confirmar Exclusão"
                             message={`Tem certeza que deseja excluir o ativo "${confirmingDelete.name}"?`}
                             onConfirm={handleConfirmDelete}
                             onCancel={() => setConfirmingDelete(null)}
                         />
                     )}
                 </div>
            );
        }

        function RecommendedAssetModal({ asset, onClose, assetClasses }) {
            const [name, setName] = useState(asset ? asset.name : '');
            const [assetClass, setAssetClass] = useState(asset ? asset.class : '');
            const [subclass, setSubclass] = useState(asset ? asset.subclass : '');
            const [institutions, setInstitutions] = useState(asset ? asset.institutions || [] : []);
            const [loading, setLoading] = useState(false);

            const availableSubclasses = useMemo(() => {
                if (!assetClass) return [];
                const selected = assetClasses.find(c => c.name === assetClass);
                return selected ? selected.subclasses || [] : [];
            }, [assetClass, assetClasses]);
            
            const handleInstitutionToggle = (institution) => {
                setInstitutions(prev => 
                    prev.includes(institution) 
                        ? prev.filter(i => i !== institution)
                        : [...prev, institution]
                );
            };
            
            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                const data = { name, class: assetClass, subclass, institutions };

                try {
                    if (asset) {
                        await db.collection('recommendedAssets').doc(asset.id).update(data);
                    } else {
                        await db.collection('recommendedAssets').add(data);
                    }
                    setLoading(false);
                    onClose();
                } catch (error) {
                    console.error("Error saving asset:", error);
                    setLoading(false);
                }
            };

            return (
                 <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                     <div className="bg-slate-800 rounded-xl shadow-2xl p-8 w-full max-w-lg">
                         <h2 className="text-2xl font-bold text-white mb-6">{asset ? 'Editar Ativo' : 'Novo Ativo Recomendado'}</h2>
                         <form onSubmit={handleSubmit} className="space-y-4">
                             <input type="text" placeholder="Nome do Ativo" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white" required />
                             <select value={assetClass} onChange={e => { setAssetClass(e.target.value); setSubclass(''); }} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white" required>
                                 <option value="">Selecione a Classe</option>
                                 {assetClasses.map(c => <option key={c.id} value={c.name}>{c.name}</option>)}
                             </select>
                             <select value={subclass} onChange={e => setSubclass(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white" disabled={availableSubclasses.length === 0}>
                                 <option value="">Selecione a Subclasse (opcional)</option>
                                 {availableSubclasses.map(s => <option key={s} value={s}>{s}</option>)}
                             </select>
                             
                             <div>
                                 <label className="text-sm font-semibold text-slate-300 mb-2 block">Corretoras Disponíveis</label>
                                 <div className="grid grid-cols-3 gap-2 p-3 bg-slate-700/50 rounded-lg">
                                     {INSTITUICOES.map(inst => (
                                         <label key={inst} className="flex items-center space-x-2 text-sm cursor-pointer">
                                             <input 
                                                 type="checkbox" 
                                                 checked={institutions.includes(inst)}
                                                 onChange={() => handleInstitutionToggle(inst)}
                                                 className="form-checkbox h-4 w-4 rounded bg-slate-600 border-slate-500 text-sky-500 focus:ring-sky-500"
                                             />
                                             <span>{inst}</span>
                                         </label>
                                     ))}
                                 </div>
                             </div>

                             <div className="flex justify-end pt-4 space-x-3">
                                 <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">Cancelar</button>
                                 <button type="submit" disabled={loading} className="px-4 py-2 bg-sky-600 rounded-lg hover:bg-sky-700 disabled:bg-sky-800 flex items-center">
                                     {loading && <Loader className="h-5 w-5 mr-2" />}
                                     Salvar
                                 </button>
                             </div>
                         </form>
                     </div>
                 </div>
            );
        }
        
        // --- NEW --- Classes Settings Components
        function ClassesSettings() {
            const [classes, setClasses] = useState([]);
            const [loading, setLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingClass, setEditingClass] = useState(null);
            const [confirmingDelete, setConfirmingDelete] = useState(null);
            const [seeding, setSeeding] = useState(false);
            const [refreshTrigger, setRefreshTrigger] = useState(0);

            useEffect(() => {
                setLoading(true);
                db.collection('assetClasses').get()
                    .then(snapshot => {
                        const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        data.sort((a, b) => a.name.localeCompare(b.name)); // Sort client-side
                        setClasses(data);
                    })
                    .catch(error => {
                        console.error("Error fetching asset classes:", error);
                    })
                    .finally(() => {
                        setLoading(false);
                    });
            }, [refreshTrigger]);

            const handleSeedData = async () => {
                setSeeding(true);
                const initialClasses = {
                    'Renda Fixa Pós': ['Soberano', 'Crédito Privado', 'Bancário'],
                    'Renda Fixa Pré': ['Bancário'],
                    'Renda Fixa IPCA': ['Inflação'],
                    'Renda Variável': ['Long Only', 'Long Biased'],
                    'Multimercado': ['Macro', 'Long & Short'],
                    'Fundos Listados': ['FII', 'FI Infra', 'FI Agro'],
                    'Exterior': ['Renda Variável', 'Renda Fixa'],
                    'Alternativo': ['FIDC'],
                    'Ações BR': ['Long Biased', 'Long Only'],
                };

                const batch = db.batch();
                const currentClassesSnapshot = await db.collection('assetClasses').get();
                const currentClassNames = new Set(currentClassesSnapshot.docs.map(doc => doc.data().name));

                Object.entries(initialClasses).forEach(([name, subclasses]) => {
                    if (!currentClassNames.has(name)) {
                        const docRef = db.collection('assetClasses').doc();
                        batch.set(docRef, { name, subclasses: subclasses.sort() });
                    }
                });

                await batch.commit();
                setSeeding(false);
                setRefreshTrigger(t => t + 1);
            };

            const handleDelete = async () => {
                if (confirmingDelete) {
                    await db.collection('assetClasses').doc(confirmingDelete.id).delete();
                    setConfirmingDelete(null);
                    setRefreshTrigger(t => t + 1);
                }
            };

            return (
                <div>
                     <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-slate-300">Gerenciar Classes e Subclasses</h2>
                        <div className="flex items-center space-x-4">
                             <button onClick={handleSeedData} disabled={seeding || classes.length > 0} className="flex items-center bg-indigo-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors disabled:bg-indigo-800 disabled:cursor-not-allowed">
                                 {seeding ? <Loader className="h-5 w-5 mr-2" /> : null}
                                 Pré-cadastrar Classes
                             </button>
                             <button onClick={() => { setEditingClass(null); setIsModalOpen(true); }} className="flex items-center bg-sky-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-sky-700 transition-colors">
                                 <Icon path={ICONS.PLUS} className="h-5 w-5 mr-2" />
                                 Nova Classe
                             </button>
                        </div>
                    </div>
                     <div className="bg-slate-800 rounded-xl shadow-lg">
                        <table className="w-full text-left">
                            <thead className="border-b border-slate-700">
                                <tr>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Classe</th>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Subclasses</th>
                                    <th className="p-4 text-sm font-semibold text-slate-300 text-right">Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {loading ? (
                                     <tr><td colSpan="3" className="text-center p-8"><Loader className="h-8 w-8 text-sky-400 mx-auto" /></td></tr>
                                ) : classes.map(c => (
                                    <tr key={c.id} className="border-b border-slate-700 last:border-b-0">
                                        <td className="p-4 font-bold text-white w-1/4">{c.name}</td>
                                        <td className="p-4 text-slate-300">
                                            <div className="flex flex-wrap gap-2">
                                                {(c.subclasses || []).map(s => <span key={s} className="text-xs bg-slate-700 px-2 py-1 rounded-full">{s}</span>)}
                                            </div>
                                        </td>
                                        <td className="p-4 flex justify-end items-center space-x-4">
                                            <button onClick={() => { setEditingClass(c); setIsModalOpen(true);}} className="text-slate-400 hover:text-white"><Icon path={ICONS.EDIT} className="h-5 w-5"/></button>
                                            <button onClick={() => setConfirmingDelete(c)} className="text-slate-400 hover:text-red-400"><Icon path={ICONS.TRASH} className="h-5 w-5"/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {isModalOpen && <ClassModal assetClass={editingClass} onClose={() => { setIsModalOpen(false); setRefreshTrigger(t => t + 1); }} />}
                    {confirmingDelete && (
                         <ConfirmModal
                             title="Confirmar Exclusão"
                             message={`Tem certeza que deseja excluir a classe "${confirmingDelete.name}" e todas as suas subclasses?`}
                             onConfirm={handleDelete}
                             onCancel={() => setConfirmingDelete(null)}
                         />
                     )}
                </div>
            );
        }

        function ClassModal({ assetClass, onClose }) {
            const [name, setName] = useState(assetClass ? assetClass.name : '');
            const [subclasses, setSubclasses] = useState(assetClass ? assetClass.subclasses.map(s => ({id: Math.random(), name: s})) : []);
            const [loading, setLoading] = useState(false);
            
            const handleSubclassChange = (id, value) => {
                setSubclasses(subs => subs.map(s => s.id === id ? {...s, name: value} : s));
            };

            const addSubclass = () => {
                setSubclasses(subs => [...subs, { id: Math.random(), name: '' }]);
            };

            const removeSubclass = (id) => {
                setSubclasses(subs => subs.filter(s => s.id !== id));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);

                const data = {
                    name,
                    subclasses: subclasses.map(s => s.name.trim()).filter(Boolean).sort()
                };

                if (assetClass) {
                    await db.collection('assetClasses').doc(assetClass.id).update(data);
                } else {
                    await db.collection('assetClasses').add(data);
                }

                setLoading(false);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-800 rounded-xl shadow-2xl p-8 w-full max-w-lg">
                        <h2 className="text-2xl font-bold text-white mb-6">{assetClass ? 'Editar Classe' : 'Nova Classe de Ativo'}</h2>
                        <form onSubmit={handleSubmit} className="space-y-4">
                             <input type="text" placeholder="Nome da Classe" value={name} onChange={e => setName(e.target.value)} className="w-full px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white" required />
                            <div>
                                <h3 className="text-lg font-semibold text-white mb-2">Subclasses</h3>
                                <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                    {subclasses.map((sub, index) => (
                                        <div key={sub.id} className="flex items-center space-x-2">
                                            <input type="text" placeholder={`Subclasse ${index + 1}`} value={sub.name} onChange={e => handleSubclassChange(sub.id, e.target.value)} className="flex-1 px-3 py-1 bg-slate-600 border border-slate-500 rounded-lg text-white text-sm" />
                                            <button type="button" onClick={() => removeSubclass(sub.id)} className="text-red-500 hover:text-red-400 p-1"><Icon path={ICONS.TRASH} className="h-4 w-4" /></button>
                                        </div>
                                    ))}
                                </div>
                                <button type="button" onClick={addSubclass} className="text-sky-400 font-semibold text-sm flex items-center mt-2"><Icon path={ICONS.PLUS} className="h-4 w-4 mr-1"/>Adicionar Subclasse</button>
                            </div>
                            <div className="flex justify-end pt-4 space-x-3">
                                <button type="button" onClick={onClose} className="px-4 py-2 bg-slate-600 rounded-lg hover:bg-slate-500">Cancelar</button>
                                <button type="submit" disabled={loading} className="px-4 py-2 bg-sky-600 rounded-lg hover:bg-sky-700 disabled:bg-sky-800 flex items-center">
                                    {loading && <Loader className="h-5 w-5 mr-2" />}
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            )
        }
        
        // --- PresentationView Components ---
        const SlideHeader = ({ title }) => (
            <div className="slide-header-print">
                <div className="flex items-center">
                    <Icon path={ICONS.CHART} className="h-8 w-8 text-sky-500" />
                    <span className="ml-2 text-xl font-bold">HIGHPAR</span>
                </div>
                <h2 className="text-2xl font-bold text-slate-700">{title}</h2>
            </div>
        );

        const SlideFooter = ({ clientName, slideNumber, totalSlides }) => (
            <div className="slide-footer-print">
                <span>{clientName} | Relatório de Enquadramento de Carteira | Página {slideNumber} de {totalSlides}</span>
            </div>
        );

      function PresentationView({ client, profile, user, analysis, liquidityAnalysis, redemptions, applications, quotations, observations, onClose }) {
    const [currentSlide, setCurrentSlide] = useState(0);
    const [isGenerating, setIsGenerating] = useState(false); // <-- PASSO 2a: ADICIONADO ESTADO DE LOADING

    const slideConfigs = useMemo(() => {
        const configs = [
            { Component: TitleSlide, props: { client, user }, title: "Capa" },
            { Component: ConsolidatedPositionSlide, props: { analysis, profile }, title: "Posição Consolidada" },
            { Component: PortfolioLiquiditySlide, props: { liquidityAnalysis }, title: "Análise de Liquidez" },
            { Component: AssetTypeSlide, props: { analysis }, title: "Concentração por Tipo de Ativo" },
            { Component: AllocationComparisonSlide, props: { analysis, profile }, title: "Análise de Enquadramento" },
            { Component: IssuerConcentrationSlide, props: { analysis }, title: "Concentração por Emissor" },
        ];

        if (observations && observations.trim() !== '') {
            configs.push({ Component: ObservationsSlide, props: { observations }, title: "Observações e Estratégia" });
        }

        configs.push({ Component: RebalancePlanSlide, props: { redemptions, applications }, title: "Plano de Ação" });

        if (Object.keys(redemptions).length > 0 || (Array.isArray(Object.keys(applications).flat()) && Object.keys(applications).flat().length > 0)) {
            configs.push({ Component: ProjectedPortfolioSummarySlide, props: { analysis, redemptions, applications }, title: "Carteira Projetada (Resumo)" });
            configs.push({ Component: ProjectedPortfolioDetailSlide, props: { analysis, redemptions, applications }, title: "Carteira Projetada (Detalhes)" });
        }

        if (Object.keys(redemptions).length > 0) {
            configs.push({ Component: QuotationSlide, props: { redemptions, quotations }, title: "Cotação para Resgate" });
        }
        return configs;
    }, [client, user, analysis, profile, liquidityAnalysis, redemptions, applications, quotations, observations]);

    const nextSlide = () => setCurrentSlide(prev => Math.min(prev + 1, slideConfigs.length - 1));
    const prevSlide = () => setCurrentSlide(prev => Math.max(prev - 1, 0));
    
    // --- 👇 PASSO 2b: FUNÇÃO handlePrint SUBSTITUÍDA 👇 ---
    const handlePrint = async () => {
        // 1. Pega os nomes das bibliotecas que acabamos de adicionar
        const { jsPDF } = window.jspdf;
        const html2canvas = window.html2canvas;

        // 2. Avisa a aplicação que estamos gerando
        setIsGenerating(true);

        // 3. Encontra o container escondido que tem TODOS os slides
        // Usamos 'querySelector' para pegar o elemento, mesmo escondido
        const printContainer = document.querySelector('.printable-content');
        
        // 4. Encontra CADA slide individual dentro dele
        const slides = printContainer.querySelectorAll('.presentation-slide');

        // 5. Cria um novo documento PDF (paisagem 'l', unidade 'px', tamanho 'a4')
        const doc = new jsPDF('landscape', 'px', 'a4');
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();

        try {
            // 6. Faz um loop, um slide de cada vez
            for (let i = 0; i < slides.length; i++) {
                const slide = slides[i];
                
                // 7. Tira a "foto" (canvas) do slide
                const canvas = await html2canvas(slide, {
                    scale: 2, // Aumenta a resolução da "foto"
                    useCORS: true,
                    // Garante que fundos e cores sejam capturados
                    backgroundColor: '#ffffff' 
                });
                
                // 8. Converte a foto para um formato de imagem (PNG)
                const imgData = canvas.toDataURL('image/png');
                
                // 9. Calcula o tamanho da imagem para caber na página
                const imgProps = doc.getImageProperties(imgData);
                const ratio = Math.min(pdfWidth / imgProps.width, pdfHeight / imgProps.height);
                const width = imgProps.width * ratio;
                const height = imgProps.height * ratio;
                
                // Centraliza a imagem na página
                const x = (pdfWidth - width) / 2;
                const y = (pdfHeight - height) / 2;

                // 10. Adiciona a imagem ao PDF
                doc.addImage(imgData, 'PNG', x, y, width, height);

                // 11. Se não for o último slide, adiciona uma nova página
                if (i < slides.length - 1) {
                    doc.addPage();
                }
            }

            // 12. Fim do loop, salva o arquivo PDF!
            doc.save('Relatorio_Highpar.pdf');

        } catch (error) {
            console.error("Erro ao gerar o PDF:", error);
            // NÃO use alert() em apps React, pode travar. Use um modal de erro se precisar.
            // Por agora, só logamos o erro.
        } finally {
            // 13. Avisa que terminamos
            setIsGenerating(false);
        }
    };
    // --- 👆 FIM DA SUBSTITUIÇÃO 👆 ---

    return (
        <div className="fixed inset-0 bg-slate-900 z-50 flex flex-col">
            {/* Screen UI: Header and Navigation */}
            <header className="no-print p-4 bg-slate-800 flex justify-between items-center border-b border-slate-700 flex-shrink-0">
                <h2 className="font-bold text-white">Modo Apresentação</h2>
                <div className="flex items-center space-x-4">
                    <span className="text-sm text-slate-400">Slide {currentSlide + 1} de {slideConfigs.length}</span>
                    <div className="flex items-center space-x-2">
                        <button onClick={prevSlide} disabled={currentSlide === 0} className="p-2 rounded-md bg-slate-700 hover:bg-slate-600 disabled:opacity-50"><Icon path={ICONS.CHEVRON_LEFT} className="h-5 w-5" /></button>
                        <button onClick={nextSlide} disabled={currentSlide === slideConfigs.length - 1} className="p-2 rounded-md bg-slate-700 hover:bg-slate-600 disabled:opacity-50"><Icon path={ICONS.CHEVRON_RIGHT} className="h-5 w-5" /></button>
                    </div>
                    
                    {/* --- 👇 PASSO 3: BOTÃO ATUALIZADO 👇 --- */}
                    <button 
                        onClick={handlePrint} 
                        disabled={isGenerating} 
                        className="flex items-center bg-sky-600 px-3 py-2 text-sm rounded-lg hover:bg-sky-700 disabled:bg-sky-800 disabled:cursor-wait w-32 justify-center"
                    >
                        {isGenerating ? (
                            <Loader className="h-5 w-5 mr-2" />
                        ) : (
                            <Icon path={ICONS.PDF} className="h-5 w-5 mr-2"/>
                        )}
                        {isGenerating ? 'Gerando...' : 'Gerar PDF'}
                    </button>
                    {/* --- 👆 FIM DA ATUALIZAÇÃO DO BOTÃO 👆 --- */}
                    
                    <button onClick={onClose} className="p-2 rounded-md bg-slate-700 hover:bg-slate-600"><Icon path={ICONS.CLOSE} className="h-5 w-5" /></button>
                </div>
            </header>
            
            {/* Screen UI: Interactive Slide View */}
            <main className="no-print flex-1 p-4 overflow-y-auto">
                <div className="w-full h-full relative">
                   {slideConfigs.map(({ Component, props }, index) => (
                        <div
                            key={`screen-${index}`}
                            className={`absolute top-0 left-0 w-full h-full transition-opacity duration-300 ease-in-out ${ index === currentSlide ? 'opacity-100 visible z-10' : 'opacity-0 invisible' }`}
                        >
                            <div className="w-full h-full bg-slate-900 p-8 lg:p-12 border border-slate-700 rounded-lg flex flex-col justify-center">
                                <Component {...props} />
                            </div>
                        </div>
                   ))}
                </div>
            </main>

            {/* Print UI: All slides rendered sequentially */}
            <div className="printable-content">
                {slideConfigs.map(({ Component, props, title }, index) => {
                   const slideInfo = { current: index + 1, total: slideConfigs.length };
                   return (
                       <div key={`print-${index}`} className="presentation-slide">
                           {/* keep header for all slides except the Title (index 0) so title slide remains clean */}
                           {index > 0 && <SlideHeader title={title} />}
                           <div className="slide-content-print">
                               <Component {...props} />
                           </div>
                           {index > 0 && <SlideFooter clientName={client?.name || ''} slideNumber={slideInfo.current} totalSlides={slideConfigs.length} />}
                       </div>
                   );
                })}
            </div>
        </div>
    );
}

        const TitleSlide = ({ client, user }) => (
            <div className="text-center flex flex-col items-center justify-center h-full">
                <Icon path={ICONS.CHART} className="h-24 w-24 text-sky-400 mb-6" />
                <h1 className="text-4xl font-bold text-slate-300 mb-4">HIGHPAR</h1>
                <h2 className="text-5xl font-bold text-white mb-12">Relatório de Enquadramento de Carteira</h2>
                <div className="text-xl text-slate-400">
                    <p className="font-bold text-2xl text-slate-200 mb-4">{client.name}</p>
                    <p>Consultor: {user.name}</p>
                    <p>Data: {new Date().toLocaleDateString('pt-BR')}</p>
                </div>
            </div>
        );

        const ConsolidatedPositionSlide = ({ analysis, profile }) => {
            const currentByClass = useMemo(() => {
                if(!analysis) return [];
                return Object.entries(analysis.portfolio.reduce((acc, asset) => {
                    const key = asset.Classe;
                    if(!acc[key]) acc[key] = 0;
                    acc[key] += asset.Valor;
                    return acc;
                }, {})).map(([name, value]) => ({name, value}));
            }, [analysis]);

            const recommendedChartData = useMemo(() => {
                 if (!analysis || !profile || !profile.allocations) return null;
                 const { totalValue } = analysis;
                 const data = profile.allocations.reduce((acc, alloc) => {
                     const key = alloc.Classe;
                     const value = (alloc.percentage / 100) * totalValue;
                     if(!acc[key]) {
                         acc[key] = { name: key, value: 0};
                     }
                     acc[key].value += value;
                     return acc;
                 }, {});
                return Object.values(data).filter(d => d.value > 0);
            }, [analysis, profile]);

            const institutionalData = useMemo(() => {
                if (!analysis) return null;
                const data = analysis.portfolio.reduce((acc, asset) => {
                    const account = asset.Instituição + (asset["Número da Conta"] ? ` - ${asset["Número da Conta"]}` : '');
                    if (!acc[account]) acc[account] = 0;
                    acc[account] += asset.Valor;
                    return acc;
                }, {});
                return Object.entries(data).map(([name, value]) => ({ name, value })).filter(d => d.value > 0)
            }, [analysis]);
            
            return (
                 <React.Fragment>
                    {analysis ? (
                        <div className="flex flex-col h-full space-y-8">
                            <div className="grid grid-cols-2 gap-8 flex-grow">
                                <SvgPieChart data={currentByClass} title="Distribuição por Estratégia" />
                                <SvgPieChart data={recommendedChartData} title="Distribuição Recomendada" />
                            </div>
                            <div className="flex-shrink-0">
                                <CssBarChart data={institutionalData} title="Valor Total por Instituição" />
                            </div>
                        </div>
                    ) : <p className="text-slate-400">Dados do portfólio não disponíveis.</p>}
                </React.Fragment>
            );
        };
        
        const AllocationComparisonSlide = ({ analysis, profile }) => {
             const comparisonData = useMemo(() => {
                if (!analysis || !profile || !profile.allocations) return null;

                const { totalValue, currentAllocationByClass } = analysis;
                
                const recommendedAllocationMap = profile.allocations.reduce((acc, alloc) => {
                    if ((alloc.subcategories || []).length > 0) {
                        alloc.subcategories.forEach(sub => {
                            const key = alloc.Classe + (sub.name ? ` - ${sub.name}` : '');
                            const normalizedKey = normalizeString(key);
                            acc[normalizedKey] = {
                                originalName: key,
                                value: (sub.percentage / 100) * totalValue,
                                percentage: sub.percentage / 100
                            };
                        });
                    } else {
                        const key = alloc.Classe;
                        const normalizedKey = normalizeString(key);
                        if(normalizedKey){
                            acc[normalizedKey] = {
                                originalName: key,
                                value: (alloc.percentage / 100) * totalValue,
                                percentage: alloc.percentage / 100
                            };
                        }
                    }
                    return acc;
                }, {});

                const currentAllocationMap = Object.keys(currentAllocationByClass).reduce((acc, key) => {
                    const normalizedKey = normalizeString(key);
                    acc[normalizedKey] = {
                        originalName: key,
                        ...currentAllocationByClass[key]
                    };
                    return acc;
                }, {});

                const allNormalizedClasses = [...new Set([...Object.keys(currentAllocationMap), ...Object.keys(recommendedAllocationMap)])];
                
                return allNormalizedClasses.map(normalizedClass => {
                    const current = currentAllocationMap[normalizedClass] || { value: 0, percentage: 0 };
                    const recommended = recommendedAllocationMap[normalizedClass] || { value: 0, percentage: 0 };
                    
                    return {
                        name: current.originalName || recommended.originalName || normalizedClass,
                        currentPercent: current.percentage,
                        recommendedPercent: recommended.percentage,
                        diffValue: current.value - recommended.value,
                    };
                }).sort((a,b) => (b.recommendedPercent*1000 + b.currentPercent) - (a.recommendedPercent*1000 + a.currentPercent))
                .filter(item => item.recommendedPercent > 0 || item.currentPercent > 0);
            }, [analysis, profile]);

            return (
                <React.Fragment>
                    {!comparisonData ? <p className="text-slate-400">Dados insuficientes para comparação.</p> : (
                        <div className="overflow-y-auto h-full">
                        <table className="w-full text-left">
                            <thead className="border-b border-slate-700">
                                <tr>
                                    <th className="p-4 text-base font-semibold text-slate-300">Classe / Subclasse</th>
                                    <th className="p-4 text-base font-semibold text-slate-300 w-1/2">Alocação</th>
                                    <th className="p-4 text-base font-semibold text-slate-300 text-right">Ação Sugerida</th>
                                </tr>
                            </thead>
                            <tbody>
                                {comparisonData.map((item, index) => (
                                    <tr key={index} className="border-b border-slate-700 last:border-b-0">
                                        <td className="p-4 font-medium text-white text-base">{item.name}</td>
                                        <td className="p-4 text-slate-300">
                                            <div className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="font-semibold text-white">Atual: {formatPercent(item.currentPercent)}</span>
                                                    <span className="text-slate-400">Recomendado: {formatPercent(item.recommendedPercent)}</span>
                                                </div>
                                                <div className="w-full bg-slate-700 rounded-full h-4 relative">
                                                    <div className="bg-sky-500 h-4 rounded-full" style={{ width: `${Math.min(item.currentPercent * 100, 100)}%` }}></div>
                                                    <div className="absolute top-0 border-l-2 border-white h-full" style={{ left: `${item.recommendedPercent * 100}%` }}>
                                                        <div className="w-2 h-2 bg-white rounded-full -ml-1 -mt-1 relative top-1/2"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td className={`p-4 text-right font-semibold ${item.diffValue > 0 ? 'text-red-400' : 'text-green-400'}`}>
                                            {formatCurrency(Math.abs(item.diffValue))}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        </div>
                    )}
                </React.Fragment>
            );
        };

        const ObservationsSlide = ({ observations }) => (
            <div className="h-full flex flex-col">
                <div className="flex-grow bg-slate-800 p-6 rounded-xl text-slate-300 whitespace-pre-wrap overflow-y-auto">
                    {observations || "Nenhuma observação adicionada."}
                </div>
            </div>
        );

        const RebalancePlanSlide = ({ redemptions, applications }) => {
            const totalRedeemed = Object.values(redemptions).reduce((sum, { amount }) => sum + amount, 0);
            const totalApplied = Object.values(applications).flat().reduce((sum, app) => sum + app.value, 0);

            return (
                 <React.Fragment>
                    <div className="grid grid-cols-2 gap-8 h-full">
                        <div className="bg-slate-800 p-6 rounded-xl flex flex-col">
                            <h3 className="text-xl font-semibold text-red-400 mb-4">Resgates Sugeridos</h3>
                            <div className="space-y-3 flex-grow overflow-y-auto">
                               {Object.values(redemptions).length > 0 ? Object.values(redemptions).map(({ asset, amount }, i) => (
                                   <div key={i} className="flex justify-between items-center text-sm p-2 bg-slate-700/50 rounded">
                                       <div>
                                           <p className="font-semibold text-slate-200">{asset.Nome}</p>
                                           <p className="text-xs text-slate-400">{asset.Instituição}</p>
                                       </div>
                                       <p className="font-bold text-red-400">{formatCurrency(amount)}</p>
                                   </div>
                               )) : <p className="text-slate-400 text-sm">Nenhum resgate necessário.</p>}
                            </div>
                            <div className="border-t border-slate-700 mt-4 pt-4 flex justify-between font-bold flex-shrink-0">
                                <span>Total a Resgatar:</span>
                                <span>{formatCurrency(totalRedeemed)}</span>
                            </div>
                        </div>
                         <div className="bg-slate-800 p-6 rounded-xl flex flex-col">
                            <h3 className="text-xl font-semibold text-green-400 mb-4">Aplicações Sugeridas</h3>
                             <div className="space-y-3 flex-grow overflow-y-auto">
                               {Object.values(applications).flat().length > 0 ? Object.entries(applications).map(([inst, apps]) => (
                                   <div key={inst}>
                                     <h4 className="font-bold text-slate-300 text-sm mb-1">{inst}</h4>
                                     {apps.map((app, i) => (
                                         <div key={i} className="flex justify-between items-center text-sm p-2 bg-slate-700/50 rounded mb-2">
                                             <p className="font-semibold text-slate-200">{app.name}</p>
                                             <p className="font-bold text-green-400">{formatCurrency(app.value)}</p>
                                         </div>
                                     ))}
                                   </div>
                               )) : <p className="text-slate-400 text-sm">Nenhuma aplicação necessária.</p>}
                            </div>
                             <div className="border-t border-slate-700 mt-4 pt-4 flex justify-between font-bold flex-shrink-0">
                                <span>Total a Aplicar:</span>
                                <span>{formatCurrency(totalApplied)}</span>
                            </div>
                        </div>
                    </div>
                </React.Fragment>
            )
        };
        
        const PortfolioLiquiditySlide = ({ liquidityAnalysis }) => {
            return (
                <React.Fragment>
                    {!liquidityAnalysis ? <p className="text-slate-400">Dados de liquidez não disponíveis.</p> : (
                         <CssBarChart data={liquidityAnalysis} title="" />
                    )}
                </React.Fragment>
            );
        };

        const ProjectedPortfolioSummarySlide = ({ analysis, redemptions, applications }) => {
            const projectedAnalysis = useMemo(() => {
                if (!analysis) return null;
                let projectedPortfolio = JSON.parse(JSON.stringify(analysis.portfolio));
                const redemptionMap = {};
                Object.values(redemptions).forEach(({ asset, amount }) => {
                    const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                    redemptionMap[assetId] = (redemptionMap[assetId] || 0) + amount;
                });
                projectedPortfolio = projectedPortfolio.map(asset => {
                    const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                    if (redemptionMap[assetId]) {
                        asset.Valor -= redemptionMap[assetId];
                    }
                    return asset;
                }).filter(asset => asset.Valor > 0.01);
                Object.entries(applications).forEach(([institution, apps]) => {
                    apps.forEach(app => {
                        const [inst, conta] = institution.split(' - ');
                        projectedPortfolio.push({
                            "Instituição": inst, "Número da Conta": conta || '', "Nome": app.name, "Valor": app.value,
                            "Classe": app.Classe.split(' - ')[0], "Subclasse": app.Classe.split(' - ')[1] || '',
                            "Emissor": '', "Vencimento": '', "Taxa": '', "Liquidez": '', "Tipo de Ativo": 'Novo Ativo',
                        });
                    });
                });
                if (projectedPortfolio.length === 0) return { totalValue: 0, chartData: [], portfolio: [] };
                const newTotalValue = projectedPortfolio.reduce((sum, asset) => sum + asset.Valor, 0);
                const newAllocationByClass = projectedPortfolio.reduce((acc, asset) => {
                    const key = asset.Classe;
                    if (!acc[key]) acc[key] = { name: key, value: 0 };
                    acc[key].value += asset.Valor;
                    return acc;
                }, {});
                return {
                    totalValue: newTotalValue,
                    chartData: Object.values(newAllocationByClass),
                    portfolio: projectedPortfolio,
                };
            }, [analysis, redemptions, applications]);

            const valuePerClass = useMemo(() => {
                if (!projectedAnalysis) return [];
                return Object.values(projectedAnalysis.portfolio.reduce((acc, asset) => {
                     const key = asset.Classe;
                     if (!acc[key]) acc[key] = { name: key, value: 0 };
                     acc[key].value += asset.Valor;
                     return acc;
                }, {})).sort((a,b) => b.value - a.value);
            }, [projectedAnalysis]);
            
            const valuePerInstitution = useMemo(() => {
                if (!projectedAnalysis) return [];
                return Object.values(projectedAnalysis.portfolio.reduce((acc, asset) => {
                     const key = asset.Instituição;
                     if (!acc[key]) acc[key] = { name: key, value: 0 };
                     acc[key].value += asset.Valor;
                     return acc;
                }, {})).sort((a,b) => b.value - a.value);
            }, [projectedAnalysis]);


            if (!projectedAnalysis) {
                return <p className="text-slate-400">Não foi possível projetar a nova carteira.</p>;
            }

            return (
                <div className="grid grid-cols-2 gap-8 h-full">
                    <div className="flex flex-col">
                         <p className="text-slate-400 mb-4 text-center">Valor Total Projetado: <span className="font-bold text-white text-lg">{formatCurrency(projectedAnalysis.totalValue)}</span></p>
                         <div className="flex-grow">
                            <SvgPieChart data={projectedAnalysis.chartData} title="Nova Distribuição" />
                         </div>
                    </div>
                    <div className="space-y-6 flex flex-col justify-center">
                        <CssBarChart data={valuePerClass} title="Valor por Estratégia" />
                        <CssBarChart data={valuePerInstitution} title="Valor por Instituição" />
                    </div>
                </div>
            );
        };

        const ProjectedPortfolioDetailSlide = ({ analysis, redemptions, applications }) => {
            const projectedAnalysis = useMemo(() => {
                if (!analysis) return null;
                let projectedPortfolio = JSON.parse(JSON.stringify(analysis.portfolio));
                const redemptionMap = {};
                Object.values(redemptions).forEach(({ asset, amount }) => {
                    const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                    redemptionMap[assetId] = (redemptionMap[assetId] || 0) + amount;
                });
                projectedPortfolio = projectedPortfolio.map(asset => {
                    const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                    if (redemptionMap[assetId]) {
                        asset.Valor -= redemptionMap[assetId];
                    }
                    return asset;
                }).filter(asset => asset.Valor > 0.01);
                Object.entries(applications).forEach(([institution, apps]) => {
                    apps.forEach(app => {
                        const [inst, conta] = institution.split(' - ');
                        projectedPortfolio.push({
                            "Instituição": inst, "Número da Conta": conta || '', "Nome": app.name, "Valor": app.value,
                            "Classe": app.Classe.split(' - ')[0], "Subclasse": app.Classe.split(' - ')[1] || '',
                             "Emissor": '', "Vencimento": '', "Taxa": '', "Liquidez": '', "Tipo de Ativo": 'Novo Ativo',
                        });
                    });
                });
                 if (projectedPortfolio.length === 0) return { totalValue: 0, portfolio: [] };
                const newTotalValue = projectedPortfolio.reduce((sum, asset) => sum + asset.Valor, 0);
                return { totalValue: newTotalValue, portfolio: projectedPortfolio };
            }, [analysis, redemptions, applications]);

            const assetsByClass = useMemo(() => {
                if (!projectedAnalysis) return {};
                return projectedAnalysis.portfolio.reduce((acc, asset) => {
                    const key = asset.Classe || 'Sem Classe';
                    if (!acc[key]) acc[key] = [];
                    acc[key].push(asset);
                    return acc;
                }, {});
            }, [projectedAnalysis]);
            
            if (!projectedAnalysis) return <p className="text-slate-400">Não foi possível projetar os detalhes da carteira.</p>;

            return (
                <div className="h-full overflow-y-auto">
                    <div className="space-y-4">
                    {Object.entries(assetsByClass).sort((a,b) => b[1].reduce((s,i)=>s+i.Valor,0) - a[1].reduce((s,i)=>s+i.Valor,0)).map(([className, assets]) => (
                        <div key={className}>
                            <h4 className="font-bold text-lg text-sky-400 mb-2">{className}</h4>
                            <div className="bg-slate-800 rounded-lg overflow-hidden">
                                <table className="w-full text-left text-sm">
                                    <thead>
                                        <tr className="border-b border-slate-700 bg-slate-700/50">
                                            <th className="p-2 text-slate-300">Ativo</th>
                                            <th className="p-2 text-slate-300">Instituição</th>
                                            <th className="p-2 text-slate-300 text-right">Valor</th>
                                            <th className="p-2 text-slate-300 text-right">% Carteira</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    {assets.sort((a,b) => b.Valor - a.Valor).map((asset, i) => (
                                       <tr key={i} className="border-b border-slate-700/50 last:border-b-0">
                                            <td className="p-2 font-medium text-white truncate" title={asset.Nome}>{asset.Nome}</td>
                                            <td className="p-2 text-slate-300">{asset.Instituição}</td>
                                            <td className="p-2 text-slate-300 text-right">{formatCurrency(asset.Valor)}</td>
                                            <td className="p-2 text-white font-semibold text-right">{formatPercent(asset.Valor / projectedAnalysis.totalValue)}</td>
                                       </tr>
                                    ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ))}
                    </div>
                </div>
            );
        };
        
        // --- NEW COMPONENTS ---
        function IssuerView({ analysis }) {
            const issuerData = useMemo(() => {
                if (!analysis || !analysis.issuerConcentration) return null;
                const sorted = Object.entries(analysis.issuerConcentration)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value);
                return {
                    chartData: sorted,
                    totalValue: analysis.totalValue
                };
            }, [analysis]);

            if (!issuerData) {
                return <div className="text-center p-10 bg-slate-800 rounded-lg"><h3 className="text-lg text-slate-400">Nenhum emissor identificado no portfólio.</h3></div>;
            }

            return (
                <div className="space-y-6">
                    <CssBarChart data={issuerData.chartData} title="Concentração por Emissor" />
                </div>
            )
        }
        
        function QuotationView({ redemptions, quotations, setQuotations }) {
            const handleQuoteChange = (assetId, value) => {
                const numericValue = parseFloat(String(value).replace(/\D/g, '')) / 100;
                setQuotations(prev => ({
                    ...prev,
                    [assetId]: isNaN(numericValue) ? 0 : numericValue
                }));
            };

            const redemptionList = Object.values(redemptions).map(r => r.asset);
            const totals = useMemo(() => {
                let totalTela = 0, totalResgate = 0;
                Object.values(redemptions).forEach(({asset, amount}) => {
                     const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                     totalTela += amount;
                     totalResgate += (quotations[assetId] || 0);
                });
                const totalDesagio = totalTela - totalResgate;
                const totalDesagioPercent = totalTela > 0 ? totalDesagio / totalTela : 0;
                return { totalTela, totalResgate, totalDesagio, totalDesagioPercent };
            }, [redemptions, quotations]);

            return (
                <div className="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                    <h3 className="text-xl font-semibold text-white p-4">Cotação de Ativos para Resgate</h3>
                    <div className="overflow-x-auto">
                        <table className="w-full text-left">
                            <thead className="border-b border-slate-700">
                                <tr>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Ativo</th>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Valor de Tela</th>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Valor de Resgate</th>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Deságio (R$)</th>
                                    <th className="p-4 text-sm font-semibold text-slate-300">Deságio (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {Object.values(redemptions).map(({ asset, amount }, index) => {
                                    const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                                    const valorTela = amount;
                                    const valorResgate = quotations[assetId] || 0;
                                    const desagioValor = valorTela - valorResgate;
                                    const desagioPercent = valorTela > 0 ? (desagioValor / valorTela) : 0;
                                    return (
                                        <tr key={assetId} className="border-b border-slate-700 last:border-b-0">
                                            <td className="p-4 font-medium text-white">{asset.Nome}<p className="text-xs text-slate-400">{asset.Instituição}</p></td>
                                            <td className="p-4 text-slate-300">{formatCurrency(valorTela)}</td>
                                            <td className="p-4">
                                                <input 
                                                    type="text"
                                                    value={formatCurrency(valorResgate).replace('R$\u00A0', '')}
                                                    onChange={(e) => handleQuoteChange(assetId, e.target.value)}
                                                    className="w-36 px-2 py-1 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm text-right focus:ring-2 focus:ring-sky-500 focus:outline-none"
                                                />
                                            </td>
                                            <td className="p-4 text-red-400">{formatCurrency(desagioValor)}</td>
                                            <td className="p-4 text-red-400">{formatPercent(desagioPercent)}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                            <tfoot className="border-t-2 border-slate-600 bg-slate-900/50">
                                <tr className="font-bold">
                                    <td className="p-4 text-white">TOTAIS</td>
                                    <td className="p-4 text-slate-200">{formatCurrency(totals.totalTela)}</td>
                                    <td className="p-4 text-slate-200">{formatCurrency(totals.totalResgate)}</td>
                                    <td className="p-4 text-red-300">{formatCurrency(totals.totalDesagio)}</td>
                                    <td className="p-4 text-red-300">{formatPercent(totals.totalDesagioPercent)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        }
        
        const IssuerConcentrationSlide = ({ analysis }) => {
            const issuerData = useMemo(() => {
                if (!analysis || !analysis.issuerConcentration) return null;
                const sorted = Object.entries(analysis.issuerConcentration)
                    .map(([name, value]) => ({ name, value }))
                    .sort((a, b) => b.value - a.value);
                return sorted;
            }, [analysis]);

            return (
                <React.Fragment>
                    {!issuerData ? <p className="text-slate-400">Dados de emissor não disponíveis.</p> : (
                         <CssBarChart data={issuerData} title="" />
                    )}
                </React.Fragment>
            );
        };
        
        const AssetTypeSlide = ({ analysis }) => {
             const assetTypeData = useMemo(() => {
                if (!analysis || !analysis.allocationByAssetType) return null;
                return Object.entries(analysis.allocationByAssetType)
                    .map(([name, data]) => ({ name, value: data.value }))
                    .sort((a, b) => b.value - a.value);
            }, [analysis]);

            return (
                 <React.Fragment>
                    {!assetTypeData ? <p className="text-slate-400">Dados de tipo de ativo não disponíveis.</p> : (
                         <CssBarChart data={assetTypeData} title="" />
                    )}
                </React.Fragment>
            );
        };
        
        const QuotationSlide = ({ redemptions, quotations }) => {
            const totals = useMemo(() => {
                let totalTela = 0, totalResgate = 0;
                Object.values(redemptions).forEach(({asset, amount}) => {
                    const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                    totalTela += amount;
                    totalResgate += (quotations[assetId] || 0);
                });
                const totalDesagio = totalTela - totalResgate;
                const totalDesagioPercent = totalTela > 0 ? totalDesagio / totalTela : 0;
                return { totalTela, totalResgate, totalDesagio, totalDesagioPercent };
            }, [redemptions, quotations]);

            return (
                <div className="h-full overflow-y-auto">
                    <div className="bg-slate-800 rounded-xl shadow-lg overflow-hidden">
                        <table className="w-full text-left">
                            <thead className="border-b border-slate-700">
                                <tr>
                                    <th className="p-3 text-sm font-semibold text-slate-300">Ativo</th>
                                    <th className="p-3 text-sm font-semibold text-slate-300 text-right">Valor de Tela</th>
                                    <th className="p-3 text-sm font-semibold text-slate-300 text-right">Valor de Resgate</th>
                                    <th className="p-3 text-sm font-semibold text-slate-300 text-right">Deságio (R$)</th>
                                    <th className="p-3 text-sm font-semibold text-slate-300 text-right">Deságio (%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {Object.values(redemptions).map(({ asset, amount }, index) => {
                                    const assetId = `${asset.Instituição}-${asset["Número da Conta"] || ''}-${asset.Nome}-${asset.Valor}`;
                                    const valorTela = amount;
                                    const valorResgate = quotations[assetId] || 0;
                                    const desagioValor = valorTela - valorResgate;
                                    const desagioPercent = valorTela > 0 ? (desagioValor / valorTela) : 0;
                                    return (
                                        <tr key={assetId} className="border-b border-slate-700 last:border-b-0 text-sm">
                                            <td className="p-3 font-medium text-white">{asset.Nome}<p className="text-xs text-slate-400">{asset.Instituição}</p></td>
                                            <td className="p-3 text-slate-300 text-right">{formatCurrency(valorTela)}</td>
                                            <td className="p-3 text-slate-300 text-right">{formatCurrency(valorResgate)}</td>
                                            <td className="p-3 text-red-400 text-right">{formatCurrency(desagioValor)}</td>
                                            <td className="p-3 text-red-400 text-right">{formatPercent(desagioPercent)}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                            <tfoot className="border-t-2 border-slate-600 bg-slate-900/50">
                                <tr className="font-bold text-base">
                                    <td className="p-3 text-white">TOTAIS</td>
                                    <td className="p-3 text-slate-200 text-right">{formatCurrency(totals.totalTela)}</td>
                                    <td className="p-3 text-slate-200 text-right">{formatCurrency(totals.totalResgate)}</td>
                                    <td className="p-3 text-red-300 text-right">{formatCurrency(totals.totalDesagio)}</td>
                                    <td className="p-3 text-red-300 text-right">{formatPercent(totals.totalDesagioPercent)}</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            );
        };
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>

